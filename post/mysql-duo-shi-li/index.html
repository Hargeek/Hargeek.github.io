<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>mysql多实例 | 山山仙人博客</title>
<meta name="description" content="">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/5.7.2/css/all.css">
<link rel="shortcut icon" href="https://www.ssgeek.com/favicon.ico?v=1731253219947">
<link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://www.ssgeek.com/styles/main.css">


  
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/gitalk/1.6.2/gitalk.css" />
  

  


<script src="https://cdn.bootcdn.net/ajax/libs/vue/2.6.11/vue.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
<script data-ad-client="ca-pub-6775328896166270" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?4b826a92a3dc151a74693fa1942d3167";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

<link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/aos/2.3.4/aos.css" />


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-147397031-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-147397031-1');
</script>


  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://www.ssgeek.com">
        <img src="https://www.ssgeek.com/images/avatar.png?v=1731253219947" class="site-logo">
        <h1 class="site-title">山山仙人博客</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="https://www.ssgeek.com" class="site-nav">
            首页
          </a>
        
      
        
          <a href="https://www.ssgeek.com/archives" class="site-nav">
            归档
          </a>
        
      
        
          <a href="https://www.ssgeek.com/tags" class="site-nav">
            标签
          </a>
        
      
        
          <a href="https://www.ssgeek.com/post/about/" class="site-nav">
            关于
          </a>
        
      
        
          <a href="https://www.ssgeek.com/post/gong-zhong-hao/" class="site-nav">
            公众号
          </a>
        
      
        
          <a href="https://www.ssgeek.com/post/you-qing-lian-jie/" class="site-nav">
            友情链接
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
          <a class="social-link" href="https://github.com/hargeek" target="_blank">
            <i class="fab fa-github"></i>
          </a>
        
      
        
          <a class="social-link" href="https://twitter.com/anronghong" target="_blank">
            <i class="fab fa-twitter"></i>
          </a>
        
      
        
          <a class="social-link" href="https://weibo.com/u/5717964658" target="_blank">
            <i class="fab fa-weibo"></i>
          </a>
        
      
        
          <a class="social-link" href="https://www.zhihu.com/people/hong-an-rong-46/activities" target="_blank">
            <i class="fab fa-zhihu"></i>
          </a>
        
      
        
          <a class="social-link" href="https://www.facebook.com/profile.php?id=100041470532098" target="_blank">
            <i class="fab fa-facebook"></i>
          </a>
        
      
    </div>
    <div class="site-description">
      
    </div>
    <div class="site-footer">
      <a href="https://beian.miit.gov.cn" style="text-decoration:none;">鄂ICP备18007156号-1</a></br></br>Copyright © All Rights Reserved | <a class="rss" href="https://www.ssgeek.com/atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>

      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">mysql多实例</h2>
            <div class="post-date">2019-04-19</div>
            
            <div class="post-content">
              <p><ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#1-%E4%BB%80%E4%B9%88%E6%98%AFmysql%E5%A4%9A%E5%AE%9E%E4%BE%8B">1、什么是mysql多实例</a></li>
<li><a href="#2-mysql%E5%A4%9A%E5%AE%9E%E4%BE%8B%E7%9A%84%E7%89%B9%E7%82%B9">2、mysql多实例的特点</a></li>
<li><a href="#3-%E9%83%A8%E7%BD%B2mysql%E5%A4%9A%E5%AE%9E%E4%BE%8B">3、部署mysql多实例</a>
<ul>
<li><a href="#31-%E9%83%A8%E7%BD%B2mysql%E5%A4%9A%E5%AE%9E%E4%BE%8B%E7%9A%84%E4%B8%A4%E7%A7%8D%E6%96%B9%E5%BC%8F">3.1、部署mysql多实例的两种方式</a></li>
<li><a href="#32-mysqld_multi%E9%85%8D%E7%BD%AEmysql%E5%A4%9A%E5%AE%9E%E4%BE%8B">3.2、mysqld_multi配置mysql多实例</a>
<ul>
<li><a href="#321-%E5%88%9D%E5%A7%8B%E5%8C%96%E6%95%B0%E6%8D%AE%E7%9B%AE%E5%BD%95">3.2.1、初始化数据目录</a></li>
<li><a href="#322-%E9%85%8D%E7%BD%AE%E5%A4%9A%E5%AE%9E%E4%BE%8B%E5%90%AF%E5%8A%A8%E8%84%9A%E6%9C%AC">3.2.2、配置多实例启动脚本</a></li>
<li><a href="#323-%E9%85%8D%E7%BD%AE%E5%A4%9A%E5%AE%9E%E4%BE%8B%E6%95%B0%E6%8D%AE%E5%BA%93%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">3.2.3、配置多实例数据库配置文件</a></li>
<li><a href="#324-%E5%90%AF%E5%8A%A8%E5%A4%9A%E5%AE%9E%E4%BE%8B%E6%95%B0%E6%8D%AE%E5%BA%93">3.2.4、启动多实例数据库</a></li>
<li><a href="#325-%E7%99%BB%E5%BD%95%E7%9B%B8%E5%BA%94%E6%95%B0%E6%8D%AE%E5%BA%93">3.2.5、登录相应数据库</a></li>
</ul>
</li>
<li><a href="#33-%E5%A4%9A%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%AE%9E%E7%8E%B0mysql%E5%A4%9A%E5%AE%9E%E4%BE%8B">3.3、多配置文件实现MySQL多实例</a>
<ul>
<li><a href="#331-%E5%88%9B%E5%BB%BA%E7%9B%AE%E5%BD%95%E5%92%8C%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">3.3.1、创建目录和配置文件</a></li>
<li><a href="#332-%E5%88%9B%E5%BB%BA%E5%90%AF%E5%8A%A8%E8%84%9A%E6%9C%AC">3.3.2、创建启动脚本</a></li>
<li><a href="#333-%E5%A2%9E%E5%8A%A03307%E5%AE%9E%E4%BE%8B">3.3.3、增加3307实例</a></li>
<li><a href="#334-%E4%BF%AE%E6%94%B9%E6%9D%83%E9%99%90">3.3.4、修改权限</a></li>
<li><a href="#335-%E5%88%9D%E5%A7%8B%E5%8C%96">3.3.5、初始化</a></li>
<li><a href="#336-%E5%90%AF%E5%8A%A8">3.3.6、启动</a></li>
<li><a href="#337-%E5%88%9D%E5%A7%8B%E5%8C%96%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95">3.3.7、初始化密码登录</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</p>
<h2 id="1-什么是mysql多实例">1、什么是mysql多实例</h2>
<blockquote>
<p>mysql多实例就是在一台机器上开启多个不同的服务端口（如：3306,3307），运行多个MySQL服务进程，通过不同的socket监听不同的服务端口来提供各自的服务</p>
</blockquote>
<h2 id="2-mysql多实例的特点">2、mysql多实例的特点</h2>
<ul>
<li>有效利用服务器资源，当单个服务器资源有剩余时，可以充分利用剩余的资源提供更多的服务</li>
<li>节约服务器资源</li>
<li>资源互相抢占问题，当某个服务实例服务并发很高时或者开启慢查询时，会消耗更多的内存、CPU、磁盘IO资源，导致服务器上的其他实例提供服务的质量下降</li>
</ul>
<h2 id="3-部署mysql多实例">3、部署mysql多实例</h2>
<h3 id="31-部署mysql多实例的两种方式">3.1、部署mysql多实例的两种方式</h3>
<ul>
<li>第一种是使用多个配置文件启动不同的进程来实现多实例，这种方式的优势逻辑简单，配置简单，缺点是管理起来不太方便</li>
<li>第二种是通过官方自带的mysqld_multi使用单独的配置文件来实现多实例，这种方式定制每个实例的配置不太方面，优点是管理起来很方便，集中管理</li>
</ul>
<p>同一开发环境下安装两个数据库，必须处理以下问题：<br>
配置文件安装路径不能相同<br>
数据库目录不能相同<br>
启动脚本不能同名<br>
端口不能相同<br>
socket文件的生成路径不能相同</p>
<h3 id="32-mysqld_multi配置mysql多实例">3.2、mysqld_multi配置mysql多实例</h3>
<p>在进行此操作前已经编译安装好了mysql，安装位置在<code>/application/mysql/</code>下</p>
<h4 id="321-初始化数据目录">3.2.1、初始化数据目录</h4>
<pre><code>mkdir /usr/local/var -p
/application/mysql/scripts/mysql_install_db --basedir=/application/mysql/ --datadir=/usr/local/var/mysql1 --user=mysql
/application/mysql/scripts/mysql_install_db --basedir=/application/mysql/ --datadir=/usr/local/var/mysql2 --user=mysql
/application/mysql/scripts/mysql_install_db --basedir=/application/mysql/ --datadir=/usr/local/var/mysql3 --user=mysql
/application/mysql/scripts/mysql_install_db --basedir=/application/mysql/ --datadir=/usr/local/var/mysql4 --user=mysql
</code></pre>
<p>修改授权</p>
<pre><code>chown -R mysql.mysql /usr/local/var/mysql*
</code></pre>
<h4 id="322-配置多实例启动脚本">3.2.2、配置多实例启动脚本</h4>
<pre><code>cp /application/mysql/support-files/mysqld_multi.server /etc/init.d/
#修改basedir和bindir为安装路径
basedir=/application/mysql
bindir=/application/mysql/bin
</code></pre>
<h4 id="323-配置多实例数据库配置文件">3.2.3、配置多实例数据库配置文件</h4>
<p>在<code>/etc/</code>目录下创建创建文件<code>/etc/mysqld_multi.cnf</code>，内容如下</p>
<pre><code>[mysqld_multi]
mysqld     = /application/mysql/bin/mysqld_safe
mysqladmin = /application/mysql/bin/mysqladmin
#user       = mysql
#password   = my_password

[mysqld1]
socket     = /usr/local/var/mysql1/mysql1.sock
port       = 3306
pid-file   = /usr/local/var/mysql1/mysql1.pid
datadir    = /usr/local/var/mysql1
#language   = /usr/local/mysql/share/mysql/english
user       = mysql

[mysqld2]
socket     = /usr/local/var/mysql2/mysql2.sock
port       = 3307
pid-file   = /usr/local/var/mysql2/mysql2.pid
datadir    = /usr/local/var/mysql2
#language   = /usr/local/mysql/share/mysql/english
user       = mysql

[mysqld3]
socket     = /usr/local/var/mysql3/mysql3.sock
port       = 3308
pid-file   = /usr/local/var/mysql3/mysql3.pid
datadir    = /usr/local/var/mysql3
#language   = /usr/local/mysql/share/mysql/english
user       = mysql

[mysqld4]
socket     = /usr/local/var/mysql4/mysql4.sock
port       = 3309
pid-file   = /usr/local/var/mysql4/mysql4.pid
datadir    = /usr/local/var/mysql4
#language   = /usr/local/mysql/share/mysql/english
user       = mysql
</code></pre>
<h4 id="324-启动多实例数据库">3.2.4、启动多实例数据库</h4>
<pre><code>mysqld_multi --defaults-extra-file=/etc/mysqld_multi.cnf start
</code></pre>
<p>启动或停止具体某一个实例可在start、stop后面加上具体数据1,2,3等<br>
<code>mysqld_multi</code>进行多实例管理<br>
启动全部实例：</p>
<pre><code>/usr/local/mysql/bin/mysqld_multi --defaults-extra-file=/etc/mysqld_multi.cnf start
</code></pre>
<p>查看全部实例状态：</p>
<pre><code>/usr/local/mysql/bin/mysqld_multi report 
</code></pre>
<p>启动单个实例：</p>
<pre><code>/usr/local/mysql/bin/mysqld_multi --defaults-extra-file=/etc/mysqld_multi.cnf start 3306 
</code></pre>
<p>停止单个实例：</p>
<pre><code>/usr/local/mysql/bin/mysqld_multi --defaults-extra-file=/etc/mysqld_multi.cnf stop 3306 
</code></pre>
<p>查看单个实例状态：</p>
<pre><code>/usr/local/mysql/bin/mysqld_multi --defaults-extra-file=/etc/mysqld_multi.cnf report 3306
</code></pre>
<p>检查</p>
<pre><code>[root@db02 ~]# netstat -lntup
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address               Foreign Address             State       PID/Program name   
tcp        0      0 0.0.0.0:3306                0.0.0.0:*                   LISTEN      5016/mysqld         
tcp        0      0 0.0.0.0:3307                0.0.0.0:*                   LISTEN      5026/mysqld         
tcp        0      0 0.0.0.0:3308                0.0.0.0:*                   LISTEN      5036/mysqld         
tcp        0      0 0.0.0.0:3309                0.0.0.0:*                   LISTEN      5042/mysqld         
tcp        0      0 0.0.0.0:22                  0.0.0.0:*                   LISTEN      1317/sshd           
tcp        0      0 :::22                       :::*                        LISTEN      1317/sshd    
</code></pre>
<h4 id="325-登录相应数据库">3.2.5、登录相应数据库</h4>
<p>进入端口为3306的数据库</p>
<pre><code>mysql -uroot -p -h127.0.0.1 -P3306  ####密码为空
</code></pre>
<p>或者</p>
<pre><code>mysql -S /usr/local/var/mysql1/mysql1.sock
</code></pre>
<h3 id="33-多配置文件实现mysql多实例">3.3、多配置文件实现MySQL多实例</h3>
<p>在进行此操作前已经编译安装好了mysql，安装位置在<code>/application/mysql/</code>下</p>
<h4 id="331-创建目录和配置文件">3.3.1、创建目录和配置文件</h4>
<pre><code>mkdir -p /data/{3306,3307}/data
vim /data/3306/my.cnf
[client]
port = 3306
socket = /data/3306/mysql.sock

[mysql]
no-auto-rehash

[mysqld]
user = mysql
port = 3306
socket = /data/3306/mysql.sock
basedir = /application/mysql
datadir = /data/3306/data
pid-file = /data/3306/mysql.pid
log-bin = /data/3306/mysql-bin
relay-log = /data/3306/relay-bin
relay-log-info-file = /data/3306/relay-log.info
server-id = 1

[mysqld_safe]
log-error=/data/3306/mysql_3306.err
pid-file=/data/3306/mysqld.pid
</code></pre>
<h4 id="332-创建启动脚本">3.3.2、创建启动脚本</h4>
<pre><code>vim /data/3306/mysql
#!/bin/sh

#init
port=3306
CmdPath=&quot;/application/mysql/bin&quot;
mysql_sock=&quot;/data/${port}/mysql.sock&quot;
#startup function
function_start_mysql()
{
    if [ ! -e &quot;$mysql_sock&quot; ];then
      printf &quot;Starting MySQL...\n&quot;
      /bin/sh ${CmdPath}/mysqld_safe --defaults-file=/data/${port}/my.cnf 2&gt;&amp;1 &gt; /dev/null &amp;
    else
      printf &quot;MySQL is running...\n&quot;
      exit
    fi
}

#stop function
function_stop_mysql()
{
    if [ ! -e &quot;$mysql_sock&quot; ];then
       printf &quot;MySQL is stopped...\n&quot;
       exit
    else
       printf &quot;Stoping MySQL...\n&quot;
       ${CmdPath}/mysqladmin -u ${mysql_user} -p${mysql_pwd} -S /data/${port}/mysql.sock shutdown
   fi
}

#restart function
function_restart_mysql()
{
    printf &quot;Restarting MySQL...\n&quot;
    function_stop_mysql
    sleep 2
    function_start_mysql
}

case $1 in
start)
    function_start_mysql
;;
stop)
    function_stop_mysql
;;
restart)
    function_restart_mysql
;;
*)
    printf &quot;Usage: /data/${port}/mysql {start|stop|restart}\n&quot;
esac
</code></pre>
<h4 id="333-增加3307实例">3.3.3、增加3307实例</h4>
<pre><code>sed 's#3306#3307#g;s#server-id = 1#server-id = 3#g' /data/3306/my.cnf &gt;/data/3307/my.cnf
sed 's#3306#3307#g' /data/3306/mysql &gt;/data/3307/mysql
</code></pre>
<h4 id="334-修改权限">3.3.4、修改权限</h4>
<pre><code>chown -R mysql.mysql /data
chmod +x /data/{3306,3307}/mysql
</code></pre>
<h4 id="335-初始化">3.3.5、初始化</h4>
<pre><code>/application/mysql/scripts/mysql_install_db --user=mysql --basedir=/application/mysql --datadir=/data/3306/data
/application/mysql/scripts/mysql_install_db --user=mysql --basedir=/application/mysql --datadir=/data/3307/data
</code></pre>
<h4 id="336-启动">3.3.6、启动</h4>
<pre><code>/data/3306/mysql start
/data/3307/mysql start
</code></pre>
<p>启动的时候报错</p>
<pre><code>[root@db01 ~]# 180707 16:30:54 mysqld_safe error: log-error set to '/data/3306/mysql_3306.err', however file don't exists. Create writable for user 'mysql'.
</code></pre>
<p>手动创建文件并授权，再次启动成功</p>
<pre><code>touch /data/3306/mysql_3306.err
chown mysql:mysql /data/3306/mysql_3306.err
</code></pre>
<p>检查</p>
<pre><code>[root@db01 ~]# netstat -lntup|grep mysql
tcp6       0      0 :::3306                 :::*                    LISTEN      2023/mysqld         
tcp6       0      0 :::3307                 :::*                    LISTEN      2505/mysqld
</code></pre>
<h4 id="337-初始化密码登录">3.3.7、初始化密码登录</h4>
<pre><code>mysqladmin -uroot -S /data/3306/mysql.sock password '123456'
mysqladmin -uroot -S /data/3307/mysql.sock password '123456'
</code></pre>
<p>参考来源：<br>
https://www.cnblogs.com/xuchenliang/p/6843990.html<br>
https://blog.csdn.net/clevercode/article/details/47610619<br>
https://blog.csdn.net/clevercode/article/details/47659457</p>

            </div>
            
              <div class="tag-container">
                
                  <a href="https://www.ssgeek.com/tag/M29o-BG-i" class="tag">
                    mysql
                  </a>
                
                  <a href="https://www.ssgeek.com/tag/database" class="tag">
                    数据库
                  </a>
                
              </div>
            
            
              <div class="next-post">
                <div class="next">下一篇</div>
                <a href="https://www.ssgeek.com/post/http-xiang-ying-dai-ma">
                  <h3 class="post-title">
                    HTTP响应代码
                  </h3>
                </a>
              </div>
            

            
              
                <div id="gitalk-container" data-aos="fade-in"></div>
              

              
            

          </div>

        </div>
      </div>
    </div>

    <script src="https://cdn.bootcdn.net/ajax/libs/aos/2.3.4/aos.js"></script>

<script type="application/javascript">

AOS.init();

hljs.initHighlightingOnLoad()

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>



  
    <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
    <script>

      var gitalk = new Gitalk({
        clientID: '22c870a7f8551b566598',
        clientSecret: '1acfdedd403cdf39c4a6ce932a4a991bb2b32e3a',
        repo: 'hargeek.github.io',
        owner: 'hargeek',
        admin: ['hargeek'],
        id: (location.pathname).substring(0, 49),      // Ensure uniqueness and length less than 50
        distractionFreeMode: false  // Facebook-like distraction free mode
      })

      gitalk.render('gitalk-container')

    </script>
  

  


  </body>
</html>
