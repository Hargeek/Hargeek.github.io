<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>数据库中间件Mycat的安装使用 | 山山仙人博客</title>
<meta name="description" content="">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/5.7.2/css/all.css">
<link rel="shortcut icon" href="https://www.ssgeek.com/favicon.ico?v=1714317474949">
<link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://www.ssgeek.com/styles/main.css">


  
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/gitalk/1.6.2/gitalk.css" />
  

  


<script src="https://cdn.bootcdn.net/ajax/libs/vue/2.6.11/vue.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
<script data-ad-client="ca-pub-6775328896166270" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?4b826a92a3dc151a74693fa1942d3167";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

<link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/aos/2.3.4/aos.css" />


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-147397031-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-147397031-1');
</script>


  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://www.ssgeek.com">
        <img src="https://www.ssgeek.com/images/avatar.png?v=1714317474949" class="site-logo">
        <h1 class="site-title">山山仙人博客</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="https://www.ssgeek.com" class="site-nav">
            首页
          </a>
        
      
        
          <a href="https://www.ssgeek.com/archives" class="site-nav">
            归档
          </a>
        
      
        
          <a href="https://www.ssgeek.com/tags" class="site-nav">
            标签
          </a>
        
      
        
          <a href="https://www.ssgeek.com/post/about/" class="site-nav">
            关于
          </a>
        
      
        
          <a href="https://www.ssgeek.com/post/gong-zhong-hao/" class="site-nav">
            公众号
          </a>
        
      
        
          <a href="https://www.ssgeek.com/post/you-qing-lian-jie/" class="site-nav">
            友情链接
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
          <a class="social-link" href="https://github.com/hargeek" target="_blank">
            <i class="fab fa-github"></i>
          </a>
        
      
        
          <a class="social-link" href="https://twitter.com/anronghong" target="_blank">
            <i class="fab fa-twitter"></i>
          </a>
        
      
        
          <a class="social-link" href="https://weibo.com/u/5717964658" target="_blank">
            <i class="fab fa-weibo"></i>
          </a>
        
      
        
          <a class="social-link" href="https://www.zhihu.com/people/hong-an-rong-46/activities" target="_blank">
            <i class="fab fa-zhihu"></i>
          </a>
        
      
        
          <a class="social-link" href="https://www.facebook.com/profile.php?id=100041470532098" target="_blank">
            <i class="fab fa-facebook"></i>
          </a>
        
      
    </div>
    <div class="site-description">
      
    </div>
    <div class="site-footer">
      <a href="https://beian.miit.gov.cn" style="text-decoration:none;">鄂ICP备18007156号-1</a></br></br>Copyright © All Rights Reserved | <a class="rss" href="https://www.ssgeek.com/atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>

      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">数据库中间件Mycat的安装使用</h2>
            <div class="post-date">2021-07-01</div>
            
            <div class="post-content">
              <p><ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#1-%E4%BB%8B%E7%BB%8D">1、介绍</a></li>
<li><a href="#2-%E7%8E%AF%E5%A2%83%E6%9E%B6%E6%9E%84%E5%87%86%E5%A4%87">2、环境架构准备</a>
<ul>
<li><a href="#21-%E5%AE%89%E8%A3%85%E6%96%87%E4%BB%B6%E5%87%86%E5%A4%87">2.1 安装文件准备</a></li>
<li><a href="#22-%E5%88%9B%E5%BB%BA%E7%9B%B8%E5%85%B3%E7%9B%AE%E5%BD%95%E5%B9%B6%E5%88%9D%E5%A7%8B%E5%8C%96%E6%95%B0%E6%8D%AE">2.2 创建相关目录并初始化数据</a></li>
<li><a href="#23-%E5%87%86%E5%A4%87%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%92%8C%E5%90%AF%E5%8A%A8%E8%84%9A%E6%9C%AC">2.3 准备配置文件和启动脚本</a>
<ul>
<li><a href="#231-db04">2.3.1 db04</a></li>
<li><a href="#232-db05">2.3.2 db05</a></li>
</ul>
</li>
<li><a href="#24-%E5%90%AF%E5%8A%A8%E5%A4%9A%E5%AE%9E%E4%BE%8B">2.4 启动多实例</a></li>
<li><a href="#25-%E6%90%AD%E5%BB%BA%E4%B8%BB%E4%BB%8E%E7%8E%AF%E5%A2%83">2.5 搭建主从环境</a>
<ul>
<li><a href="#251-stard1">2.5.1 stard1</a></li>
<li><a href="#252-stard2">2.5.2 stard2</a></li>
</ul>
</li>
<li><a href="#26-%E6%A3%80%E6%B5%8B%E4%B8%BB%E4%BB%8E%E7%8A%B6%E6%80%81">2.6 检测主从状态</a></li>
</ul>
</li>
<li><a href="#3-%E5%AE%89%E8%A3%85mycat%E8%BD%AF%E4%BB%B6">3、安装MyCat软件</a></li>
<li><a href="#4-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%BB%8B%E7%BB%8D">4、配置文件介绍</a>
<ul>
<li><a href="#41-schemaxml-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">4.1 schema.xml 配置文件</a></li>
<li><a href="#42-schemaxml-%E9%83%A8%E5%88%86%E5%8F%82%E6%95%B0%E8%AF%B4%E6%98%8E">4.2 schema.xml 部分参数说明</a></li>
</ul>
</li>
<li><a href="#5-%E5%9E%82%E7%9B%B4%E5%88%86%E7%89%87%E5%BA%94%E7%94%A8">5、垂直分片应用</a>
<ul>
<li><a href="#51-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%87%86%E5%A4%87">5.1 配置文件准备</a></li>
<li><a href="#52-%E5%88%9B%E5%BB%BA%E6%B5%8B%E8%AF%95%E6%95%B0%E6%8D%AE%E5%BA%93">5.2 创建测试数据库</a></li>
<li><a href="#53-%E9%87%8D%E5%90%AFmycat%E5%B9%B6%E6%A3%80%E6%9F%A5%E9%80%BB%E8%BE%91%E5%BA%93">5.3 重启mycat并检查逻辑库</a></li>
<li><a href="#54-%E5%86%99%E5%85%A5%E6%B5%8B%E8%AF%95">5.4 写入测试</a></li>
</ul>
</li>
<li><a href="#6-%E6%B0%B4%E5%B9%B3%E5%88%86%E7%89%87%E5%BA%94%E7%94%A8">6、水平分片应用</a>
<ul>
<li><a href="#61-%E6%8B%86%E5%88%86%E6%A6%82%E5%BF%B5">6.1 拆分概念</a>
<ul>
<li><a href="#611-%E5%88%86%E7%89%87%E7%AD%96%E7%95%A5">6.1.1 分片策略</a></li>
<li><a href="#612-%E5%88%86%E7%89%87%E9%94%AE">6.1.2 分片键</a></li>
</ul>
</li>
<li><a href="#62-%E8%8C%83%E5%9B%B4%E5%88%86%E7%89%87">6.2 范围分片</a>
<ul>
<li><a href="#621-%E8%AF%95%E7%94%A8%E7%8E%AF%E5%A2%83">6.2.1 试用环境</a></li>
<li><a href="#622-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%87%86%E5%A4%87">6.2.2 配置文件准备</a></li>
<li><a href="#623-%E5%88%9B%E5%BB%BA%E6%B5%8B%E8%AF%95%E8%A1%A8">6.2.3 创建测试表</a></li>
<li><a href="#624-%E9%87%8D%E5%90%AFmycat%E5%B9%B6%E6%A3%80%E6%9F%A5">6.2.4 重启mycat并检查</a></li>
<li><a href="#625-%E5%86%99%E5%85%A5%E6%B5%8B%E8%AF%95">6.2.5 写入测试</a></li>
</ul>
</li>
<li><a href="#63-%E5%8F%96%E6%A8%A1%E5%88%86%E7%89%87">6.3 取模分片</a>
<ul>
<li><a href="#631-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%87%86%E5%A4%87">6.3.1 配置文件准备</a></li>
<li><a href="#632-%E5%87%86%E5%A4%87%E6%B5%8B%E8%AF%95%E8%A1%A8">6.3.2 准备测试表</a></li>
<li><a href="#633-%E9%87%8D%E5%90%AFmycat">6.3.3 重启mycat</a></li>
<li><a href="#634-%E5%86%99%E5%85%A5%E6%B5%8B%E8%AF%95">6.3.4 写入测试</a></li>
</ul>
</li>
<li><a href="#64-%E6%9E%9A%E4%B8%BE%E5%88%86%E7%89%87">6.4 枚举分片</a>
<ul>
<li><a href="#641-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%87%86%E5%A4%87">6.4.1 配置文件准备</a></li>
</ul>
</li>
<li><a href="#65-mycat%E5%85%A8%E5%B1%80%E8%A1%A8">6.5 Mycat全局表</a>
<ul>
<li><a href="#651-%E9%85%8D%E7%BD%AE%E5%85%A8%E5%B1%80%E8%A1%A8">6.5.1 配置全局表</a></li>
</ul>
</li>
<li><a href="#66-e-r%E5%88%86%E7%89%87">6.6 E-R分片</a>
<ul>
<li><a href="#661-%E5%87%86%E5%A4%87%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">6.6.1 准备配置文件</a></li>
<li><a href="#662-%E5%87%86%E5%A4%87%E6%B5%8B%E8%AF%95%E8%A1%A8">6.6.2 准备测试表</a></li>
<li><a href="#663-%E9%87%8D%E5%90%AFmycat">6.6.3 重启mycat</a></li>
<li><a href="#664-%E5%86%99%E5%85%A5%E6%B5%8B%E8%AF%95">6.6.4 写入测试</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#7-mycat%E6%97%A5%E5%B8%B8%E7%AE%A1%E7%90%86">7、Mycat日常管理</a>
<ul>
<li><a href="#71-%E7%AE%A1%E7%90%86%E6%9C%8D%E5%8A%A1%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4">7.1 管理服务常用命令</a></li>
<li><a href="#72-%E4%BF%AE%E6%94%B9%E9%80%BB%E8%BE%91%E5%BA%93%E5%90%8D">7.2 修改逻辑库名</a></li>
<li><a href="#73-%E5%A2%9E%E5%8A%A0%E9%80%BB%E8%BE%91%E5%BA%93">7.3 增加逻辑库</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</p>
<figure data-type="image" tabindex="1"><img src="https://image.ssgeek.com/20210701-01.jpg" alt=""></figure>
<blockquote>
<p>作者：AshesCat</p>
</blockquote>
<h2 id="1-介绍">1、介绍</h2>
<p><code>MyCat</code>是一个开源的分布式数据库中间件，是一个实现了<code>MySQL</code>协议的服务器</p>
<p>前端：用户可以把它看作是一个数据库代理，用<code>MySQL</code>客户端工具和命令行访问</p>
<p>后端：可以用<code>MySQL</code>原生协议与多个<code>MySQL</code>服务器通信，也可以用<code>JDBC</code>协议与大多数主流数据库服务器通信，其核心功能是分表分库，即将一个大表水平分割为<code>N</code>个小表，存储在后端<code>MySQL</code>服务器里或者其他数据库里</p>
<p>简单来说：数据库是对底层存储文件的抽象，而<code>Mycat</code>是对数据库的抽象</p>
<h2 id="2-环境架构准备">2、环境架构准备</h2>
<p>两台虚拟机<code>db04</code>、<code>db05</code><br>
每台创建四个<code>mysql</code>实例：3307 3308 3309 3310</p>
<h3 id="21-安装文件准备">2.1 安装文件准备</h3>
<pre><code class="language-shell">cd /opt
wget https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-5.7.30-linux-glibc2.12-x86_64.tar.gz
tar xf mysql-5.7.30-linux-glibc2.12-x86_64.tar.gz
ln -s /opt/mysql-5.7.30-linux-glibc2.12-x86_64  /data/app/mysql
useradd -M -s /sbin/nologin mysql
chown -R mysql.mysql /data/*
</code></pre>
<h3 id="22-创建相关目录并初始化数据">2.2 创建相关目录并初始化数据</h3>
<pre><code class="language-shell">mkdir /data/33{07..10}/data -p
mysqld --initialize-insecure  --user=mysql --datadir=/data/3307/data --basedir=/data/app/mysql
mysqld --initialize-insecure  --user=mysql --datadir=/data/3308/data --basedir=/data/app/mysql
mysqld --initialize-insecure  --user=mysql --datadir=/data/3309/data --basedir=/data/app/mysql
mysqld --initialize-insecure  --user=mysql --datadir=/data/3310/data --basedir=/data/app/mysql
</code></pre>
<h3 id="23-准备配置文件和启动脚本">2.3 准备配置文件和启动脚本</h3>
<h4 id="231-db04">2.3.1 db04</h4>
<p>配置文件</p>
<pre><code class="language-shell">cat &gt;/data/3307/my.cnf&lt;&lt;EOF
[mysqld]
basedir=/data/app/mysql
datadir=/data/3307/data
socket=/data/3307/mysql.sock
port=3307
log-error=/data/3307/mysql.log
log_bin=/data/3307/mysql-bin
binlog_format=row
skip-name-resolve
server-id=7
gtid-mode=on
enforce-gtid-consistency=true
log-slave-updates=1
EOF

cat &gt;/data/3308/my.cnf&lt;&lt;EOF
[mysqld]
basedir=/data/app/mysql
datadir=/data/3308/data
port=3308
socket=/data/3308/mysql.sock
log-error=/data/3308/mysql.log
log_bin=/data/3308/mysql-bin
binlog_format=row
skip-name-resolve
server-id=8
gtid-mode=on
enforce-gtid-consistency=true
log-slave-updates=1
EOF

cat &gt;/data/3309/my.cnf&lt;&lt;EOF
[mysqld]
basedir=/data/app/mysql
datadir=/data/3309/data
socket=/data/3309/mysql.sock
port=3309
log-error=/data/3309/mysql.log
log_bin=/data/3309/mysql-bin
binlog_format=row
skip-name-resolve
server-id=9
gtid-mode=on
enforce-gtid-consistency=true
log-slave-updates=1
EOF

cat &gt;/data/3310/my.cnf&lt;&lt;EOF
[mysqld]
basedir=/data/app/mysql
datadir=/data/3310/data
socket=/data/3310/mysql.sock
port=3310
log-error=/data/3310/mysql.log
log_bin=/data/3310/mysql-bin
binlog_format=row
skip-name-resolve
server-id=10
gtid-mode=on
enforce-gtid-consistency=true
log-slave-updates=1
EOF
</code></pre>
<p>启动脚本</p>
<pre><code class="language-shell">cat &gt;/etc/systemd/system/mysqld3307.service&lt;&lt;EOF
[Unit]
Description=MySQL Server
Documentation=man:mysqld(8)
Documentation=http://dev.mysql.com/doc/refman/en/using-systemd.html
After=network.target
After=syslog.target
[Install]
WantedBy=multi-user.target
[Service]
User=mysql
Group=mysql
ExecStart=/data/app/mysql/bin/mysqld --defaults-file=/data/3307/my.cnf
LimitNOFILE = 5000
EOF

cat &gt;/etc/systemd/system/mysqld3308.service&lt;&lt;EOF
[Unit]
Description=MySQL Server
Documentation=man:mysqld(8)
Documentation=http://dev.mysql.com/doc/refman/en/using-systemd.html
After=network.target
After=syslog.target
[Install]
WantedBy=multi-user.target
[Service]
User=mysql
Group=mysql
ExecStart=/data/app/mysql/bin/mysqld --defaults-file=/data/3308/my.cnf
LimitNOFILE = 5000
EOF

cat &gt;/etc/systemd/system/mysqld3309.service&lt;&lt;EOF
[Unit]
Description=MySQL Server
Documentation=man:mysqld(8)
Documentation=http://dev.mysql.com/doc/refman/en/using-systemd.html
After=network.target
After=syslog.target
[Install]
WantedBy=multi-user.target
[Service]
User=mysql
Group=mysql
ExecStart=/data/app/mysql/bin/mysqld --defaults-file=/data/3309/my.cnf
LimitNOFILE = 5000
EOF

cat &gt;/etc/systemd/system/mysqld3310.service&lt;&lt;EOF
[Unit]
Description=MySQL Server
Documentation=man:mysqld(8)
Documentation=http://dev.mysql.com/doc/refman/en/using-systemd.html
After=network.target
After=syslog.target
[Install]
WantedBy=multi-user.target
[Service]
User=mysql
Group=mysql
ExecStart=/data/app/mysql/bin/mysqld --defaults-file=/data/3310/my.cnf
LimitNOFILE = 5000
EOF
</code></pre>
<h4 id="232-db05">2.3.2 db05</h4>
<p>配置文件</p>
<pre><code class="language-shell">cat &gt;/data/3307/my.cnf&lt;&lt;EOF
[mysqld]
basedir=/data/app/mysql
datadir=/data/3307/data
socket=/data/3307/mysql.sock
port=3307
log-error=/data/3307/mysql.log
log_bin=/data/3307/mysql-bin
binlog_format=row
skip-name-resolve
server-id=17
gtid-mode=on
enforce-gtid-consistency=true
log-slave-updates=1
EOF

cat &gt;/data/3308/my.cnf&lt;&lt;EOF
[mysqld]
basedir=/data/app/mysql
datadir=/data/3308/data
port=3308
socket=/data/3308/mysql.sock
log-error=/data/3308/mysql.log
log_bin=/data/3308/mysql-bin
binlog_format=row
skip-name-resolve
server-id=18
gtid-mode=on
enforce-gtid-consistency=true
log-slave-updates=1
EOF

cat &gt;/data/3309/my.cnf&lt;&lt;EOF
[mysqld]
basedir=/data/app/mysql
datadir=/data/3309/data
socket=/data/3309/mysql.sock
port=3309
log-error=/data/3309/mysql.log
log_bin=/data/3309/mysql-bin
binlog_format=row
skip-name-resolve
server-id=19
gtid-mode=on
enforce-gtid-consistency=true
log-slave-updates=1
EOF

cat &gt;/data/3310/my.cnf&lt;&lt;EOF
[mysqld]
basedir=/data/app/mysql
datadir=/data/3310/data
socket=/data/3310/mysql.sock
port=3310
log-error=/data/3310/mysql.log
log_bin=/data/3310/mysql-bin
binlog_format=row
skip-name-resolve
server-id=20
gtid-mode=on
enforce-gtid-consistency=true
log-slave-updates=1
EOF
</code></pre>
<p>启动脚本</p>
<pre><code class="language-shell">cat &gt;/etc/systemd/system/mysqld3307.service&lt;&lt;EOF
[Unit]
Description=MySQL Server
Documentation=man:mysqld(8)
Documentation=http://dev.mysql.com/doc/refman/en/using-systemd.html
After=network.target
After=syslog.target
[Install]
WantedBy=multi-user.target
[Service]
User=mysql
Group=mysql
ExecStart=/data/app/mysql/bin/mysqld --defaults-file=/data/3307/my.cnf
LimitNOFILE = 5000
EOF

cat &gt;/etc/systemd/system/mysqld3308.service&lt;&lt;EOF
[Unit]
Description=MySQL Server
Documentation=man:mysqld(8)
Documentation=http://dev.mysql.com/doc/refman/en/using-systemd.html
After=network.target
After=syslog.target
[Install]
WantedBy=multi-user.target
[Service]
User=mysql
Group=mysql
ExecStart=/data/app/mysql/bin/mysqld --defaults-file=/data/3308/my.cnf
LimitNOFILE = 5000
EOF

cat &gt;/etc/systemd/system/mysqld3309.service&lt;&lt;EOF
[Unit]
Description=MySQL Server
Documentation=man:mysqld(8)
Documentation=http://dev.mysql.com/doc/refman/en/using-systemd.html
After=network.target
After=syslog.target
[Install]
WantedBy=multi-user.target
[Service]
User=mysql
Group=mysql
ExecStart=/data/app/mysql/bin/mysqld --defaults-file=/data/3309/my.cnf
LimitNOFILE = 5000
EOF

cat &gt;/etc/systemd/system/mysqld3310.service&lt;&lt;EOF
[Unit]
Description=MySQL Server
Documentation=man:mysqld(8)
Documentation=http://dev.mysql.com/doc/refman/en/using-systemd.html
After=network.target
After=syslog.target
[Install]
WantedBy=multi-user.target
[Service]
User=mysql
Group=mysql
ExecStart=/data/app/mysql/bin/mysqld --defaults-file=/data/3310/my.cnf
LimitNOFILE = 5000
EOF
</code></pre>
<h3 id="24-启动多实例">2.4 启动多实例</h3>
<p>启动多实例</p>
<pre><code class="language-shell">systemctl start mysqld3307
systemctl start mysqld3308
systemctl start mysqld3309
systemctl start mysqld3310
</code></pre>
<p>测试服务状态</p>
<pre><code class="language-shell">[root@db4 opt]# mysql -S /data/3307/mysql.sock -e &quot;show variables like 'server_id'&quot;
ke 'server_id'&quot;+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| server_id     | 7     |
+---------------+-------+
[root@db4 opt]# mysql -S /data/3308/mysql.sock -e &quot;show variables like 'server_id'&quot;
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| server_id     | 8     |
+---------------+-------+
[root@db4 opt]# mysql -S /data/3309/mysql.sock -e &quot;show variables like 'server_id'&quot;
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| server_id     | 9     |
+---------------+-------+
[root@db4 opt]# mysql -S /data/3310/mysql.sock -e &quot;show variables like 'server_id'&quot;
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| server_id     | 10    |
+---------------+-------+
</code></pre>
<pre><code class="language-shell">[root@db5 ~]# mysql -S /data/3307/mysql.sock -e &quot;show variables like 'server_id'&quot;
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| server_id     | 17    |
+---------------+-------+
[root@db5 ~]# mysql -S /data/3308/mysql.sock -e &quot;show variables like 'server_id'&quot;
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| server_id     | 18    |
+---------------+-------+
[root@db5 ~]# mysql -S /data/3309/mysql.sock -e &quot;show variables like 'server_id'&quot;
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| server_id     | 19    |
+---------------+-------+
[root@db5 ~]# mysql -S /data/3310/mysql.sock -e &quot;show variables like 'server_id'&quot;
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| server_id     | 20    |
+---------------+-------+
</code></pre>
<h3 id="25-搭建主从环境">2.5 搭建主从环境</h3>
<p>按照架构图进行搭建主从环境</p>
<h4 id="251-stard1">2.5.1 stard1</h4>
<p>192.168.10.54:3307 &lt;---&gt; 192.168.10.55:3307 双主搭建</p>
<pre><code class="language-shell"># db05
mysql  -S /data/3307/mysql.sock -e &quot;grant replication slave on *.* to repl@'192.168.10.%' identified by '123';&quot;
mysql  -S /data/3307/mysql.sock -e &quot;grant all  on *.* to root@'192.168.10.%' identified by '123'  with grant option;&quot;
# db04 
mysql  -S /data/3307/mysql.sock -e &quot;CHANGE MASTER TO MASTER_HOST='192.168.10.55', MASTER_PORT=3307, MASTER_AUTO_POSITION=1, MASTER_USER='repl', MASTER_PASSWORD='123';&quot;
mysql  -S /data/3307/mysql.sock -e &quot;start slave;&quot;
mysql  -S /data/3307/mysql.sock -e &quot;show slave status\G&quot;
# db05
mysql  -S /data/3307/mysql.sock -e &quot;CHANGE MASTER TO MASTER_HOST='192.168.10.54', MASTER_PORT=3307, MASTER_AUTO_POSITION=1, MASTER_USER='repl', MASTER_PASSWORD='123';&quot;
mysql  -S /data/3307/mysql.sock -e &quot;start slave;&quot;
mysql  -S /data/3307/mysql.sock -e &quot;show slave status\G&quot;
</code></pre>
<p>192.168.10.54:3309 ---&gt; 192.168.10.54:3307 主从搭建</p>
<pre><code class="language-shell"># db04
mysql  -S /data/3309/mysql.sock  -e &quot;CHANGE MASTER TO MASTER_HOST='192.168.10.54', MASTER_PORT=3307, MASTER_AUTO_POSITION=1, MASTER_USER='repl', MASTER_PASSWORD='123';&quot;
mysql  -S /data/3309/mysql.sock  -e &quot;start slave;&quot;
mysql  -S /data/3309/mysql.sock  -e &quot;show slave status\G&quot;
</code></pre>
<p>192.168.10.55:3309 ---&gt; 192.168.10.55:3307 主从搭建</p>
<pre><code class="language-shell"># db05
mysql  -S /data/3309/mysql.sock -e &quot;CHANGE MASTER TO MASTER_HOST='192.168.10.55', MASTER_PORT=3307, MASTER_AUTO_POSITION=1, MASTER_USER='repl', MASTER_PASSWORD='123';&quot;
mysql  -S /data/3309/mysql.sock -e &quot;start slave;&quot;
mysql  -S /data/3309/mysql.sock -e &quot;show slave status\G&quot;
</code></pre>
<h4 id="252-stard2">2.5.2 stard2</h4>
<p>192.168.10.55:3308 &lt;---&gt; 192.168.10.54:3308 双主搭建</p>
<pre><code class="language-shell"># db04
mysql  -S /data/3308/mysql.sock -e &quot;grant replication slave on *.* to repl@'192.168.10.%' identified by '123';&quot;
mysql  -S /data/3308/mysql.sock -e &quot;grant all  on *.* to root@'192.168.10.%' identified by '123'  with grant option;&quot;
# db05
mysql  -S /data/3308/mysql.sock -e &quot;CHANGE MASTER TO MASTER_HOST='192.168.10.54', MASTER_PORT=3308, MASTER_AUTO_POSITION=1, MASTER_USER='repl', MASTER_PASSWORD='123';&quot;
mysql  -S /data/3308/mysql.sock -e &quot;start slave;&quot;
mysql  -S /data/3308/mysql.sock -e &quot;show slave status\G&quot;
# db04
mysql  -S /data/3308/mysql.sock -e &quot;CHANGE MASTER TO MASTER_HOST='192.168.10.55', MASTER_PORT=3308, MASTER_AUTO_POSITION=1, MASTER_USER='repl', MASTER_PASSWORD='123';&quot;
mysql  -S /data/3308/mysql.sock -e &quot;start slave;&quot;
mysql  -S /data/3308/mysql.sock -e &quot;show slave status\G&quot;
</code></pre>
<p>192.168.10.55:3310 ---&gt; 192.168.10.55:3308 主从搭建</p>
<pre><code class="language-shell"># db05
mysql  -S /data/3310/mysql.sock -e &quot;CHANGE MASTER TO MASTER_HOST='192.168.10.55', MASTER_PORT=3308, MASTER_AUTO_POSITION=1, MASTER_USER='repl', MASTER_PASSWORD='123';&quot;
mysql  -S /data/3310/mysql.sock -e &quot;start slave;&quot;
mysql  -S /data/3310/mysql.sock -e &quot;show slave status\G&quot;
</code></pre>
<p>192.168.10.54:3310 ---&gt; 192.168.10.54:3308 主从搭建</p>
<pre><code class="language-shell"># db04
mysql  -S /data/3310/mysql.sock -e &quot;CHANGE MASTER TO MASTER_HOST='192.168.10.54', MASTER_PORT=3308, MASTER_AUTO_POSITION=1, MASTER_USER='repl', MASTER_PASSWORD='123';&quot;
mysql  -S /data/3310/mysql.sock -e &quot;start slave;&quot;
mysql  -S /data/3310/mysql.sock -e &quot;show slave status\G&quot;
</code></pre>
<h3 id="26-检测主从状态">2.6 检测主从状态</h3>
<p>db04</p>
<pre><code class="language-shell">[root@db4 ~]# mysql -S /data/3307/mysql.sock -e &quot;show slave status\G&quot;|grep Yes
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
[root@db4 ~]# mysql -S /data/3308/mysql.sock -e &quot;show slave status\G&quot;|grep Yes
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
[root@db4 ~]# mysql -S /data/3309/mysql.sock -e &quot;show slave status\G&quot;|grep Yes
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
[root@db4 ~]# mysql -S /data/3310/mysql.sock -e &quot;show slave status\G&quot;|grep Yes
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
</code></pre>
<p>db05</p>
<pre><code class="language-shell">[root@db5 ~]# mysql -S /data/3307/mysql.sock -e &quot;show slave status\G&quot;|grep Yes
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
[root@db5 ~]# mysql -S /data/3308/mysql.sock -e &quot;show slave status\G&quot;|grep Yes
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
[root@db5 ~]# mysql -S /data/3309/mysql.sock -e &quot;show slave status\G&quot;|grep Yes
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
[root@db5 ~]# mysql -S /data/3310/mysql.sock -e &quot;show slave status\G&quot;|grep Yes
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
</code></pre>
<h2 id="3-安装mycat软件">3、安装MyCat软件</h2>
<p>下载地址：http://dl.mycat.org.cn/<br>
安装java环境</p>
<pre><code class="language-shell">[root@localhost opt]# yum install java -y
</code></pre>
<p>下载mycat软件</p>
<pre><code class="language-shell">[root@localhost opt]# wget http://dl.mycat.org.cn/1.6.7.6/20210303094759/Mycat-server-1.6.7.6-release-20210303094759-linux.tar.gz
</code></pre>
<p>解压安装，加入环境变量</p>
<pre><code class="language-shell">[root@localhost opt]# tar xf Mycat-server-1.6.7.6-release-20210303094759-linux.tar.gz 
[root@localhost /]# vim /etc/profile
export PATH=/opt/mycat/bin:/usr/local/mysql/bin:$PATH
[root@localhost /]# source /etc/profile
</code></pre>
<p>启动mycat</p>
<pre><code class="language-shell">[root@localhost /]# mycat start 
Starting Mycat-server...
[root@localhost /]# 
</code></pre>
<p>连接mycat</p>
<pre><code class="language-mysql">[root@localhost /]# mysql -uroot -p123456 -h127.0.0.1 -P8066
mysql: [Warning] Using a password on the command line interface can be insecure.
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 2
Server version: 5.6.29-mycat-1.6.7.6-release-20210303094759 MyCat Server (OpenCloudDB)

Copyright (c) 2000, 2020, Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql&gt; show databases;
+----------+
| DATABASE |
+----------+
| TESTDB   |
+----------+
1 row in set (0.00 sec)

mysql&gt; 
</code></pre>
<h2 id="4-配置文件介绍">4、配置文件介绍</h2>
<pre><code class="language-shell"># conf目录
autopartition-long.txt       # 分片配置信息
auto-sharding-long.txt       # 分片配置信息
auto-sharding-rang-mod.txt   # 分片配置信息
rule.xml                     # 分片策略的定义和使用方法
schema.xml                   # 主配置文件，节点、分片、高可用、读写分离
server.xml                   # Mycat服务配置文件

# log目录
mycat.log   # 系统日志
wrapper.log # 启动日志
</code></pre>
<h3 id="41-schemaxml-配置文件">4.1 schema.xml 配置文件</h3>
<pre><code class="language-xml">[root@localhost ~]# vim /opt/mycat/conf/schema.xml
&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;!DOCTYPE mycat:schema SYSTEM &quot;schema.dtd&quot;&gt;
# 逻辑库内容
&lt;mycat:schema xmlns:mycat=&quot;http://io.mycat/&quot;&gt;
&lt;schema name=&quot;TESTDB&quot; checkSQLschema=&quot;false&quot; sqlMaxLimit=&quot;100&quot; dataNode=&quot;sh1&quot;&gt;
        &lt;table name=&quot;city&quot; dataNode=&quot;sh1&quot;/&gt;      # 取节点sh1的city表
        &lt;table name=&quot;country&quot; dataNode=&quot;sh2&quot;/&gt;   # 取节点sh2的country表

# 分片定义(dn节点定义)
&lt;/schema&gt;
    &lt;dataNode name=&quot;sh1&quot; dataHost=&quot;dh1&quot; database= &quot;world&quot; /&gt;  # sh1数据源是从world库，具体连接配置见dh1
    &lt;dataNode name=&quot;sh2&quot; dataHost=&quot;dh2&quot; database= &quot;world&quot; /&gt;  # sh2数据源是从world库，具体连接配置见dh2

# 数据主机定义(dh1定义)
    &lt;dataHost name=&quot;dh1&quot; maxCon=&quot;1000&quot; minCon=&quot;10&quot; balance=&quot;1&quot;  writeType=&quot;0&quot; dbType=&quot;mysql&quot;  dbDriver=&quot;native&quot; switchType=&quot;1&quot;&gt;
        &lt;heartbeat&gt;select user()&lt;/heartbeat&gt;

# 两套主从，默认db1写，其它三台只读。
    &lt;writeHost host=&quot;db1&quot; url=&quot;192.168.10.54:3307&quot; user=&quot;root&quot; password=&quot;123&quot;&gt;  # 主库(Master)
            &lt;readHost host=&quot;db2&quot; url=&quot;192.168.10.54:3309&quot; user=&quot;root&quot; password=&quot;123&quot; /&gt;  # 从库
    &lt;/writeHost&gt;
    &lt;writeHost host=&quot;db3&quot; url=&quot;192.168.10.55:3307&quot; user=&quot;root&quot; password=&quot;123&quot;&gt;  # 备用主库(standby Master)
            &lt;readHost host=&quot;db4&quot; url=&quot;192.168.10.55:3309&quot; user=&quot;root&quot; password=&quot;123&quot; /&gt;  # 从库
    &lt;/writeHost&gt;
    &lt;/dataHost&gt;

# 数据主机定义(dh2定义)
    &lt;dataHost name=&quot;dh2&quot; maxCon=&quot;1000&quot; minCon=&quot;10&quot; balance=&quot;1&quot;  writeType=&quot;0&quot; dbType=&quot;mysql&quot;  dbDriver=&quot;native&quot; switchType=&quot;1&quot;&gt;
        &lt;heartbeat&gt;select user()&lt;/heartbeat&gt;
      
# 两套主从，默认db1写，其它三台只读。
    &lt;writeHost host=&quot;db1&quot; url=&quot;192.168.10.54:3308&quot; user=&quot;root&quot; password=&quot;123&quot;&gt;   # 主库(Master)
            &lt;readHost host=&quot;db2&quot; url=&quot;192.168.10.54:3310&quot; user=&quot;root&quot; password=&quot;123&quot; /&gt;  # 从库
    &lt;/writeHost&gt;
    &lt;writeHost host=&quot;db3&quot; url=&quot;192.168.10.55:3308&quot; user=&quot;root&quot; password=&quot;123&quot;&gt;   # 备用主库(Standby Master)
            &lt;readHost host=&quot;db4&quot; url=&quot;192.168.10.55:3310&quot; user=&quot;root&quot; password=&quot;123&quot; /&gt;  # 从库
    &lt;/writeHost&gt;
    &lt;/dataHost&gt;
	
&lt;/mycat:schema&gt;
</code></pre>
<h3 id="42-schemaxml-部分参数说明">4.2 schema.xml 部分参数说明</h3>
<p>以下参数正常使用默认值即可。</p>
<pre><code class="language-shell">&lt;dataHost name=&quot;dh2&quot; maxCon=&quot;1000&quot; minCon=&quot;10&quot; balance=&quot;1&quot;  writeType=&quot;0&quot; dbType=&quot;mysql&quot;  dbDriver=&quot;native&quot; switchType=&quot;1&quot;&gt;
        &lt;heartbeat&gt;select user()&lt;/heartbeat&gt;
balance # 读负载均衡参数
	1：1w/3r,所有standby writehost、readhost参与select语句的负载均衡。
	0：1rw,不开启读写分离机制，所有读写操作都发送到第一台writehost上。
	2：1rw/3r,所有读操作都随机在wirtehost、readhost上分发。
	
writeType # 写负载均衡参数
	0：1w/3r,默认，所有写操作只发送到配置的第一个writehost，第一个挂了后，切换到第二个还生存的writehsot，重新弄启动后以切换后的writehost为主，切换记录在配置文件：dnindex.properties中。
	1：2w/2r,所有写操作随机发送到所有writehost，般用于双主半同步复制。并不推荐使用。

switchType # 是否自动切换
	-1：不自动切换
	1 ：默认，自动切换
	2 ：基于MySQL主从同步的状态决定是否切换，心跳语句未show slave status

maxCon # 最大连接并发数
minCon # 连接池，mycat在启动之后，会在后端节点上自动开启的链接线程

tempReadHostAvailable = &quot;1&quot; # master宕机后，允许这台的slave继续处理select任务
	这个一主一从时（一个readhost，一个writehost），可以开启这个参数。一般不用。

&lt;heartbeat&gt;select user()&lt;/heartbeat&gt; # 监测心跳
</code></pre>
<h2 id="5-垂直分片应用">5、垂直分片应用</h2>
<h3 id="51-配置文件准备">5.1 配置文件准备</h3>
<pre><code class="language-xml">[root@localhost ~]# vim /opt/mycat/conf/schema.xml

&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;!DOCTYPE mycat:schema SYSTEM &quot;schema.dtd&quot;&gt;
&lt;mycat:schema xmlns:mycat=&quot;http://io.mycat/&quot;&gt;
&lt;schema name=&quot;TESTDB&quot; checkSQLschema=&quot;false&quot; sqlMaxLimit=&quot;100&quot; dataNode=&quot;sh1&quot;&gt;
        &lt;table name=&quot;table7&quot; dataNode=&quot;sh1&quot;/&gt;
        &lt;table name=&quot;table8&quot; dataNode=&quot;sh2&quot;/&gt;

&lt;/schema&gt;
    &lt;dataNode name=&quot;sh1&quot; dataHost=&quot;dh1&quot; database= &quot;world&quot; /&gt;
    &lt;dataNode name=&quot;sh2&quot; dataHost=&quot;dh2&quot; database= &quot;world&quot; /&gt;

    &lt;dataHost name=&quot;dh1&quot; maxCon=&quot;1000&quot; minCon=&quot;10&quot; balance=&quot;1&quot;  writeType=&quot;0&quot; dbType=&quot;mysql&quot;  dbDriver=&quot;native&quot; switchType=&quot;1&quot;&gt;
        &lt;heartbeat&gt;select user()&lt;/heartbeat&gt;
    &lt;writeHost host=&quot;db1&quot; url=&quot;192.168.10.54:3307&quot; user=&quot;root&quot; password=&quot;123&quot;&gt;
            &lt;readHost host=&quot;db2&quot; url=&quot;192.168.10.54:3309&quot; user=&quot;root&quot; password=&quot;123&quot; /&gt;
    &lt;/writeHost&gt;
    &lt;writeHost host=&quot;db3&quot; url=&quot;192.168.10.55:3307&quot; user=&quot;root&quot; password=&quot;123&quot;&gt;
            &lt;readHost host=&quot;db4&quot; url=&quot;192.168.10.55:3309&quot; user=&quot;root&quot; password=&quot;123&quot; /&gt;
    &lt;/writeHost&gt;
    &lt;/dataHost&gt;

    &lt;dataHost name=&quot;dh2&quot; maxCon=&quot;1000&quot; minCon=&quot;10&quot; balance=&quot;1&quot;  writeType=&quot;0&quot; dbType=&quot;mysql&quot;  dbDriver=&quot;native&quot; switchType=&quot;1&quot;&gt;
        &lt;heartbeat&gt;select user()&lt;/heartbeat&gt;
    &lt;writeHost host=&quot;db1&quot; url=&quot;192.168.10.54:3308&quot; user=&quot;root&quot; password=&quot;123&quot;&gt;
            &lt;readHost host=&quot;db2&quot; url=&quot;192.168.10.54:3310&quot; user=&quot;root&quot; password=&quot;123&quot; /&gt;
    &lt;/writeHost&gt;
    &lt;writeHost host=&quot;db3&quot; url=&quot;192.168.10.55:3308&quot; user=&quot;root&quot; password=&quot;123&quot;&gt;
            &lt;readHost host=&quot;db4&quot; url=&quot;192.168.10.55:3310&quot; user=&quot;root&quot; password=&quot;123&quot; /&gt;
    &lt;/writeHost&gt;
    &lt;/dataHost&gt;

&lt;/mycat:schema&gt;
</code></pre>
<h3 id="52-创建测试数据库">5.2 创建测试数据库</h3>
<p>在3307节点创建table7和table9，在3308节点创建table7和table9。</p>
<pre><code class="language-shell">mysql -S /data/3307/mysql.sock -e &quot;create database world charset utf8;&quot;
mysql -S /data/3308/mysql.sock -e &quot;create database world charset utf8;&quot;
mysql -S /data/3307/mysql.sock -e &quot;use world;create table table7(id int,name varchar(20));create table table9(id int,name varchar(20));&quot;
mysql -S /data/3308/mysql.sock -e &quot;use world;create table table8(id int,name varchar(20));create table table7(id int,name varchar(20));&quot;
</code></pre>
<h3 id="53-重启mycat并检查逻辑库">5.3 重启mycat并检查逻辑库</h3>
<pre><code class="language-mysql">mycat restart;

mysql&gt; use TESTDB
Database changed
mysql&gt; show tables;
+-----------------+
| Tables_in_world |
+-----------------+
| table7          |
| table8          |
| table9          |
+-----------------+
3 rows in set (0.01 sec)
</code></pre>
<h3 id="54-写入测试">5.4 写入测试</h3>
<p>目前逻辑库TESTDB中存在table7-9三张表。table7为3307节点表，table8为3308节点表，table9为3308/3309共有表。以此结论进行写入测试。</p>
<pre><code class="language-mysql"># 在逻辑库TESTDB中对3张表进行数据插入
mysql&gt; insert into table7 values(1,'a');
mysql&gt; insert into table8 values(2,'b');
mysql&gt; insert into table9 values(3,'c');

# 在逻辑库查看三张表数据
mysql&gt; select * from table7;
+------+------+
| id   | name |
+------+------+
|    1 | a    |
+------+------+
1 row in set (0.03 sec)

mysql&gt; select * from table8;
+------+------+
| id   | name |
+------+------+
|    2 | b    |
+------+------+
1 row in set (0.00 sec)

mysql&gt; select * from table9;
+------+------+
| id   | name |
+------+------+
|    3 | c    |
+------+------+
1 row in set (0.00 sec)
</code></pre>
<pre><code class="language-mysql"># 在3307节点查看数据
[root@db4 ~]# mysql -S /data/3307/mysql.sock -e &quot;select * from world.table7;&quot;
+------+------+
| id   | name |
+------+------+
|    1 | a    |
+------+------+
[root@db4 ~]# mysql -S /data/3307/mysql.sock -e &quot;select * from world.table9;&quot;
+------+------+
| id   | name |
+------+------+
|    3 | c    |
+------+------+
</code></pre>
<pre><code class="language-mysql"># 在3308节点查看数据
[root@db4 ~]# mysql -S /data/3308/mysql.sock -e &quot;select * from world.table8;&quot;
+------+------+
| id   | name |
+------+------+
|    2 | b    |
+------+------+
[root@db4 ~]# mysql -S /data/3309/mysql.sock -e &quot;select * from world.table9;&quot;
+------+------+
| id   | name |
+------+------+
|    3 | c    |
+------+------+
</code></pre>
<h2 id="6-水平分片应用">6、水平分片应用</h2>
<h3 id="61-拆分概念">6.1 拆分概念</h3>
<h4 id="611-分片策略">6.1.1 分片策略</h4>
<p>水平拆分包含了几乎经典业务中大部分的分片策略，mycat已经开发了相应算法，非常方便调用。<br>
范围分片<br>
取模<br>
枚举<br>
日期<br>
HASH 等</p>
<h4 id="612-分片键">6.1.2 分片键</h4>
<p>作为分片条件的列，用来做查询条件的列，比较适合做分片键。</p>
<h3 id="62-范围分片">6.2 范围分片</h3>
<p>对一张表table3进行分片</p>
<h4 id="621-试用环境">6.2.1 试用环境</h4>
<p>1、表内行数较多(如2000w行数据，可按照范围分为1-1000w，1000w01-2000w分片)<br>
2、数据访问非常频繁，但用户访问较离散。所有数据范围均匀访问。</p>
<h4 id="622-配置文件准备">6.2.2 配置文件准备</h4>
<p>修改配置文件，定制分片策略。</p>
<pre><code class="language-shell"># 1、schema.xml 添加：
vim schema.xml
&lt;table name=&quot;table3&quot; dataNode=&quot;sh1,sh2&quot; rule=&quot;auto-sharding-long&quot; /&gt;
</code></pre>
<pre><code class="language-shell"># 2、定义和使用分片策略
vim rule.xml
&lt;tableRule name=&quot;auto-sharding-long&quot;&gt;   # 分片策略名称，schema.xml中调用
                &lt;rule&gt;
                        &lt;columns&gt;id&lt;/columns&gt;      # 分片键为id列
                        &lt;algorithm&gt;rang-long&lt;/algorithm&gt;  # 范围方式(函数)
                &lt;/rule&gt;    
                
&lt;function name=&quot;rang-long&quot;
    class=&quot;io.mycat.route.function.AutoPartitionByLong&quot;&gt;
    &lt;property name=&quot;mapFile&quot;&gt;autopartition-long.txt&lt;/property&gt;    # 传参文件
&lt;/function&gt;
</code></pre>
<pre><code class="language-shell"># 3、定义范围
vim autopartition-long.txt
0-10=0     # id为0-10为0号分片
10-20=1    # id为10-20为0号分片
</code></pre>
<h4 id="623-创建测试表">6.2.3 创建测试表</h4>
<pre><code class="language-shell">mysql -S /data/3307/mysql.sock -e &quot;use world;create table table3 (id int not null primary key auto_increment,name varchar(20) not null);&quot;
mysql -S /data/3308/mysql.sock -e &quot;use world;create table table3 (id int not null primary key auto_increment,name varchar(20) not null);&quot;
</code></pre>
<h4 id="624-重启mycat并检查">6.2.4 重启mycat并检查</h4>
<pre><code class="language-shell">mycat restart 

mysql&gt; show tables;
+-----------------+
| Tables_in_world |
+-----------------+
| table3          |
| table7          |
| table8          |
| table9          |
+-----------------+
4 rows in set (0.07 sec)
</code></pre>
<h4 id="625-写入测试">6.2.5 写入测试</h4>
<pre><code class="language-mysql">use TESTDB;
insert into table3(id,name) values(1,'a');
insert into table3(id,name) values(2,'b');
insert into table3(id,name) values(3,'c');
insert into table3(id,name) values(4,'d');
insert into table3(id,name) values(11,'aa');
insert into table3(id,name) values(12,'bb');
insert into table3(id,name) values(13,'cc');
insert into table3(id,name) values(14,'dd');
</code></pre>
<pre><code class="language-mysql"># 逻辑库查询结果
mysql&gt; select * from table3;
+----+------+
| id | name |
+----+------+
|  1 | a    |
|  2 | b    |
|  3 | c    |
|  4 | d    |
| 11 | aa   |
| 12 | bb   |
| 13 | cc   |
| 14 | dd   |
+----+------+
8 rows in set (0.03 sec)
</code></pre>
<pre><code class="language-shell"># 3307节点查询结果
[root@db4 ~]# mysql -S /data/3307/mysql.sock -e &quot;select * from world.table3;&quot;
+----+------+
| id | name |
+----+------+
|  1 | a    |
|  2 | b    |
|  3 | c    |
|  4 | d    |
+----+------+
</code></pre>
<pre><code class="language-shell"># 3308节点查询结果
[root@db4 ~]# mysql -S /data/3308/mysql.sock -e &quot;select * from world.table3;&quot;
+----+------+
| id | name |
+----+------+
| 11 | aa   |
| 12 | bb   |
| 13 | cc   |
| 14 | dd   |
+----+------+
</code></pre>
<h3 id="63-取模分片">6.3 取模分片</h3>
<p>取余数分片方式：分片键（一个列）与节点数进行取余，得到余数，将数据写入对应节点。</p>
<h4 id="631-配置文件准备">6.3.1 配置文件准备</h4>
<pre><code class="language-shell"># 1、schema.xml 添加：
vim schema.xml
&lt;table name=&quot;table4&quot; dataNode=&quot;sh1,sh2&quot; rule=&quot;mod-long&quot; /&gt;
</code></pre>
<pre><code class="language-shell"># 查看和定义分片使用
vim rule.xml
&lt;property name=&quot;count&quot;&gt;2&lt;/property&gt;  # 定义被除数（节点个数）
</code></pre>
<h4 id="632-准备测试表">6.3.2 准备测试表</h4>
<pre><code class="language-shell">mysql -S /data/3307/mysql.sock -e &quot;use world;create table table4 (id int not null primary key auto_increment,name varchar(20) not null);&quot;
mysql -S /data/3308/mysql.sock -e &quot;use world;create table table4 (id int not null primary key auto_increment,name varchar(20) not null);&quot;
</code></pre>
<h4 id="633-重启mycat">6.3.3 重启mycat</h4>
<p>mycat restart</p>
<h4 id="634-写入测试">6.3.4 写入测试</h4>
<pre><code class="language-mysql">use TESTDB;
insert into table4(id,name) values(1,'a');
insert into table4(id,name) values(2,'b');
insert into table4(id,name) values(3,'c');
insert into table4(id,name) values(4,'d');
</code></pre>
<pre><code class="language-mysql"># 在逻辑库TESTDB查询结果
mysql&gt; select * from table4;
+----+------+
| id | name |
+----+------+
|  2 | b    |
|  4 | d    |
|  1 | a    |
|  3 | c    |
+----+------+
4 rows in set (0.03 sec)
</code></pre>
<pre><code class="language-shell"># 在3307节点查询结果
[root@db4 ~]# mysql -S /data/3307/mysql.sock -e &quot;select * from world.table4;&quot;
+----+------+
| id | name |
+----+------+
|  2 | b    |
|  4 | d    |
+----+------+
</code></pre>
<pre><code class="language-shell"># 在3308节点查询结果
[root@db4 ~]# mysql -S /data/3308/mysql.sock -e &quot;select * from world.table4;&quot;
+----+------+
| id | name |
+----+------+
|  1 | a    |
|  3 | c    |
+----+------+
</code></pre>
<h3 id="64-枚举分片">6.4 枚举分片</h3>
<p>枚举分片要根据不同的表的情况，选择分片键 。如中国表中，是根据不同省进行存储数据，便可根据省名称进行分片。前提是有一个列中存储了省的名称。如bj、sh、hlj等。如下表，可根据name列进行分片。</p>
<table>
<thead>
<tr>
<th>id</th>
<th>name</th>
<th>teleno</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>bj</td>
<td>1111111</td>
</tr>
<tr>
<td>2</td>
<td>sh</td>
<td>2222222</td>
</tr>
<tr>
<td>3</td>
<td>bj</td>
<td>3333333</td>
</tr>
<tr>
<td>4</td>
<td>hlj</td>
<td>4444444</td>
</tr>
<tr>
<td>5</td>
<td>sh</td>
<td>5555555</td>
</tr>
</tbody>
</table>
<h4 id="641-配置文件准备">6.4.1 配置文件准备</h4>
<pre><code class="language-shell"># 1、schema.xml 添加：
vim schema.xml
&lt;table name=&quot;table4&quot; dataNode=&quot;sh1,sh2&quot; rule=&quot;sharding-by-intfile&quot; /&gt;
</code></pre>
<pre><code class="language-shell"># 2、查看和定义分片使用
vim rule.xml
        &lt;tableRule name=&quot;sharding-by-intfile&quot;&gt;
                &lt;rule&gt;
                        &lt;columns&gt;name&lt;/columns&gt;   # 修改分片键(name)
                        &lt;algorithm&gt;hash-int&lt;/algorithm&gt;
                &lt;/rule&gt;

        &lt;function name=&quot;hash-int&quot;
                          class=&quot;io.mycat.route.function.PartitionByFileMap&quot;&gt;
                &lt;property name=&quot;mapFile&quot;&gt;partition-hash-int.txt&lt;/property&gt;
                &lt;property name=&quot;type&quot;&gt;1&lt;/property&gt;         # rule增加此行，修改type为1。不然默认为0，partition-hash-int.txt文档只支持二进制。bj/sh不生效。
        &lt;/function&gt;
</code></pre>
<pre><code class="language-shell"># 3、定义范围
vim partition-hash-int.txt
bj=0         # name列为bj，分到0分片
sh=1         # name列为sh，分到1分片
DEFAULT_NODE=1    # 其它非bj,sh，分到默认1分片
</code></pre>
<h3 id="65-mycat全局表">6.5 Mycat全局表</h3>
<p>如果你的业务中有写数据类似于数据字典，比如配置文件的配置、常用业务的配置或者数据量不大很少变动的表。这些表往往不是特别大，而且大部分的业务场景都会用到。那么这种表适合设置为Mycat全局表。无需对数据进行切分，在所有的分片上保存一份数据即可。<br>
Mycat在Join操作中，业务表与全局表进行Join聚合会优先选择相同分片内的全局表join，避免跨库join。在进行数据插入操作是，mycat将把数据分发到全局表对应的所有分片执行，在进行数据读取时候会随机获取一个节点的数据。</p>
<h4 id="651-配置全局表">6.5.1 配置全局表</h4>
<pre><code class="language-shell"># 1、schema.xml 添加：
vim schema.xml
&lt;table name=&quot;t_area&quot; primaryKey=&quot;id&quot; type=&quot;global&quot; dataNode=&quot;sh1,sh2&quot; /&gt;
</code></pre>
<h3 id="66-e-r分片">6.6 E-R分片</h3>
<p>如果业务中有两张表经常做join操作，如可以设置为E-R分片。如</p>
<pre><code class="language-shell">select * from a join b on a.id = b.aid where b.id = 1002;
</code></pre>
<p>此策略会按取模分片的方式将两张表的数据分别分片到两个节点内，且相关联的数据会分到同一个节点。<br>
如a，b表：</p>
<p>a:</p>
<table>
<thead>
<tr>
<th>id</th>
<th>name</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>a</td>
</tr>
<tr>
<td>2</td>
<td>b</td>
</tr>
</tbody>
</table>
<p>b:</p>
<table>
<thead>
<tr>
<th>id</th>
<th>addr</th>
<th>aid</th>
</tr>
</thead>
<tbody>
<tr>
<td>1001</td>
<td>bj</td>
<td>1</td>
</tr>
<tr>
<td>1002</td>
<td>sh</td>
<td>2</td>
</tr>
</tbody>
</table>
<p>分片结果会a表的1行和b表的1001行在一个节点，a表的2和b表的1002在一个节点。因为有aid相关联。</p>
<h4 id="661-准备配置文件">6.6.1 准备配置文件</h4>
<p><code>schema.xml</code>添加</p>
<pre><code class="language-shell">vim schema.xml
&lt;table name=&quot;a&quot; dataNode=&quot;sh1,sh2&quot; rule=&quot;mod-long_e-r&quot; &gt;  # 因为rule名称与mod-log重复，复制重命名新增一个，对应rule也需要新增同样名称表定义和函数。
		&lt;childTable name=&quot;b&quot; joinKey=&quot;aid&quot; parentKey=&quot;id&quot; /&gt;  # 配置非驱动表
&lt;/table&gt;
</code></pre>
<p><code>rule.xml</code>增加</p>
<pre><code class="language-shell">vim rule.xml
&lt;/tableRule&gt;
&lt;tableRule name=&quot;mod-long_e-r&quot;&gt;   # 自定义表定义名称
        &lt;rule&gt;
                &lt;columns&gt;id&lt;/columns&gt;
                &lt;algorithm&gt;mod-long&lt;/algorithm&gt;
        &lt;/rule&gt;


&lt;/function&gt;
&lt;function name=&quot;mod-long_e-r&quot; class=&quot;io.mycat.route.function.PartitionByMod&quot;&gt;    # 自定义函数名称
        &lt;!-- how many data nodes --&gt;
        &lt;property name=&quot;count&quot;&gt;2&lt;/property&gt;
&lt;/function&gt;
</code></pre>
<h4 id="662-准备测试表">6.6.2 准备测试表</h4>
<pre><code class="language-shell">mysql -S /data/3307/mysql.sock -e &quot;use world;CREATE TABLE a ( id INT NOT NULL PRIMARY key auto_increment, NAME VARCHAR ( 20 ) NOT NULL );&quot;
mysql -S /data/3307/mysql.sock -e &quot;use world;CREATE TABLE b ( id INT NOT NULL PRIMARY key auto_increment, addr VARCHAR ( 20 ) NOT NULL, aid int);&quot;

mysql -S /data/3308/mysql.sock -e &quot;use world;CREATE TABLE a ( id INT NOT NULL PRIMARY key auto_increment, NAME VARCHAR ( 20 ) NOT NULL );&quot;
mysql -S /data/3308/mysql.sock -e &quot;use world;CREATE TABLE b ( id INT NOT NULL PRIMARY key auto_increment, addr VARCHAR ( 20 ) NOT NULL, aid int);&quot;
</code></pre>
<h4 id="663-重启mycat">6.6.3 重启mycat</h4>
<p>mycat restart</p>
<h4 id="664-写入测试">6.6.4 写入测试</h4>
<pre><code class="language-mysql"># 在逻辑库TESTDB写入
insert into a(id,name) values(1,'a');
insert into a(id,name) values(2,'b');
insert into a(id,name) values(3,'c');
insert into a(id,name) values(4,'d');
insert into a(id,name) values(5,'e');

insert into b(id,addr,aid) values(1001,'bj',1);
insert into b(id,addr,aid) values(1002,'sh',2);
insert into b(id,addr,aid) values(1003,'gz',3);
insert into b(id,addr,aid) values(1004,'wh',4);
insert into b(id,addr,aid) values(1005,'tj',5);
</code></pre>
<pre><code class="language-mysql"># 在逻辑库查询结果
mysql&gt; USE TESTDB;
mysql&gt; select * from a;
+----+------+
| id | NAME |
+----+------+
|  2 | b    |
|  4 | d    |
|  1 | a    |
|  3 | c    |
|  5 | e    |
+----+------+
5 rows in set (0.02 sec)

mysql&gt; select * from b;
+------+------+------+
| id   | addr | aid  |
+------+------+------+
| 1002 | sh   |    2 |
| 1004 | wh   |    4 |
| 1001 | bj   |    1 |
| 1003 | gz   |    3 |
| 1005 | tj   |    5 |
+------+------+------+
5 rows in set (0.00 sec)
</code></pre>
<pre><code class="language-shell"># 在3307节点查询结果
[root@db4 ~]# mysql -S /data/3307/mysql.sock -e &quot;select * from world.a;&quot;
+----+------+
| id | NAME |
+----+------+
|  2 | b    |
|  4 | d    |
+----+------+
[root@db4 ~]# mysql -S /data/3307/mysql.sock -e &quot;select * from world.b;&quot;
+------+------+------+
| id   | addr | aid  |
+------+------+------+
| 1002 | sh   |    2 |
| 1004 | wh   |    4 |
+------+------+------+
</code></pre>
<pre><code class="language-shell"># 在3308节点查询结果
[root@db4 ~]# mysql -S /data/3308/mysql.sock -e &quot;select * from world.a;&quot;
+----+------+
| id | NAME |
+----+------+
|  1 | a    |
|  3 | c    |
|  5 | e    |
+----+------+
[root@db4 ~]# mysql -S /data/3308/mysql.sock -e &quot;select * from world.b;&quot;
+------+------+------+
| id   | addr | aid  |
+------+------+------+
| 1001 | bj   |    1 |
| 1003 | gz   |    3 |
| 1005 | tj   |    5 |
+------+------+------+
</code></pre>
<h2 id="7-mycat日常管理">7、Mycat日常管理</h2>
<h3 id="71-管理服务常用命令">7.1 管理服务常用命令</h3>
<pre><code class="language-mysql"># 查看帮助
show @@help;

# 查看分片信息
show @@datanode;

# 查看数据源
show @@datasource;

# 查看服务信息
show @@server;

# 重载配置信息 
reload @@config      : schema.xml
reload @@config_all  : 所有配置重新加载
</code></pre>
<h3 id="72-修改逻辑库名">7.2 修改逻辑库名</h3>
<pre><code class="language-xml"># 修改配置文件
vim schema.xml
&lt;schema name=&quot;DB2&quot; checkSQLschema=&quot;false&quot; sqlMaxLimit=&quot;100&quot; dataNode=&quot;sh1&quot;&gt;   # 修改库名DB2
vim server.xml
        &lt;user name=&quot;root&quot; defaultAccount=&quot;true&quot;&gt;              # root用户
                &lt;property name=&quot;password&quot;&gt;123456&lt;/property&gt;   # 默认密码 
                &lt;property name=&quot;schemas&quot;&gt;DB2&lt;/property&gt;       # 默认数据库(修改)
                &lt;property name=&quot;defaultSchema&quot;&gt;DB2&lt;/property&gt; # 默认数据库(修改)
                &lt;!--No MyCAT Database selected 错误前会尝试使用该schema作为schema，不设置则为null,报错 --&gt;
                &lt;!-- 表级 DML 权限设置 --&gt;
                &lt;!--            
                &lt;privileges check=&quot;false&quot;&gt;
                        &lt;schema name=&quot;TESTDB&quot; dml=&quot;0110&quot; &gt;
                                &lt;table name=&quot;tb01&quot; dml=&quot;0000&quot;&gt;&lt;/table&gt;
                                &lt;table name=&quot;tb02&quot; dml=&quot;1111&quot;&gt;&lt;/table&gt;
                        &lt;/schema&gt;
                &lt;/privileges&gt;           
                 --&gt;
        &lt;/user&gt;
        &lt;user name=&quot;user&quot;&gt;
                &lt;property name=&quot;password&quot;&gt;user&lt;/property&gt;      # user 用户
                &lt;property name=&quot;schemas&quot;&gt;DB2&lt;/property&gt;        # 默认数据库(修改)
                &lt;property name=&quot;readOnly&quot;&gt;true&lt;/property&gt;      # 只读权限
                &lt;property name=&quot;defaultSchema&quot;&gt;DB2&lt;/property&gt;  # 默认数据库(修改)
        &lt;/user&gt;

# 重载配置信息
reload config_all;
</code></pre>
<h3 id="73-增加逻辑库">7.3 增加逻辑库</h3>
<pre><code class="language-xml"># schema.xml增加
&lt;schema name=&quot;DB3&quot; checkSQLschema=&quot;false&quot; sqlMaxLimit=&quot;100&quot; dataNode=&quot;sh1&quot;&gt; 
&lt;/schema&gt;

# server.xml里授权
&lt;property name=&quot;schemas&quot;&gt;DB2,DB3&lt;/property&gt;   # 在原库后增加&quot;,&quot;分隔

# 重载配置信息
reload config_all;
</code></pre>

            </div>
            
              <div class="tag-container">
                
                  <a href="https://www.ssgeek.com/tag/M29o-BG-i" class="tag">
                    mysql
                  </a>
                
              </div>
            
            
              <div class="next-post">
                <div class="next">下一篇</div>
                <a href="https://www.ssgeek.com/post/golang-shu-ju-lei-xing-zhi-qie-pian">
                  <h3 class="post-title">
                    Golang数据类型之切片
                  </h3>
                </a>
              </div>
            

            
              
                <div id="gitalk-container" data-aos="fade-in"></div>
              

              
            

          </div>

        </div>
      </div>
    </div>

    <script src="https://cdn.bootcdn.net/ajax/libs/aos/2.3.4/aos.js"></script>

<script type="application/javascript">

AOS.init();

hljs.initHighlightingOnLoad()

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>



  
    <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
    <script>

      var gitalk = new Gitalk({
        clientID: '22c870a7f8551b566598',
        clientSecret: '1acfdedd403cdf39c4a6ce932a4a991bb2b32e3a',
        repo: 'hargeek.github.io',
        owner: 'hargeek',
        admin: ['hargeek'],
        id: (location.pathname).substring(0, 49),      // Ensure uniqueness and length less than 50
        distractionFreeMode: false  // Facebook-like distraction free mode
      })

      gitalk.render('gitalk-container')

    </script>
  

  


  </body>
</html>
