<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>Pythonåˆ†æNginxæ—¥å¿— | å±±å±±ä»™äººåšå®¢</title>
<meta name="description" content="">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/5.7.2/css/all.css">
<link rel="shortcut icon" href="https://www.ssgeek.com/favicon.ico?v=1714317474949">
<link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://www.ssgeek.com/styles/main.css">


  
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/gitalk/1.6.2/gitalk.css" />
  

  


<script src="https://cdn.bootcdn.net/ajax/libs/vue/2.6.11/vue.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
<script data-ad-client="ca-pub-6775328896166270" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?4b826a92a3dc151a74693fa1942d3167";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

<link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/aos/2.3.4/aos.css" />


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-147397031-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-147397031-1');
</script>


  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://www.ssgeek.com">
        <img src="https://www.ssgeek.com/images/avatar.png?v=1714317474949" class="site-logo">
        <h1 class="site-title">å±±å±±ä»™äººåšå®¢</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="https://www.ssgeek.com" class="site-nav">
            é¦–é¡µ
          </a>
        
      
        
          <a href="https://www.ssgeek.com/archives" class="site-nav">
            å½’æ¡£
          </a>
        
      
        
          <a href="https://www.ssgeek.com/tags" class="site-nav">
            æ ‡ç­¾
          </a>
        
      
        
          <a href="https://www.ssgeek.com/post/about/" class="site-nav">
            å…³äº
          </a>
        
      
        
          <a href="https://www.ssgeek.com/post/gong-zhong-hao/" class="site-nav">
            å…¬ä¼—å·
          </a>
        
      
        
          <a href="https://www.ssgeek.com/post/you-qing-lian-jie/" class="site-nav">
            å‹æƒ…é“¾æ¥
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
          <a class="social-link" href="https://github.com/hargeek" target="_blank">
            <i class="fab fa-github"></i>
          </a>
        
      
        
          <a class="social-link" href="https://twitter.com/anronghong" target="_blank">
            <i class="fab fa-twitter"></i>
          </a>
        
      
        
          <a class="social-link" href="https://weibo.com/u/5717964658" target="_blank">
            <i class="fab fa-weibo"></i>
          </a>
        
      
        
          <a class="social-link" href="https://www.zhihu.com/people/hong-an-rong-46/activities" target="_blank">
            <i class="fab fa-zhihu"></i>
          </a>
        
      
        
          <a class="social-link" href="https://www.facebook.com/profile.php?id=100041470532098" target="_blank">
            <i class="fab fa-facebook"></i>
          </a>
        
      
    </div>
    <div class="site-description">
      
    </div>
    <div class="site-footer">
      <a href="https://beian.miit.gov.cn" style="text-decoration:none;">é„‚ICPå¤‡18007156å·-1</a></br></br>Copyright Â© All Rights Reserved | <a class="rss" href="https://www.ssgeek.com/atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>

      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">Pythonåˆ†æNginxæ—¥å¿—</h2>
            <div class="post-date">2019-12-30</div>
            
            <div class="post-content">
              <p><ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#1-%E8%83%8C%E6%99%AF%E4%BB%8B%E7%BB%8D">1ã€èƒŒæ™¯ä»‹ç»</a></li>
<li><a href="#2-%E6%80%9D%E8%B7%AF%E6%BC%94%E8%BF%9B">2ã€æ€è·¯æ¼”è¿›</a>
<ul>
<li><a href="#21-%E7%AC%AC%E4%B8%80%E6%AD%A5%E8%AF%BB%E5%8F%96%E6%97%A5%E5%BF%97">2.1ã€ç¬¬ä¸€æ­¥è¯»å–æ—¥å¿—</a></li>
<li><a href="#22-%E7%AC%AC%E4%BA%8C%E6%AD%A5%E8%A7%A3%E6%9E%90%E6%97%A5%E5%BF%97">2.2ã€ç¬¬äºŒæ­¥è§£ææ—¥å¿—</a></li>
<li><a href="#23-%E7%AC%AC%E4%B8%89%E6%AD%A5%E5%88%86%E6%9E%90%E6%97%A5%E5%BF%97">2.3ã€ç¬¬ä¸‰æ­¥åˆ†ææ—¥å¿—</a></li>
<li><a href="#24-%E7%AC%AC%E5%9B%9B%E6%AD%A5%E7%94%9F%E6%88%90%E6%8A%A5%E5%91%8A">2.4ã€ç¬¬å››æ­¥ç”ŸæˆæŠ¥å‘Š</a></li>
<li><a href="#25-%E7%AC%AC%E4%BA%94%E6%AD%A5%E6%97%A5%E5%BF%97%E9%87%87%E9%9B%86">2.5ã€ç¬¬äº”æ­¥æ—¥å¿—é‡‡é›†</a></li>
<li><a href="#26-%E7%BB%93%E6%9E%9C%E5%B1%95%E7%A4%BA">2.6ã€ç»“æœå±•ç¤º</a></li>
<li><a href="#27-%E5%8F%AF%E6%89%A9%E5%B1%95%E6%96%B9%E5%90%91">2.7ã€å¯æ‰©å±•æ–¹å‘</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</p>
<blockquote>
<p>å¤§ä½¬è¯·è‡ªè§‰è·¯è¿‡~ ~ ~ğŸ¤’ğŸ¤’ğŸ¤’</p>
</blockquote>
<h2 id="1-èƒŒæ™¯ä»‹ç»">1ã€èƒŒæ™¯ä»‹ç»</h2>
<p>æœ¬æ–‡ä»¥æˆ‘çš„åšå®¢ç«™ç‚¹å…¶ä¸­ä¸€æ®µæ—¶é—´çš„è®¿é—®æ—¥å¿—ä¸ºä¾‹è¿›è¡Œåˆ†æ</p>
<ul>
<li>
<p>ç”¨åˆ°çš„çŸ¥è¯†ç‚¹<br>
åŸºæœ¬æ•°æ®ç±»å‹åˆ—è¡¨ï¼ŒåŸºæœ¬æ•°æ®ç±»å‹å­—å…¸ï¼Œ<code>re</code>æ¨¡å—æ­£åˆ™åŒ¹é…ï¼Œ<code>pandas</code>æ¨¡å—æ•°æ®å¤„ç†ï¼Œ<code>xlwt</code>æ¨¡å—<code>excel</code>å†™å…¥ç­‰</p>
</li>
<li>
<p>æœ€ç»ˆå®ç°çš„åŠŸèƒ½<br>
åˆ†æå¾—åˆ°æ—¥å¿—ä¸­è®¿é—®<code>ip</code>çš„<code>top20</code>ï¼Œè®¿é—®åœ°å€çš„<code>top20</code>ï¼Œè®¿é—®å®¢æˆ·ç«¯<code>ua</code>çš„æ’åï¼Œå¹¶ä¸”ç”Ÿæˆ<code>excel</code>æŠ¥è¡¨</p>
</li>
</ul>
<h2 id="2-æ€è·¯æ¼”è¿›">2ã€æ€è·¯æ¼”è¿›</h2>
<h3 id="21-ç¬¬ä¸€æ­¥è¯»å–æ—¥å¿—">2.1ã€ç¬¬ä¸€æ­¥è¯»å–æ—¥å¿—</h3>
<p>å¯¹<code>nginx</code>è¿›è¡Œæ—¥å¿—åˆ†æï¼Œé¦–å…ˆæ‹¿åˆ°éœ€è¦åˆ†æçš„<code>nginx</code>æ—¥å¿—æ–‡ä»¶ï¼Œæ—¥å¿—æ–‡ä»¶çš„å†…å®¹å…·æœ‰å›ºå®šçš„å®šä¹‰æ–¹æ³•ï¼Œæ¯ä¸€è¡Œçš„æ—¥å¿—ä¸­æ¯ä¸€ä¸ªç‰¹æ®Šçš„å­—æ®µéƒ½ä»£è¡¨ç€å…·ä½“çš„å«ä¹‰ï¼Œä¾‹å¦‚ï¼š</p>
<pre><code>95.143.192.110 - - [15/Dec/2019:10:22:00 +0800] &quot;GET /post/pou-xi-he-jie-jue-python-zhong-wang-luo-nian-bao-de-zheng-que-zi-shi/ HTTP/1.1&quot; 304 0 &quot;https://www.ssgeek.com/&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.108 Safari/537.36&quot;
</code></pre>
<p>ä¸Šé¢çš„æ—¥å¿—å†…å®¹çš„å­—æ®µä¿¡æ¯ä¾æ¬¡ä»£è¡¨ç€ï¼šè®¿é—®è€…æ¥æº<code>ip</code>ã€è®¿é—®æ—¶é—´ã€<code>http</code>è¯·æ±‚æ–¹æ³•ã€è¯·æ±‚åœ°å€ã€<code>http</code>çŠ¶æ€ç ã€æœ¬æ¬¡è¯·æ±‚çš„å­—èŠ‚å¤§å°ã€<code>refer</code>ä¿¡æ¯ã€å®¢æˆ·ç«¯<code>ua</code>æ ‡è¯†</p>
<p>å› æ­¤ï¼Œé¦–å…ˆæç‚¼å‡ºä¸€è¡Œå†…å®¹ï¼Œå¯¹è¿™è¡Œå†…å®¹è¿›è¡Œåˆ†ç»„ç»Ÿè®¡å¹¶è®°å½•æ¯ä¸ªå­—æ®µçš„å…·ä½“ä¿¡æ¯ï¼Œç„¶åæŠŠå¯¹è¿™ä¸€è¡Œçš„åˆ†ææ‰‹æ®µå»å¯¹æ•´ä¸ªæ—¥å¿—æ–‡ä»¶è¿›è¡Œåˆ†æï¼Œä¸ºäº†åŒ¹é…æ—¥å¿—ä¸­çš„æ¯ä¸ªå­—æ®µï¼Œéœ€è¦ç”¨åˆ°<code>re</code>æ¨¡å—è¿›è¡Œæ­£åˆ™åŒ¹é…ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code>import re


obj = re.compile(r'(?P&lt;ip&gt;.*?)- - \[(?P&lt;time&gt;.*?)\] &quot;(?P&lt;request&gt;.*?)&quot; (?P&lt;status&gt;.*?) (?P&lt;bytes&gt;.*?) &quot;(?P&lt;referer&gt;.*?)&quot; &quot;(?P&lt;ua&gt;.*?)&quot;')

def load_log(path):
    with open(path, mode=&quot;r&quot;, encoding=&quot;utf-8&quot;) as f:
        for line in f:
            line = line.strip()
            parse(line)

def parse(line):
    # è§£æå•è¡Œnginxæ—¥å¿—
    try:
        result = obj.match(line)
        print(result.group(&quot;ip&quot;))
    except:
        pass


if __name__ == '__main__':
    load_log(&quot;nginx_access.log&quot;)
</code></pre>
<p>é€šè¿‡<code>re</code>æ¨¡å—ä¾æ¬¡åˆ†ç»„åŒ¹é…ä¸ºï¼š<code>ip</code>ã€<code>time</code>ã€<code>request</code>ã€<code>status</code>ã€<code>bytes</code>ã€<code>referer</code>ã€<code>ua</code><br>
ä¸Šé¢çš„å†…å®¹æœ€ç»ˆæ‰“å°å‡ºæ¥äº†æ‰€æœ‰çš„è®¿é—®è€…æ¥æº<code>ip</code></p>
<p>è¿›ä¸€æ­¥åŠ å¼ºï¼Œè¾“å‡ºæ‰€æœ‰å­—æ®µï¼Œç›´æ¥æ‰“å°<code>print(result.groupdict())</code>å³å¯ï¼Œè¾“å‡ºç»“æœæ˜¯å¤šä¸ªå­—å…¸ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre><code>{'ip': '46.229.168.150 ', 'time': '24/Dec/2019:13:21:39 +0800', 'request': 'GET /post/zabbix-web-qie-huan-wei-nginx-ji-https HTTP/1.1', 'status': '301', 'bytes': '178', 'referer': '-', 'ua': 'Mozilla/5.0 (compatible; SemrushBot/6~bl; +http://www.semrush.com/bot.html)'}
</code></pre>
<h3 id="22-ç¬¬äºŒæ­¥è§£ææ—¥å¿—">2.2ã€ç¬¬äºŒæ­¥è§£ææ—¥å¿—</h3>
<p>ç²¾å‡†åˆ†æå•è¡Œæ—¥å¿—ï¼Œå¹¶ä¸”åŠ å…¥ä¸€äº›æ ¼å¼åŒ–è¾“å‡ºå’Œè¿‡æ»¤çš„æ‰‹æ®µ</p>
<p><code>load_log()</code>å‡½æ•°ï¼š<br>
åœ¨<code>load_log()</code>å‡½æ•°ä¸­ï¼Œä¸ºäº†é¿å…æœ‰é”™è¯¯çš„æ—¥å¿—ï¼ˆç±»ä¼¼äºâ€œè„æ•°æ®â€ï¼‰ï¼Œå› æ­¤å®šä¹‰äº†ä¸¤ä¸ªç©ºåˆ—è¡¨<code>lst</code>å’Œ<code>error_lst</code>ç”¨æ¥è®°å½•åŒ¹é…çš„ç»“æœï¼Œåˆ—è¡¨ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ è¡¨ç¤ºåŒ¹é…çš„ä¸€è¡Œæ—¥å¿—ï¼Œæœ€åæ‰“å°äº†æ€»è¡Œæ•°ï¼ŒåŒ¹é…åˆ°çš„è¡Œæ•°ï¼Œä¸èƒ½åŒ¹é…åˆ°çš„è¡Œæ•°ï¼ˆé”™è¯¯æ—¥å¿—è¡Œæ•°ï¼‰</p>
<p><code>parse()</code>å‡½æ•°ï¼š<br>
åœ¨<code>parse()</code>å‡½æ•°ä¸­ï¼Œä¼ å…¥å‚æ•°<code>line</code>ï¼Œä¸€æ¬¡å¯¹æ¯è¡Œä¸­åˆ†ç»„åŒ¹é…åˆ°çš„æ¯ä¸€ä¸ªå­—æ®µè¿›è¡Œå¤„ç†ï¼Œå¤„ç†å®Œæˆåèµ‹å€¼åˆ°åˆ—è¡¨å…ƒç´ ï¼Œå…¶ä¸­å®¢æˆ·ç«¯uaæ ‡è¯†ä»…ä»…åˆ—å‡ºäº†ä¸€äº›å¸¸è§çš„ï¼Œå¦‚æœæƒ³è¦åŒ¹é…çš„æ›´ä¸ºç²¾ç¡®ï¼Œå¯ä»¥å‚è€ƒ<a href="http://tools.jb51.net/table/useragent">å¸¸ç”¨æµè§ˆå™¨(PC/ç§»åŠ¨)user-agentå‚è€ƒå¯¹ç…§è¡¨</a>ï¼ŒæŠŠåŒ¹é…è§„åˆ™å†™çš„æ›´ç²¾ç¡®å³å¯</p>
<pre><code>import re
import datetime

obj = re.compile(
    r'(?P&lt;ip&gt;.*?)- - \[(?P&lt;time&gt;.*?)\] &quot;(?P&lt;request&gt;.*?)&quot; (?P&lt;status&gt;.*?) (?P&lt;bytes&gt;.*?) &quot;(?P&lt;referer&gt;.*?)&quot; &quot;(?P&lt;ua&gt;.*?)&quot;')


def load_log(path):
    lst = []
    error_lst = []
    i = 0
    with open(path, mode=&quot;r&quot;, encoding=&quot;utf-8&quot;) as f:
        for line in f:
            line = line.strip()
            dic = parse(line)
            if dic:  # æ­£ç¡®çš„æ•°æ®æ·»åŠ åˆ°lståˆ—è¡¨ä¸­
                lst.append(dic)
            else:
                error_lst.append(line)  # è„æ•°æ®æ·»åŠ åˆ°error_lståˆ—è¡¨ä¸­
            i += 1
    print(i)
    print(len(error_lst))
    print(len(lst))

def parse(line):
    # è§£æå•è¡Œnginxæ—¥å¿—
    dic = {}
    try:
        result = obj.match(line)
        # ipå¤„ç†
        ip = result.group(&quot;ip&quot;)
        if ip.strip() == '-' or ip.strip() == &quot;&quot;:  # å¦‚æœæ˜¯åŒ¹é…åˆ°æ²¡æœ‰ipå°±æŠŠè¿™æ¡æ•°æ®ä¸¢å¼ƒ
            return False
        dic['ip'] = ip.split(&quot;,&quot;)[0]  # å¦‚æœæœ‰ä¸¤ä¸ªipï¼Œå–ç¬¬ä¸€ä¸ªip

        # çŠ¶æ€ç å¤„ç†
        status = result.group(&quot;status&quot;)  # çŠ¶æ€ç 
        dic['status'] = status

        # æ—¶é—´å¤„ç†
        time = result.group(&quot;time&quot;)  # 21/Dec/2019:21:45:31 +0800
        time = time.replace(&quot; +0800&quot;, &quot;&quot;)  # æ›¿æ¢+0800ä¸ºç©º
        t = datetime.datetime.strptime(time, &quot;%d/%b/%Y:%H:%M:%S&quot;)  # å°†æ—¶é—´æ ¼å¼åŒ–æˆå‹å¥½çš„æ ¼å¼
        dic['time'] = t

        # requestå¤„ç†
        request = result.group(
            &quot;request&quot;)  # GET /post/pou-xi-he-jie-jue-python-zhong-wang-luo-nian-bao-de-zheng-que-zi-shi/ HTTP/1.1
        a = request.split()[1].split(&quot;?&quot;)[0]  # å¾€å¾€urlåé¢ä¼šæœ‰ä¸€äº›å‚æ•°ï¼Œurlå’Œå‚æ•°ä¹‹é—´ç”¨?åˆ†éš”ï¼Œå–å‡ºä¸å¸¦å‚æ•°çš„url
        dic['request'] = a

        # user_agentå¤„ç†
        ua = result.group(&quot;ua&quot;)
        if &quot;Windows NT&quot; in ua:
            u = &quot;windows&quot;
        elif &quot;iPad&quot; in ua:
            u = &quot;ipad&quot;
        elif &quot;Android&quot; in ua:
            u = &quot;android&quot;
        elif &quot;Macintosh&quot; in ua:
            u = &quot;mac&quot;
        elif &quot;iPhone&quot; in ua:
            u = &quot;iphone&quot;
        else:
            u = &quot;å…¶ä»–è®¾å¤‡&quot;
        dic['ua'] = u

        # referå¤„ç†
        referer = result.group(&quot;referer&quot;)
        dic['referer'] = referer

        return dic

    except:
        return False


if __name__ == '__main__':
    load_log(&quot;nginx_access.log&quot;)
</code></pre>
<p>æ‰§è¡Œä»£ç ï¼ŒæŸ¥çœ‹æ‰“å°çš„ç»“æœï¼Œæ§åˆ¶å°è¾“å‡ºï¼š</p>
<pre><code>9692
542
9150
</code></pre>
<p>ä¾æ¬¡è¡¨ç¤ºæ—¥å¿—æ–‡ä»¶ä¸­çš„æ€»è¡Œæ•°ã€åŒ¹é…é”™è¯¯ï¼ˆæ²¡æœ‰åŒ¹é…åˆ°çš„ï¼‰çš„è¡Œæ•°ã€åŒ¹é…æ­£ç¡®çš„è¡Œæ•°</p>
<h3 id="23-ç¬¬ä¸‰æ­¥åˆ†ææ—¥å¿—">2.3ã€ç¬¬ä¸‰æ­¥åˆ†ææ—¥å¿—</h3>
<p>åˆ©ç”¨<code>pandas</code>æ¨¡å—è¿›è¡Œæ—¥å¿—çš„åˆ†æ<br>
<code>analyse()</code>å‡½æ•°ï¼š<br>
å°†è§£æè¿‡æ»¤å¾—åˆ°çš„<code>lst</code>åˆ—è¡¨ä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œåˆ—è¡¨ä¸­çš„æ•°æ®æ ¼å¼å½¢å¦‚<code>[{ip:xxx, api:xxx, status:xxxx, ua:xxx}]</code></p>
<p><code>df = pd.DataFrame(lst)</code>å°†è§£æå¾—åˆ°çš„åˆ—è¡¨è½¬æ¢æˆä¸ºç±»ä¼¼è¡¨æ ¼çš„ç±»å‹ï¼Œæ§åˆ¶å°çš„è¾“å‡º<code>df</code>å¦‚ä¸‹ï¼Œå¤„ç†åä¸ºæ¯ä¸ªæ•°æ®åŠ ä¸Šäº†åºå·ï¼Œç¬¬ä¸€è¡Œç›¸å½“äºè¡¨å¤´ï¼Œè¡¨å¤´å°±æ˜¯å‰é¢å¾—åˆ°çš„å­—å…¸ä¸­çš„<code>key</code></p>
<pre><code>                    ip status  ...       ua                  referer
0      95.143.192.110     200  ...      mac                        -
1      95.143.192.110     304  ...      mac                        -
2      95.143.192.110     304  ...      mac                        -
3      95.143.192.110     304  ...      mac  https://www.ssgeek.com/
4      203.208.60.122     200  ...  android                        -
...                ...    ...  ...      ...                      ...
9145      46.4.60.249     404  ...     å…¶ä»–è®¾å¤‡                        -
9146      46.4.60.249     404  ...     å…¶ä»–è®¾å¤‡                        -
9147      46.4.60.249     404  ...     å…¶ä»–è®¾å¤‡                        -
9148      46.4.60.249     404  ...     å…¶ä»–è®¾å¤‡                        -
9149  154.223.188.124     404  ...  windows                        -
</code></pre>
<p><code>pd.value_counts(df['ip'])</code>å–å‡º<code>ip</code>å¹¶ç»Ÿè®¡æ•°<code>ip</code>çš„æ¬¡æ•°ï¼›å¾—åˆ°çš„ç»“æœç¬¬ä¸€åˆ—æ˜¯<code>ip</code>ï¼Œç¬¬äºŒåˆ—æ˜¯æ¬¡æ•°ï¼Œ<code>pandas</code>é»˜è®¤å°†ç¬¬ä¸€åˆ—è®¤ä¸ºæ˜¯è¡Œç´¢å¼•ï¼Œå› æ­¤éœ€è¦å°†æ•°æ®æ•´ä½“å³ç§»ï¼Œé€šè¿‡<code>reset_index()</code>é‡æ–°å®šä¹‰ä¸€ä¸ªç´¢å¼•å³å¯ï¼Œæ•ˆæœå½¢å¦‚ï¼š</p>
<pre><code>                 index   ip
0      89.163.242.228   316
1     207.180.220.114   312
2         78.46.90.53   302
3        144.76.38.10   301
4        78.46.61.245   301
...                ...  ...
1080    203.208.60.85     1
1081      66.249.72.8     1
1082     141.8.132.13     1
1083    207.46.13.119     1
1084     203.208.60.7     1
</code></pre>
<p>è¿™ä¸ªæ—¶å€™å‘ç°ç´¢å¼•æœ‰äº†ï¼Œä½†æ˜¯è¡¨å¤´ä¹Ÿè·Ÿç€å³ç§»äº†ï¼Œä¸å¯¹åº”äº†ï¼Œéœ€è¦é‡æ–°è®¾ç½®ä¸€ä¸ªè¡¨å¤´<code>reset_index().rename(columns={&quot;index&quot;: &quot;ip&quot;, &quot;ip&quot;: &quot;count&quot;})</code>ï¼Œæ•ˆæœå½¢å¦‚</p>
<pre><code>                    ip  count
0      89.163.242.228     316
1     207.180.220.114     312
2         78.46.90.53     302
3        78.46.61.245     301
4        144.76.38.10     301
...                ...    ...
1080     47.103.17.71       1
1081    42.156.254.92       1
1082  220.243.136.156       1
1083   180.163.220.61       1
1084   106.14.215.243       1
</code></pre>
<p>å¾€å¾€åˆ†ææ—¥å¿—åªéœ€è¦å¾—åˆ°è®¿é—®æ¬¡æ•°çš„å‰å‡ åï¼Œä¾‹å¦‚å‰<code>20</code>åï¼Œ<code>pandas</code>åŒæ ·ç»™å‡ºäº†å¾ˆæ–¹ä¾¿çš„<code>iloc</code>é€šè¿‡åˆ‡ç‰‡å®ç°è¿™ä¸ªéœ€æ±‚ï¼Œ<code>iloc[:20, :]</code>ï¼šå–å‡ºå‰<code>20</code>è¡Œï¼Œå–å‡ºæ‰€æœ‰åˆ—ï¼Œæœ€ç»ˆçš„å¤„ç†ä»£ç ä¸º</p>
<pre><code>    ip_count = pd.value_counts(df['ip']).reset_index().rename(columns={&quot;index&quot;: &quot;ip&quot;, &quot;ip&quot;: &quot;count&quot;}).iloc[:20, :]
    print(ip_count)
</code></pre>
<p>å¾—åˆ°çš„æ•°æ®ç»“æœä¸º</p>
<pre><code>                  ip  count
0    89.163.242.228     316
1   207.180.220.114     312
2       78.46.90.53     302
3      144.76.38.10     301
4      78.46.61.245     301
5     144.76.29.148     301
6    204.12.208.154     301
7     148.251.92.39     301
8         5.9.70.72     286
9     223.71.139.28     218
10     95.216.19.59     209
11    221.13.12.147     131
12     117.15.90.21     130
13  175.184.166.181     129
14   148.251.49.107     128
15    171.37.204.72     127
16   124.95.168.140     118
17    171.34.178.76      98
18   60.216.138.190      97
19    141.8.142.158      87
</code></pre>
<p>åŒæ ·ï¼Œå¯ä»¥æŠŠ<code>request</code>ã€<code>ua</code>ç­‰è¿›è¡Œç›¸åŒçš„æ“ä½œ</p>
<h3 id="24-ç¬¬å››æ­¥ç”ŸæˆæŠ¥å‘Š">2.4ã€ç¬¬å››æ­¥ç”ŸæˆæŠ¥å‘Š</h3>
<p>åˆ©ç”¨<code>xlwt</code>æ¨¡å—å°†pandasåˆ†æå¾—åˆ°çš„æ•°æ®å†™å…¥åˆ°<code>excel</code>è¡¨æ ¼ä¸­ï¼Œå†™å…¥å‰éœ€è¦å°†pandaså¤„ç†åçš„æ•°æ®è½¬åŒ–æˆæ™®é€šçš„æ•°æ®</p>
<pre><code>    ip_count_values = ip_count.values
    request_count_values = request_count.values
    ua_count_values = ua_count.values
</code></pre>
<p>è¿™ä¸ªæ•°æ®ç±»å‹æ˜¯ï¼šæ•°ç»„å¯¹è±¡<code>numpy.ndarray</code>ï¼Œå½¢å¦‚ï¼š</p>
<pre><code>[['89.163.242.228 ' 316]
 ['207.180.220.114 ' 312]
 ['78.46.90.53 ' 302]
 ['204.12.208.154 ' 301]
 ['144.76.29.148 ' 301]
 ['144.76.38.10 ' 301]
 ['78.46.61.245 ' 301]
 ['148.251.92.39 ' 301]
 ['5.9.70.72 ' 286]
 ['223.71.139.28 ' 218]
 ['95.216.19.59 ' 209]
 ['221.13.12.147 ' 131]
 ['117.15.90.21 ' 130]
 ['175.184.166.181 ' 129]
 ['148.251.49.107 ' 128]
 ['171.37.204.72 ' 127]
 ['124.95.168.140 ' 118]
 ['171.34.178.76 ' 98]
 ['60.216.138.190 ' 97]
 ['141.8.142.158 ' 87]]
</code></pre>
<p>é€šè¿‡<code>xlwt</code>æ¨¡å—å†™å…¥<code>sheet</code>é¡µï¼Œæ¯ä¸ª<code>sheet</code>é¡µä¸­å†™å…¥å¯¹åº”å¤„ç†çš„æ•°æ®</p>
<pre><code># å†™å…¥excel
wb = xlwt.Workbook()  # æ‰“å¼€ä¸€ä¸ªexcelæ–‡æ¡£
sheet = wb.add_sheet(&quot;ipè®¿é—®top20&quot;)  # æ–°å»ºä¸€ä¸ªsheeté¡µ
# å†™å…¥å¤´ä¿¡æ¯
row = 0
sheet.write(row, 0, &quot;ip&quot;)  # å†™å…¥è¡Œï¼Œåˆ—ï¼Œå†…å®¹
sheet.write(row, 1, &quot;count&quot;)  # å†™å…¥è¡Œï¼Œåˆ—ï¼Œå†…å®¹
row += 1  # è¡Œå·åŠ ä¸€
for item in ip_count_values:
    sheet.write(row, 0, item[0])
    sheet.write(row, 1, item[1])
    row += 1
</code></pre>
<h3 id="25-ç¬¬äº”æ­¥æ—¥å¿—é‡‡é›†">2.5ã€ç¬¬äº”æ­¥æ—¥å¿—é‡‡é›†</h3>
<p>æ—¥å¿—åˆ†æå®Œäº†ï¼Œå›è¿‡å¤´æ¥éœ€è¦çš„æ˜¯é‡‡é›†åˆ°æ—¥å¿—æ–‡ä»¶ï¼Œå¹¶ä¸”å®šæ—¶çš„å»è¿›è¡Œåˆ†æï¼Œå¯ä»¥åˆ©ç”¨<code>time</code>æ¨¡å—å¾—åˆ°æ—¶é—´å¹¶ä¸”åˆ¤æ–­ï¼Œå®ç°å®šæ—¶çš„åˆ†æï¼Œä¾‹å¦‚ï¼Œæ¯æœˆ3å·çš„å‡Œæ™¨1ç‚¹è¿›è¡Œæ—¥å¿—åˆ†æ</p>
<pre><code>import time

if __name__ == '__main__':
    while 1:
        stime = datetime.datetime.now().strftime(&quot;%d:%H:%M:%S&quot;)
        if stime == &quot;03:01:00:00&quot;:
            lst, error_lst = load_log(&quot;nginx_access.log&quot;)
            analyse(lst)
        time.sleep(1)
</code></pre>
<p>å½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡æœåŠ¡å™¨çº§åˆ«çš„å®šæ—¶ä»»åŠ¡åŠŸèƒ½å®šæ—¶çš„è°ƒç”¨è„šæœ¬åˆ†æ</p>
<h3 id="26-ç»“æœå±•ç¤º">2.6ã€ç»“æœå±•ç¤º</h3>
<p>æŒ‰ç…§å‰é¢çš„æ¼”è¿›è¿‡ç¨‹ï¼Œæœ€ç»ˆçš„ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code>import re
import datetime
import pandas as pd
import xlwt

obj = re.compile(
    r'(?P&lt;ip&gt;.*?)- - \[(?P&lt;time&gt;.*?)\] &quot;(?P&lt;request&gt;.*?)&quot; (?P&lt;status&gt;.*?) (?P&lt;bytes&gt;.*?) &quot;(?P&lt;referer&gt;.*?)&quot; &quot;(?P&lt;ua&gt;.*?)&quot;')


def load_log(path):
    lst = []
    error_lst = []
    i = 0
    with open(path, mode=&quot;r&quot;, encoding=&quot;utf-8&quot;) as f:
        for line in f:
            line = line.strip()
            dic = parse(line)
            if dic:  # æ­£ç¡®çš„æ•°æ®æ·»åŠ åˆ°lståˆ—è¡¨ä¸­
                lst.append(dic)
            else:
                error_lst.append(line)  # è„æ•°æ®æ·»åŠ åˆ°error_lståˆ—è¡¨ä¸­
            i += 1

    return lst, error_lst

def parse(line):
    # è§£æå•è¡Œnginxæ—¥å¿—
    dic = {}
    try:
        result = obj.match(line)
        # ipå¤„ç†
        ip = result.group(&quot;ip&quot;)
        if ip.strip() == '-' or ip.strip() == &quot;&quot;:  # å¦‚æœæ˜¯åŒ¹é…åˆ°æ²¡æœ‰ipå°±æŠŠè¿™æ¡æ•°æ®ä¸¢å¼ƒ
            return False
        dic['ip'] = ip.split(&quot;,&quot;)[0]  # å¦‚æœæœ‰ä¸¤ä¸ªipï¼Œå–ç¬¬ä¸€ä¸ªip

        # çŠ¶æ€ç å¤„ç†
        status = result.group(&quot;status&quot;)  # çŠ¶æ€ç 
        dic['status'] = status

        # æ—¶é—´å¤„ç†
        time = result.group(&quot;time&quot;)  # 21/Dec/2019:21:45:31 +0800
        time = time.replace(&quot; +0800&quot;, &quot;&quot;)  # æ›¿æ¢+0800ä¸ºç©º
        t = datetime.datetime.strptime(time, &quot;%d/%b/%Y:%H:%M:%S&quot;)  # å°†æ—¶é—´æ ¼å¼åŒ–æˆå‹å¥½çš„æ ¼å¼
        dic['time'] = t

        # requestå¤„ç†
        request = result.group(
            &quot;request&quot;)  # GET /post/pou-xi-he-jie-jue-python-zhong-wang-luo-nian-bao-de-zheng-que-zi-shi/ HTTP/1.1
        a = request.split()[1].split(&quot;?&quot;)[0]  # å¾€å¾€urlåé¢ä¼šæœ‰ä¸€äº›å‚æ•°ï¼Œurlå’Œå‚æ•°ä¹‹é—´ç”¨?åˆ†éš”ï¼Œå–å‡ºä¸å¸¦å‚æ•°çš„url
        dic['request'] = a

        # user_agentå¤„ç†
        ua = result.group(&quot;ua&quot;)
        if &quot;Windows NT&quot; in ua:
            u = &quot;windows&quot;
        elif &quot;iPad&quot; in ua:
            u = &quot;ipad&quot;
        elif &quot;Android&quot; in ua:
            u = &quot;android&quot;
        elif &quot;Macintosh&quot; in ua:
            u = &quot;mac&quot;
        elif &quot;iPhone&quot; in ua:
            u = &quot;iphone&quot;
        else:
            u = &quot;å…¶ä»–è®¾å¤‡&quot;
        dic['ua'] = u

        # referå¤„ç†
        referer = result.group(&quot;referer&quot;)
        dic['referer'] = referer

        return dic

    except:
        return False


def analyse(lst): # [{ip:xxx, api:xxx, status:xxxx, ua:xxx}]
    df = pd.DataFrame(lst)  # è½¬æ¢æˆè¡¨æ ¼
    # print(df)
    # print(df['ip'])  # åªå–å‡ºipè¿™ä¸€åˆ—
    ip_count = pd.value_counts(df['ip']).reset_index().rename(columns={&quot;index&quot;: &quot;ip&quot;, &quot;ip&quot;: &quot;count&quot;}).iloc[:20, :]
    request_count = pd.value_counts(df['request']).reset_index().rename(columns={&quot;index&quot;: &quot;request&quot;, &quot;request&quot;: &quot;count&quot;}).iloc[:20, :]
    ua_count = pd.value_counts(df['ua']).reset_index().rename(columns={&quot;index&quot;: &quot;ua&quot;, &quot;ua&quot;: &quot;count&quot;}).iloc[:, :]

    # ä»pandasè½¬åŒ–æˆæˆ‘ä»¬æ™®é€šçš„æ•°æ®
    ip_count_values = ip_count.values
    request_count_values = request_count.values
    ua_count_values = ua_count.values
    # print(type(ip_count_values))

    # å†™å…¥excel
    wb = xlwt.Workbook()  # æ‰“å¼€ä¸€ä¸ªexcelæ–‡æ¡£
    sheet = wb.add_sheet(&quot;ipè®¿é—®top20&quot;)  # æ–°å»ºä¸€ä¸ªsheeté¡µ
    # å†™å…¥å¤´ä¿¡æ¯
    row = 0
    sheet.write(row, 0, &quot;ip&quot;)  # å†™å…¥è¡Œï¼Œåˆ—ï¼Œå†…å®¹
    sheet.write(row, 1, &quot;count&quot;)  # å†™å…¥è¡Œï¼Œåˆ—ï¼Œå†…å®¹
    row += 1  # è¡Œå·åŠ ä¸€
    for item in ip_count_values:
        sheet.write(row, 0, item[0])
        sheet.write(row, 1, item[1])
        row += 1

    sheet = wb.add_sheet(&quot;requestè®¿é—®top20&quot;)  # æ–°å»ºä¸€ä¸ªsheeté¡µ
    # å†™å…¥å¤´ä¿¡æ¯
    row = 0
    sheet.write(row, 0, &quot;request&quot;)  # å†™å…¥è¡Œï¼Œåˆ—ï¼Œå†…å®¹
    sheet.write(row, 1, &quot;count&quot;)  # å†™å…¥è¡Œï¼Œåˆ—ï¼Œå†…å®¹
    row += 1  # è¡Œå·åŠ ä¸€
    for item in request_count_values:
        sheet.write(row, 0, item[0])
        sheet.write(row, 1, item[1])
        row += 1

    sheet = wb.add_sheet(&quot;uaè®¿é—®top&quot;)  # æ–°å»ºä¸€ä¸ªsheeté¡µ
    # å†™å…¥å¤´ä¿¡æ¯
    row = 0
    sheet.write(row, 0, &quot;ua&quot;)  # å†™å…¥è¡Œï¼Œåˆ—ï¼Œå†…å®¹
    sheet.write(row, 1, &quot;count&quot;)  # å†™å…¥è¡Œï¼Œåˆ—ï¼Œå†…å®¹
    row += 1  # è¡Œå·åŠ ä¸€
    for item in ua_count_values:
        sheet.write(row, 0, item[0])
        sheet.write(row, 1, item[1])
        row += 1

    wb.save(&quot;abc.xls&quot;)

if __name__ == '__main__':
    lst, error_lst = load_log(&quot;nginx_access.log&quot;)
    analyse(lst)
</code></pre>
<p>ç”Ÿæˆçš„<code>excel</code>æŠ¥è¡¨å†…å®¹å¦‚ä¸‹</p>
<ul>
<li>
<p><code>ip</code>æ’å<br>
<img src="https://image.ssgeek.com/20191230-01.png" alt=""></p>
</li>
<li>
<p>è®¿é—®åœ°å€æ’å<br>
<img src="https://image.ssgeek.com/20191230-02.png" alt=""></p>
</li>
<li>
<p>å®¢æˆ·ç«¯<code>ua</code>æ’å<br>
<img src="https://image.ssgeek.com/20191230-03.png" alt=""></p>
</li>
</ul>
<h3 id="27-å¯æ‰©å±•æ–¹å‘">2.7ã€å¯æ‰©å±•æ–¹å‘</h3>
<p>æœ¬æ–‡è¿›è¡Œæ—¥å¿—çš„åˆ†æç®—æ˜¯å…¥é—¨ä¹‹ä½œï¼Œå¯ä»¥è¿›ä¸€æ­¥æ‰©å±•çš„æ–¹å‘æ¯”å¦‚ï¼šåˆ†ææŠ¥è¡¨çš„å®šæ—¶æ¶ˆæ¯é‚®ä»¶ç­‰æ¨é€ï¼Œåˆ†ææŠ¥è¡¨çš„å›¾å½¢åŒ–å±•ç¤ºç­‰ç­‰</p>

            </div>
            
              <div class="tag-container">
                
                  <a href="https://www.ssgeek.com/tag/nginx" class="tag">
                    nginx
                  </a>
                
                  <a href="https://www.ssgeek.com/tag/vhKLQmmvn" class="tag">
                    python
                  </a>
                
              </div>
            
            
              <div class="next-post">
                <div class="next">ä¸‹ä¸€ç¯‡</div>
                <a href="https://www.ssgeek.com/post/li-yong-goaccess-shi-shi-fen-xi-web-fu-wu-ri-zhi">
                  <h3 class="post-title">
                    åˆ©ç”¨GoAccesså®æ—¶åˆ†æwebæœåŠ¡æ—¥å¿—
                  </h3>
                </a>
              </div>
            

            
              
                <div id="gitalk-container" data-aos="fade-in"></div>
              

              
            

          </div>

        </div>
      </div>
    </div>

    <script src="https://cdn.bootcdn.net/ajax/libs/aos/2.3.4/aos.js"></script>

<script type="application/javascript">

AOS.init();

hljs.initHighlightingOnLoad()

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>



  
    <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
    <script>

      var gitalk = new Gitalk({
        clientID: '22c870a7f8551b566598',
        clientSecret: '1acfdedd403cdf39c4a6ce932a4a991bb2b32e3a',
        repo: 'hargeek.github.io',
        owner: 'hargeek',
        admin: ['hargeek'],
        id: (location.pathname).substring(0, 49),      // Ensure uniqueness and length less than 50
        distractionFreeMode: false  // Facebook-like distraction free mode
      })

      gitalk.render('gitalk-container')

    </script>
  

  


  </body>
</html>
