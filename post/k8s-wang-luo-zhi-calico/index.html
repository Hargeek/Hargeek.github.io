<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>Kubernetesç½‘ç»œä¹‹Calico | å±±å±±ä»™äººåšå®¢</title>
<meta name="description" content="">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/5.7.2/css/all.css">
<link rel="shortcut icon" href="https://www.ssgeek.com/favicon.ico?v=1655002295372">
<link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://www.ssgeek.com/styles/main.css">


  
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/gitalk/1.6.2/gitalk.css" />
  

  


<script src="https://cdn.bootcdn.net/ajax/libs/vue/2.6.11/vue.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
<script data-ad-client="ca-pub-6775328896166270" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?4b826a92a3dc151a74693fa1942d3167";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

<link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/aos/2.3.4/aos.css" />


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-147397031-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-147397031-1');
</script>


  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://www.ssgeek.com">
        <img src="https://www.ssgeek.com/images/avatar.png?v=1655002295372" class="site-logo">
        <h1 class="site-title">å±±å±±ä»™äººåšå®¢</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="https://www.ssgeek.com" class="site-nav">
            é¦–é¡µ
          </a>
        
      
        
          <a href="https://www.ssgeek.com/archives" class="site-nav">
            å½’æ¡£
          </a>
        
      
        
          <a href="https://www.ssgeek.com/tags" class="site-nav">
            æ ‡ç­¾
          </a>
        
      
        
          <a href="https://www.ssgeek.com/post/about/" class="site-nav">
            å…³äº
          </a>
        
      
        
          <a href="https://www.ssgeek.com/post/gong-zhong-hao/" class="site-nav">
            å…¬ä¼—å·
          </a>
        
      
        
          <a href="https://www.ssgeek.com/post/you-qing-lian-jie/" class="site-nav">
            å‹æƒ…é“¾æ¥
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
          <a class="social-link" href="https://github.com/hargeek" target="_blank">
            <i class="fab fa-github"></i>
          </a>
        
      
        
          <a class="social-link" href="https://twitter.com/anronghong" target="_blank">
            <i class="fab fa-twitter"></i>
          </a>
        
      
        
          <a class="social-link" href="https://weibo.com/u/5717964658" target="_blank">
            <i class="fab fa-weibo"></i>
          </a>
        
      
        
          <a class="social-link" href="https://www.zhihu.com/people/hong-an-rong-46/activities" target="_blank">
            <i class="fab fa-zhihu"></i>
          </a>
        
      
        
          <a class="social-link" href="https://www.facebook.com/profile.php?id=100041470532098" target="_blank">
            <i class="fab fa-facebook"></i>
          </a>
        
      
    </div>
    <div class="site-description">
      
    </div>
    <div class="site-footer">
      <a href="https://beian.miit.gov.cn" style="text-decoration:none;">é„‚ICPå¤‡18007156å·-1</a></br></br>Copyright Â© All Rights Reserved | <a class="rss" href="https://www.ssgeek.com/atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>

      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">Kubernetesç½‘ç»œä¹‹Calico</h2>
            <div class="post-date">2020-06-26</div>
            
            <div class="post-content">
              <p><ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#1-calico%E6%A6%82%E8%BF%B0">1ã€Calicoæ¦‚è¿°</a></li>
<li><a href="#2-calico%E6%9E%B6%E6%9E%84%E5%8F%8Abgp%E5%AE%9E%E7%8E%B0">2ã€Calicoæ¶æ„åŠBGPå®ç°</a></li>
<li><a href="#3-calico%E9%83%A8%E7%BD%B2">3ã€Calicoéƒ¨ç½²</a></li>
<li><a href="#4-calico%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7">4ã€Calicoç®¡ç†å·¥å…·</a></li>
<li><a href="#5-calico-bgp%E6%A8%A1%E5%BC%8F">5ã€Calico BGPæ¨¡å¼</a></li>
<li><a href="#6-calico-route-reflector-%E6%A8%A1%E5%BC%8Frr">6ã€Calico Route Reflector æ¨¡å¼ï¼ˆRRï¼‰</a></li>
<li><a href="#7-calico-ipip%E6%A8%A1%E5%BC%8F">7ã€Calico IPIPæ¨¡å¼</a></li>
<li><a href="#8-calico%E7%BD%91%E7%BB%9C%E7%AD%96%E7%95%A5">8ã€Calicoç½‘ç»œç­–ç•¥</a></li>
</ul>
</li>
</ul>
</p>
<h2 id="1-calicoæ¦‚è¿°">1ã€Calicoæ¦‚è¿°</h2>
<p><code>Calico</code>æ˜¯<code>Kubernetes</code>ç”Ÿæ€ç³»ç»Ÿä¸­å¦ä¸€ç§æµè¡Œçš„ç½‘ç»œé€‰æ‹©ã€‚è™½ç„¶<code>Flannel</code>è¢«å…¬è®¤ä¸ºæ˜¯æœ€ç®€å•çš„é€‰æ‹©ï¼Œä½†<code>Calico</code>ä»¥å…¶æ€§èƒ½ã€çµæ´»æ€§è€Œé—»åã€‚<code>Calico</code>çš„åŠŸèƒ½æ›´ä¸ºå…¨é¢ï¼Œä¸ä»…æä¾›ä¸»æœºå’Œ<code>pod</code>ä¹‹é—´çš„ç½‘ç»œè¿æ¥ï¼Œè¿˜æ¶‰åŠç½‘ç»œå®‰å…¨å’Œç®¡ç†ã€‚<code>Calico CNI</code>æ’ä»¶åœ¨<code>CNI</code>æ¡†æ¶å†…å°è£…äº†<code>Calico</code>çš„åŠŸèƒ½ã€‚</p>
<p><code>Calico</code>æ˜¯ä¸€ä¸ªåŸºäº<code>BGP</code>çš„çº¯ä¸‰å±‚çš„ç½‘ç»œæ–¹æ¡ˆï¼Œä¸<code>OpenStack</code>ã€<code>Kubernetes</code>ã€<code>AWS</code>ã€<code>GCE</code>ç­‰äº‘å¹³å°éƒ½èƒ½å¤Ÿè‰¯å¥½åœ°é›†æˆã€‚<code>Calico</code>åœ¨æ¯ä¸ªè®¡ç®—èŠ‚ç‚¹éƒ½åˆ©ç”¨<code>Linux Kernel</code>å®ç°äº†ä¸€ä¸ªé«˜æ•ˆçš„è™šæ‹Ÿè·¯ç”±å™¨<code>vRouter</code>æ¥è´Ÿè´£æ•°æ®è½¬å‘ã€‚æ¯ä¸ª<code>vRouter</code>éƒ½é€šè¿‡<code>BGP1</code>åè®®æŠŠåœ¨æœ¬èŠ‚ç‚¹ä¸Šè¿è¡Œçš„å®¹å™¨çš„è·¯ç”±ä¿¡æ¯å‘æ•´ä¸ª<code>Calico</code>ç½‘ç»œå¹¿æ’­ï¼Œå¹¶è‡ªåŠ¨è®¾ç½®åˆ°è¾¾å…¶ä»–èŠ‚ç‚¹çš„è·¯ç”±è½¬å‘è§„åˆ™ã€‚<code>Calico</code>ä¿è¯æ‰€æœ‰å®¹å™¨ä¹‹é—´çš„æ•°æ®æµé‡éƒ½æ˜¯é€šè¿‡<code>IP</code>è·¯ç”±çš„æ–¹å¼å®Œæˆäº’è”äº’é€šçš„ã€‚<code>Calico</code>èŠ‚ç‚¹ç»„ç½‘æ—¶å¯ä»¥ç›´æ¥åˆ©ç”¨æ•°æ®ä¸­å¿ƒçš„ç½‘ç»œç»“æ„ï¼ˆL2æˆ–è€…L3ï¼‰ï¼Œä¸éœ€è¦é¢å¤–çš„<code>NAT</code>ã€éš§é“æˆ–è€…<code>Overlay Network</code>ï¼Œæ²¡æœ‰é¢å¤–çš„å°åŒ…è§£åŒ…ï¼Œèƒ½å¤ŸèŠ‚çº¦<code>CPU</code>è¿ç®—ï¼Œæé«˜ç½‘ç»œæ•ˆç‡ã€‚</p>
<figure data-type="image" tabindex="1"><img src="https://image.ssgeek.com/20200626-01.png" alt=""></figure>
<p><code>Calico</code>åœ¨å°è§„æ¨¡é›†ç¾¤ä¸­å¯ä»¥ç›´æ¥äº’è”ï¼Œåœ¨å¤§è§„æ¨¡é›†ç¾¤ä¸­å¯ä»¥é€šè¿‡é¢å¤–çš„<code>BGP route reflector</code>æ¥å®Œæˆã€‚</p>
<figure data-type="image" tabindex="2"><img src="https://image.ssgeek.com/20200626-02.png" alt=""></figure>
<p>æ­¤å¤–ï¼Œ<code>Calico</code>åŸºäº<code>iptables</code>è¿˜æä¾›äº†ä¸°å¯Œçš„ç½‘ç»œç­–ç•¥ï¼Œå®ç°äº†<code>Kubernetes</code>çš„<code>Network Policy</code>ç­–ç•¥ï¼Œæä¾›å®¹å™¨é—´ç½‘ç»œå¯è¾¾æ€§é™åˆ¶çš„åŠŸèƒ½ã€‚</p>
<h2 id="2-calicoæ¶æ„åŠbgpå®ç°">2ã€Calicoæ¶æ„åŠBGPå®ç°</h2>
<p><code>BGP</code>æ˜¯äº’è”ç½‘ä¸Šä¸€ä¸ªæ ¸å¿ƒçš„å»ä¸­å¿ƒåŒ–è‡ªæ²»è·¯ç”±åè®®ï¼Œå®ƒé€šè¿‡ç»´æŠ¤<code>IP</code>è·¯ç”±è¡¨æˆ–â€œå‰ç¼€â€è¡¨æ¥å®ç°è‡ªæ²»ç³»ç»Ÿ<code>AS</code>ä¹‹é—´çš„å¯è¾¾æ€§ï¼Œå±äºçŸ¢é‡è·¯ç”±åè®®ã€‚ä¸è¿‡ï¼Œè€ƒè™‘åˆ°å¹¶éæ‰€æœ‰çš„ç½‘ç»œéƒ½èƒ½æ”¯æŒ<code>BGP</code>ï¼Œä»¥åŠCalicoæ§åˆ¶å¹³é¢çš„è®¾è®¡è¦æ±‚ç‰©ç†ç½‘ç»œå¿…é¡»æ˜¯äºŒå±‚ç½‘ç»œï¼Œä»¥ç¡®ä¿ <code>vRouter</code>é—´å‡ç›´æ¥å¯è¾¾ï¼Œè·¯ç”±ä¸èƒ½å¤Ÿå°†ç‰©ç†è®¾å¤‡å½“ä½œä¸‹ä¸€è·³ç­‰åŸå› ï¼Œä¸ºäº†æ”¯æŒä¸‰å±‚ç½‘ç»œï¼Œ<code>Calico</code>è¿˜æ¨å‡ºäº†<code>IP-in-IP</code>å åŠ çš„æ¨¡å‹ï¼Œå®ƒä¹Ÿä½¿ç”¨Overlayçš„æ–¹å¼æ¥ä¼ è¾“æ•°æ®ã€‚<code>IPIP</code>çš„åŒ…å¤´éå¸¸å°ï¼Œè€Œä¸”ä¹Ÿæ˜¯å†…ç½®åœ¨å†…æ ¸ä¸­ï¼Œå› æ­¤ç†è®ºä¸Šå®ƒçš„é€Ÿåº¦è¦æ¯”<code>VxLAN</code>å¿«ä¸€ç‚¹ ï¼Œä½†å®‰å…¨æ€§æ›´å·®ã€‚<code>Calico 3.x</code>çš„é»˜è®¤é…ç½®ä½¿ç”¨çš„æ˜¯<code>IPIP</code>ç±»å‹çš„ä¼ è¾“æ–¹æ¡ˆè€Œé<code>BGP</code>ã€‚</p>
<p><code>Calico</code>çš„ç³»ç»Ÿæ¶æ„å¦‚å›¾æ‰€ç¤º</p>
<figure data-type="image" tabindex="3"><img src="https://image.ssgeek.com/20200626-03.png" alt=""></figure>
<p><code>Calico</code>ä¸»è¦ç”±<code>Felix</code>ã€<code>Orchestrator Plugin</code>ã€<code>etcd</code>ã€<code>BIRD</code>å’Œ<code>BGP Router Reflector</code>ç­‰ç»„ä»¶ç»„æˆã€‚</p>
<ul>
<li><code>Felix</code>: Calico Agentï¼Œè¿è¡Œäºæ¯ä¸ªèŠ‚ç‚¹ã€‚</li>
<li><code>Orchestrator Plugi</code>ï¼šç¼–æ’ç³»ç»Ÿï¼ˆå¦‚ Kubernetes ã€ OpenStack ç­‰ï¼‰ä»¥å°† <code>Calico</code>æ•´åˆè¿›ç³»ç»Ÿä¸­çš„æ’ä»¶ï¼Œä¾‹å¦‚<code>Kubernetes</code>çš„<code>CNI</code>ã€‚</li>
<li><code>etcd</code>ï¼šæŒä¹…å­˜å‚¨<code>Calico</code>æ•°æ®çš„å­˜å‚¨ç®¡ç†ç³»ç»Ÿã€‚</li>
<li><code>BIRD</code>ï¼šç”¨äºåˆ†å‘è·¯ç”±ä¿¡æ¯çš„<code>BGP</code>å®¢æˆ·ç«¯ã€‚</li>
<li><code>BGP Route Reflector</code>: <code>BGP</code>è·¯ç”±åå°„å™¨ï¼Œå¯é€‰ç»„ä»¶ï¼Œç”¨äºè¾ƒå¤§è§„æ¨¡çš„ç½‘ç»œåœºæ™¯ã€‚</li>
</ul>
<h2 id="3-calicoéƒ¨ç½²">3ã€Calicoéƒ¨ç½²</h2>
<p>åœ¨<code>Kubernetes</code>ä¸­éƒ¨ç½²<code>Calico</code>çš„ä¸»è¦æ­¥éª¤å¦‚ä¸‹:</p>
<ul>
<li>
<p>ä¿®æ”¹<code>Kubernetes</code>æœåŠ¡çš„å¯åŠ¨å‚æ•°ï¼Œå¹¶é‡å¯æœåŠ¡</p>
<ul>
<li>è®¾ç½®Masterä¸Škube-apiserveræœåŠ¡çš„å¯åŠ¨å‚æ•°ï¼š--allowprivileged=trueï¼ˆå› ä¸ºcalico-nodeéœ€è¦ä»¥ç‰¹æƒæ¨¡å¼è¿è¡Œåœ¨å„Nodeä¸Šï¼‰ã€‚</li>
<li>è®¾ç½®å„Nodeä¸ŠkubeletæœåŠ¡çš„å¯åŠ¨å‚æ•°ï¼š--networkplugin=cniï¼ˆä½¿ç”¨CNIç½‘ç»œæ’ä»¶ï¼‰</li>
</ul>
</li>
<li>
<p>åˆ›å»º<code>Calico</code>æœåŠ¡ï¼Œä¸»è¦åŒ…æ‹¬calico-nodeå’Œcalico policy controllerã€‚éœ€è¦åˆ›å»ºçš„èµ„æºå¯¹è±¡å¦‚ä¸‹</p>
<ul>
<li>åˆ›å»ºConfigMap calico-configï¼ŒåŒ…å«Calicoæ‰€éœ€çš„é…ç½®å‚æ•°</li>
<li>åˆ›å»ºSecret calico-etcd-secretsï¼Œç”¨äºä½¿ç”¨TLSæ–¹å¼è¿æ¥etcdã€‚</li>
<li>åœ¨æ¯ä¸ªNodeä¸Šéƒ½è¿è¡Œcalico/nodeå®¹å™¨ï¼Œéƒ¨ç½²ä¸ºDaemonSet</li>
<li>åœ¨æ¯ä¸ªNodeä¸Šéƒ½å®‰è£…Calicoï¼ˆç”±install-cniå®¹å™¨å®Œæˆï¼‰</li>
<li>éƒ¨ç½²ä¸€ä¸ªåä¸ºcalico/kube-policy-controllerçš„Deploymentï¼Œä»¥å¯¹ æ¥Kubernetesé›†ç¾¤ä¸­ä¸ºPodè®¾ç½®çš„Network Policy</li>
</ul>
</li>
</ul>
<p>å…·ä½“éƒ¨ç½²çš„æ­¥éª¤å¦‚ä¸‹<br>
ä¸‹è½½yaml</p>
<pre><code>curl https://docs.projectcalico.org/v3.11/manifests/calico-etcd.yaml -o calico-etcd.yaml
</code></pre>
<p>ä¸‹è½½å®Œåä¿®æ”¹é…ç½®é¡¹</p>
<ul>
<li>é…ç½®è¿æ¥etcdåœ°å€ï¼Œå¦‚æœä½¿ç”¨httpsï¼Œè¿˜éœ€è¦é…ç½®è¯ä¹¦ã€‚ï¼ˆConfigMapï¼ŒSecretï¼‰</li>
</ul>
<pre><code># cat /opt/etcd/ssl/ca.pem | base64 -w 0
LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURlakNDQW1LZ0F3SUJBZ0lVRHQrZ21iYnhzWmoxRGNrbGl3K240MkI5YW5Nd0RRWUpLb1pJaHZjTkFRRUwKQlFBd1F6RUxNQWtHQTFVRUJoTUNRMDR4RURBT0JnTlZCQWdUQjBKbGFXcHBibWN4RURBT0JnTlZCQWNUQjBKbAphV3BwYm1jeEVEQU9CZ05WQkFNVEIyVjBZMlFnUTBFd0hoY05NVGt4TWpBeE1UQXdNREF3V2hjTk1qUXhNVEk1Ck1UQXdNREF3V2pCRE1Rc3dDUVlEVlFRR0V3SkRUakVRTUE0R0ExVUVDQk1IUW1WcGFtbHVaekVRTUE0R0ExVUUKQnhNSFFtVnBhbWx1WnpFUU1BNEdBMVVFQXhNSFpYUmpaQ0JEUVRDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRApnZ0VQQURDQ0FRb0NnZ0VCQUtEaGFsNHFaVG5DUE0ra3hvN3pYT2ZRZEFheGo2R3JVSWFwOGd4MTR4dFhRcnhrCmR0ZmVvUXh0UG5EbDdVdG1ZUkUza2xlYXdDOVhxM0hPZ3J1YkRuQ2ZMRnJZV05DUjFkeG1KZkNFdXU0YmZKeE4KVHNETVF1aUlxcnZ2aVN3QnQ3ZHUzczVTbEJUc2NOV0Y4TWNBMkNLTkVRbzR2Snp5RFZXRTlGTm1kdC8wOEV3UwpmZVNPRmpRV3BWWnprQW1Fc0VRaldtYUVHZjcyUXZvbmRNM2Raejl5M2x0UTgrWnJxOGdaZHRBeWpXQmdrZHB1ClVXZ2NaUTBZWmQ2Q2p4YWUwVzBqVkt5RER4bGlSQ3pLcUFiaUNucW9XYW1DVDR3RUdNU2o0Q0JiYTkwVXc3cTgKajVyekFIVVdMK0dnM2dzdndQcXFnL2JmMTR2TzQ2clRkR1g0Q2hzQ0F3RUFBYU5tTUdRd0RnWURWUjBQQVFILwpCQVFEQWdFR01CSUdBMVVkRXdFQi93UUlNQVlCQWY4Q0FRSXdIUVlEVlIwT0JCWUVGRFJTakhxMm0wVWVFM0JmCks2bDZJUUpPU2Vzck1COEdBMVVkSXdRWU1CYUFGRFJTakhxMm0wVWVFM0JmSzZsNklRSk9TZXNyTUEwR0NTcUcKU0liM0RRRUJDd1VBQTRJQkFRQUsyZXhBY2VhUndIRU9rQXkxbUsyWlhad1Q1ZC9jRXFFMmZCTmROTXpFeFJSbApnZDV0aGwvYlBKWHRSeWt0aEFUdVB2dzBjWVFPM1gwK09QUGJkOHl6dzRsZk5Ka1FBaUlvRUJUZEQvZWdmODFPCmxZOCtrRFhxZ1FZdFZLQm9HSGt5K2xRNEw4UUdOVEdaeWIvU3J5N0g3VXVDcTN0UmhzR2E4WGQ2YTNIeHJKYUsKTWZna1ZsNDA0bW83QXlWUHl0eHMrNmpLWCtJSmd3a2dHcG9DOXA2cDMyZDI1Q0NJelEweDRiZCtqejQzNXY1VApvRldBUmcySGdiTTR0aHdhRm1VRDcrbHdqVHpMczMreFN3Tys0S3Bmc2tScTR5dEEydUdNRDRqUTd0bnpoNi8wCkhQRkx6N0FGazRHRXoxaTNmMEtVTThEUlhwS0JKUXZNYzk4a3IrK24KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=
# cat /opt/etcd/ssl/server-key.pem | base64 -w 0        
LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb2dJQkFBS0NBUUVBdUZJdlNWNndHTTROZURqZktSWDgzWEVTWHhDVERvSVdpcFVJQmVTL3JnTHBFek10Cmk3enp6SjRyUGplbElJZ2ZRdVJHMHdJVXNzN3FDOVhpa3JGcEdnNXp5d2dMNmREZE9KNkUxcUIrUWprbk85ZzgKalRaenc3cWwxSitVOExNZ0k3TWNCU2VtWVo0TUFSTmd6Z09xd2x2WkVBMnUvNFh5azdBdUJYWFgrUTI2SitLVApYVEJ4MnBHOXoxdnVmU0xzMG52YzdKY2gxT2lLZ2R2UHBqSktPQjNMTm83ZnJXMWlaenprTExWSjlEV3U1NFdMCk4rVE5GZWZCK1lBTTdlSHVHTjdHSTJKdW1YL3hKczc3dnQzRjF2VStYSitzVTZ3cmRGMStULzVyamNUN1dDdmgKbkZVWlBxTk9NWUZTWUdlOVBIY1l0Y1Y1MENnUVV2NUx2OTE1elFJREFRQUJBb0lCQUY1YkRBUG1LZ1Y0cmVLRwpVbzhJeDNwZ29NUHppeVJaS2NybGdjYnFrOGt6aWpjZThzamZBSHNWMlJNdmp5TjVLMitseGkvTWwrWDFFRkRnCnUreldUdlJjdzZBQ3pYNXpRbHZ5b2hQdzh0Rlp5cURURUNSRjVMc2t1REdCUTlCNEVoTFVaSnFxOG54MFdMYlEKUWJVVW9YeC9ZajNhazJRUklOM0R5YnRYMlNpUHBPN1hVMmFiVkNzYkZBWW1uN2lweW16M25WWFRseDJuVk1sZQpmYzhXbERsd09pL3FJUThwZjNpRnowRDVoUGl5ZDY5eXp2b2ZrVk5CbCtodGFPbGdwdVNqSEFrNnhIcFpBUExTCkIxclVJaDk1RWozTUk5U3BuSnNWcUFFVHFSSmpYOHl3bFZYa2dvd3I2TXJuTnVXelRZUnlSNDY5UFVmKzhaSzQKUjE1WTdvMENnWUVBM21HdjErSmRuSkVrL1R4M2ZaMkFmOWJIazJ1dE5FemxUakN5YlZtYkxKamx0M1pjSG96UgphZVR2azJSQ0Q4VDU0NU9EWmIzS3Zxdzg2TXkxQW9lWmpqV3pTR1VIVHZJYTRDQ3lMenBXaVNaQkRHSE9KbDBtCk9nbnRRclFPK0UwZjNXOHZtbkp0NGoySGxMWHByL1R6Zk12R05lTWVkSUlIMC8xZXV0WkJjNnNDZ1lFQTFDK0gKaDVtQ0pnbllNcm5zK3dZZ2lWVTJFdjZmRUc2VGl2QU5XUUlldVpHcDRoclZISXc0UTV3SHhZNWgrNE15bXFORAprMmVDYU15RjFxb1NCS1hOckFZS3RtWCtxR3ltaVBpWlRJWEltZlppcENocWl3dm1udjMxbWE1Njk2NkZ6SjdaCjJTLzZkTGtweWI2OTUxRTl5azRBOEYzNVdQRlY4M01DanJ1bjBHY0NnWUFoOFVFWXIybGdZMXNFOS95NUJKZy8KYXZYdFQyc1JaNGM4WnZ4azZsOWY4RHBueFQ0TVA2d2JBS0Y4bXJubWxFY2I4RUVHLzIvNXFHcG5rZzh5d3FXeQphZ25pUytGUXNHMWZ0ajNjTFloVnlLdjNDdHFmU21weVExK2VaY00vTE81bkt2aFdGNDhrRUFZb3NaZG9qdmUzCkhaYzBWR1VxblVvNmxocW1ZOXQ3bndLQmdGbFFVRm9Sa2FqMVI5M0NTVEE0bWdWMHFyaEFHVEJQZXlkbWVCZloKUHBtWjZNcFZ4UktwS3gyNlZjTWdkYm5xdGFoRnhMSU5SZVZiQVpNa0wwVnBqVE0xcjlpckFoQmUrNUo0SWY4Rgo2VFIxYzN2cHp6OE1HVjBmUlB3Vlo0bE9HdC9RbFo1SUJjS1FGampuWXdRMVBDOGx1bHR6RXZ3UFNjQ1p6cC9KCitZOU5Bb0dBVkpybjl4QmZhYWF5T3BlMHFTTjNGVzRlaEZyaTFaRUYvVHZqS3lnMnJGUng3VDRhY1dNWWdSK20KL2RsYU9CRFN6bjNheVVXNlBwSnN1UTBFanpIajFNSVFtV3JOQXNGSVJiN0Z6YzdhaVQzMFZmNFFYUmMwQUloLwpXNHk0OW5wNWNDWUZ5SXRSWEhXMUk5bkZPSjViQjF2b1pYTWNMK1dyMVZVa2FuVlIvNEE9Ci0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0tCg==
# cat /opt/etcd/ssl/server.pem | base64 -w 0
LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURyekNDQXBlZ0F3SUJBZ0lVZUFZTHdLMkxVdnE0V2ZiSG92cTlzVS8rWlJ3d0RRWUpLb1pJaHZjTkFRRUwKQlFBd1F6RUxNQWtHQTFVRUJoTUNRMDR4RURBT0JnTlZCQWdUQjBKbGFXcHBibWN4RURBT0JnTlZCQWNUQjBKbAphV3BwYm1jeEVEQU9CZ05WQkFNVEIyVjBZMlFnUTBFd0hoY05NVGt4TWpBeE1UQXdNREF3V2hjTk1qa3hNVEk0Ck1UQXdNREF3V2pCQU1Rc3dDUVlEVlFRR0V3SkRUakVRTUE0R0ExVUVDQk1IUW1WcFNtbHVaekVRTUE0R0ExVUUKQnhNSFFtVnBTbWx1WnpFTk1Bc0dBMVVFQXhNRVpYUmpaRENDQVNJd0RRWUpLb1pJaHZjTkFRRUJCUUFEZ2dFUApBRENDQVFvQ2dnRUJBTGhTTDBsZXNCak9EWGc0M3lrVi9OMXhFbDhRa3c2Q0ZvcVZDQVhrdjY0QzZSTXpMWXU4Cjg4eWVLejQzcFNDSUgwTGtSdE1DRkxMTzZndlY0cEt4YVJvT2M4c0lDK25RM1RpZWhOYWdma0k1Snp2WVBJMDIKYzhPNnBkU2ZsUEN6SUNPekhBVW5wbUdlREFFVFlNNERxc0piMlJBTnJ2K0Y4cE93TGdWMTEva051aWZpazEwdwpjZHFSdmM5YjduMGk3Tko3M095WElkVG9pb0hiejZZeVNqZ2R5emFPMzYxdFltYzg1Q3kxU2ZRMXJ1ZUZpemZrCnpSWG53Zm1BRE8zaDdoamV4aU5pYnBsLzhTYk8rNzdkeGRiMVBseWZyRk9zSzNSZGZrLythNDNFKzFncjRaeFYKR1Q2alRqR0JVbUJudlR4M0dMWEZlZEFvRUZMK1M3L2RlYzBDQXdFQUFhT0JuVENCbWpBT0JnTlZIUThCQWY4RQpCQU1DQmFBd0hRWURWUjBsQkJZd0ZBWUlLd1lCQlFVSEF3RUdDQ3NHQVFVRkJ3TUNNQXdHQTFVZEV3RUIvd1FDCk1BQXdIUVlEVlIwT0JCWUVGTHNKb2pPRUZGcGVEdEhFSTBZOEZIUjQvV0c4TUI4R0ExVWRJd1FZTUJhQUZEUlMKakhxMm0wVWVFM0JmSzZsNklRSk9TZXNyTUJzR0ExVWRFUVFVTUJLSEJNQ29BajJIQk1Db0FqNkhCTUNvQWo4dwpEUVlKS29aSWh2Y05BUUVMQlFBRGdnRUJBQzVOSlh6QTQvTStFRjFHNXBsc2luSC9sTjlWWDlqK1FHdU0wRWZrCjhmQnh3bmV1ZzNBM2l4OGxXQkhZTCtCZ0VySWNsc21ZVXpJWFJXd0h4ZklKV2x1Ukx5NEk3OHB4bDBaVTZWUTYKalFiQVI2YzhrK0FhbGxBTUJUTkphY3lTWkV4MVp2c3BVTUJUU0l3bmk5RFFDUDJIQStDNG5mdHEwMGRvckQwcgp5OXVDZ3dnSDFrOG42TkdSZ0lJbVl6dFlZZmZHbEQ3R3lybEM1N0plSkFFbElUaElEMks1Y090M2dUb2JiNk5oCk9pSWpNWVAwYzRKL1FTTHNMNjZZRTh5YnhvZ2M2L3JTYzBIblladkNZbXc5MFZxY05oU3hkT2liaWtPUy9SdDAKZHVRSnU3cmdkM3pldys3Y05CaTIwTFZrbzc3dDNRZWRZK0c3dUxVZ21qNWJudkU9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
</code></pre>
<p>å°†ä¸Šè¿°<code>base64</code>åŠ å¯†çš„å­—ç¬¦ä¸²ä¿®æ”¹è‡³æ–‡ä»¶ä¸­å£°æ˜ï¼š<code>ca.pem</code>å¯¹åº”<code>etcd-ca</code>ã€<code>server-key.pem</code>å¯¹åº”<code>etcd-key</code>ã€<code>server.pem</code>å¯¹åº”<code>etcd-cert</code>ï¼›ä¿®æ”¹<code>etcd</code>è¯ä¹¦çš„ä½ç½®ï¼›ä¿®æ”¹<code>etcd</code>çš„è¿æ¥åœ°å€(ä¸api-serverä¸­é…ç½®/opt/kubernetes/cfg/kube-apiserver.confä¸­ç›¸åŒ)</p>
<pre><code># vim calico-etcd.yaml
...
apiVersion: v1
kind: Secret
type: Opaque
metadata:
  name: calico-etcd-secrets
  namespace: kube-system
data:
  # Populate the following with etcd TLS configuration if desired, but leave blank if
  # not using TLS for etcd.
  # The keys below should be uncommented and the values populated with the base64
  # encoded contents of each file that would be associated with the TLS data.
  # Example command for encoding a file contents: cat &lt;file&gt; | base64 -w 0
  etcd-key: å¡«å†™ä¸Šé¢çš„åŠ å¯†å­—ç¬¦ä¸²
  etcd-cert: å¡«å†™ä¸Šé¢çš„åŠ å¯†å­—ç¬¦ä¸²
  etcd-ca: å¡«å†™ä¸Šé¢çš„åŠ å¯†å­—ç¬¦ä¸²
...
kind: ConfigMap
apiVersion: v1
metadata:
  name: calico-config
  namespace: kube-system
data:
  # Configure this with the location of your etcd cluster.
  etcd_endpoints: &quot;https://192.168.2.61:2379,https://192.168.2.62:2379,https://192.168.2.63:2379&quot;
  # If you're using TLS enabled etcd uncomment the following.
  # You must also populate the Secret below with these files.
  etcd_ca: &quot;/calico-secrets/etcd-ca&quot;
  etcd_cert: &quot;/calico-secrets/etcd-cert&quot;
  etcd_key: &quot;/calico-secrets/etcd-key&quot;
</code></pre>
<p>æ ¹æ®å®é™…ç½‘ç»œè§„åˆ’ä¿®æ”¹Pod CIDRï¼ˆCALICO_IPV4POOL_CIDRï¼‰,ä¸controller-manageré…ç½®/opt/kubernetes/cfg/kube-controller-manager.confä¸­ç›¸åŒ</p>
<pre><code># vim calico-etcd.yaml
...
320             - name: CALICO_IPV4POOL_CIDR
321               value: &quot;10.244.0.0/16&quot;
...
</code></pre>
<p>é€‰æ‹©å·¥ä½œæ¨¡å¼ï¼ˆCALICO_IPV4POOL_IPIPï¼‰ï¼Œæ”¯æŒBGPï¼ŒIPIPï¼Œæ­¤å¤„å…ˆå…³é—­IPIPæ¨¡å¼</p>
<pre><code># vim calico-etcd.yaml
...
309             - name: CALICO_IPV4POOL_IPIP
310               value: &quot;Never&quot;
...
</code></pre>
<p>ä¿®æ”¹å®Œååº”ç”¨æ¸…å•</p>
<pre><code># kubectl apply -f calico-etcd.yaml 
secret/calico-etcd-secrets created
configmap/calico-config created
clusterrole.rbac.authorization.k8s.io/calico-kube-controllers created
clusterrolebinding.rbac.authorization.k8s.io/calico-kube-controllers created
clusterrole.rbac.authorization.k8s.io/calico-node created
clusterrolebinding.rbac.authorization.k8s.io/calico-node created
daemonset.apps/calico-node created
serviceaccount/calico-node created
deployment.apps/calico-kube-controllers created
serviceaccount/calico-kube-controllers created
# kubectl get pods -n kube-system
</code></pre>
<p>å¦‚æœäº‹å…ˆéƒ¨ç½²äº†<code>fannel</code>ç½‘ç»œç»„ä»¶ï¼Œéœ€è¦å…ˆå¸è½½å’Œåˆ é™¤<code>flannel</code>ï¼Œåœ¨æ¯ä¸ªèŠ‚ç‚¹å‡éœ€è¦æ“ä½œ</p>
<pre><code># kubectl delete -f kube-flannel.yaml
# ip link delete cni0
# ip link delete flannel.1
# ip route 
default via 192.168.2.2 dev eth0 
10.244.1.0/24 via 192.168.2.63 dev eth0 
10.244.2.0/24 via 192.168.2.62 dev eth0 
169.254.0.0/16 dev eth0 scope link metric 1002 
172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1 
192.168.2.0/24 dev eth0 proto kernel scope link src 192.168.2.61 
# ip route del 10.244.1.0/24 via 192.168.2.63 dev eth0 
# ip route del 10.244.2.0/24 via 192.168.2.62 dev eth0
# ip route 
default via 192.168.2.2 dev eth0 
169.254.0.0/16 dev eth0 scope link metric 1002 
172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1 
192.168.2.0/24 dev eth0 proto kernel scope link src 192.168.2.61
</code></pre>
<h2 id="4-calicoç®¡ç†å·¥å…·">4ã€Calicoç®¡ç†å·¥å…·</h2>
<p>ä¸‹è½½å·¥å…·ï¼šhttps://github.com/projectcalico/calicoctl/releases</p>
<pre><code># wget -O /usr/local/bin/calicoctl https://github.com/projectcalico/calicoctl/releases/download/v3.11.1/calicoctl
# chmod +x /usr/local/bin/calicoctl
</code></pre>
<p>ä½¿ç”¨<code>calicoctl</code>æŸ¥çœ‹æœåŠ¡çŠ¶æ€</p>
<pre><code># ./calicoctl node status
Calico process is running.

IPv4 BGP status
+--------------+-------------------+-------+----------+-------------+
| PEER ADDRESS |     PEER TYPE     | STATE |  SINCE   |    INFO     |
+--------------+-------------------+-------+----------+-------------+
| 192.168.2.62 | node-to-node mesh | up    | 02:58:05 | Established |
| 192.168.2.63 | node-to-node mesh | up    | 03:08:46 | Established |
+--------------+-------------------+-------+----------+-------------+

IPv6 BGP status
No IPv6 peers found.
</code></pre>
<p>å®é™…ä¸Šï¼Œä½¿ç”¨<code>calicoctl</code>æŸ¥çœ‹<code>node</code>çŠ¶æ€å°±æ˜¯è°ƒç”¨ç³»ç»ŸæŸ¥çœ‹çš„ï¼Œä¸<code>netstat</code>æ•ˆæœä¸€æ ·</p>
<pre><code># netstat -antp|grep bird  
tcp        0      0 0.0.0.0:179             0.0.0.0:*               LISTEN      62709/bird          
tcp        0      0 192.168.2.61:179        192.168.2.63:58963      ESTABLISHED 62709/bird          
tcp        0      0 192.168.2.61:179        192.168.2.62:37390      ESTABLISHED 62709/bird
</code></pre>
<p>æƒ³è¦æŸ¥çœ‹æ›´å¤šçš„ä¿¡æ¯ï¼Œéœ€è¦æŒ‡å®šé…ç½®æŸ¥çœ‹<code>etcd</code>ä¸­çš„æ•°æ®<br>
åˆ›å»ºé…ç½®æ–‡ä»¶</p>
<pre><code># mkdir /etc/calico
# vim /etc/calico/calicoctl.cfg  
apiVersion: projectcalico.org/v3
kind: CalicoAPIConfig
metadata:
spec:
  datastoreType: &quot;etcdv3&quot;
  etcdEndpoints: &quot;https://192.168.2.61:2379,https://192.168.2.62:2379,https://192.168.2.63:2379&quot;
  etcdKeyFile: &quot;/opt/etcd/ssl/server-key.pem&quot;
  etcdCertFile: &quot;/opt/etcd/ssl/server.pem&quot;
  etcdCACertFile: &quot;/opt/etcd/ssl/ca.pem&quot;
</code></pre>
<p>æŸ¥çœ‹æ•°æ®ç­‰æ“ä½œ</p>
<pre><code># calicoctl get node
NAME            
k8s-master-01   
k8s-node-01     
k8s-node-02 
</code></pre>
<p>æŸ¥çœ‹IPAMçš„IPåœ°å€æ± ï¼š</p>
<pre><code># ./calicoctl get ippool
NAME                  CIDR            SELECTOR   
default-ipv4-ippool   10.244.0.0/16   all()      

# ./calicoctl get ippool -o wide
NAME                  CIDR            NAT    IPIPMODE   VXLANMODE   DISABLED   SELECTOR   
default-ipv4-ippool   10.244.0.0/16   true   Never      Never       false      all()
</code></pre>
<h2 id="5-calico-bgpæ¨¡å¼">5ã€Calico BGPæ¨¡å¼</h2>
<figure data-type="image" tabindex="4"><img src="https://image.ssgeek.com/20200626-04.png" alt=""></figure>
<p><code>Pod 1</code>è®¿é—®<code>Pod 2</code>å¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>
<p>æ•°æ®åŒ…ä»å®¹å™¨1å‡ºåˆ°è¾¾<code>Veth Pair</code>å¦ä¸€ç«¯ï¼ˆå®¿ä¸»æœºä¸Šï¼Œä»¥<code>cali</code>å‰ç¼€å¼€å¤´ï¼‰ï¼›</p>
</li>
<li>
<p>å®¿ä¸»æœºæ ¹æ®è·¯ç”±è§„åˆ™ï¼Œå°†æ•°æ®åŒ…è½¬å‘ç»™ä¸‹ä¸€è·³ï¼ˆç½‘å…³ï¼‰ï¼›</p>
</li>
<li>
<p>åˆ°è¾¾<code>Node2</code>ï¼Œæ ¹æ®è·¯ç”±è§„åˆ™å°†æ•°æ®åŒ…è½¬å‘ç»™<code>cali</code>è®¾å¤‡ï¼Œä»è€Œåˆ°è¾¾å®¹å™¨2ã€‚</p>
</li>
</ol>
<p>è·¯ç”±è¡¨ï¼š</p>
<pre><code># node1
10.244.36.65 dev cali4f18ce2c9a1 scope link 
10.244.169.128/26 via 192.168.31.63 dev ens33 proto bird 
10.244.235.192/26 via 192.168.31.61 dev ens33 proto bird 
# node2
10.244.169.129 dev calia4d5b2258bb scope link 
10.244.36.64/26 via 192.168.31.62 dev ens33 proto bird
10.244.235.192/26 via 192.168.31.61 dev ens33 proto bird 
</code></pre>
<p>å…¶ä¸­ï¼Œè¿™é‡Œæœ€æ ¸å¿ƒçš„â€œä¸‹ä¸€è·³â€è·¯ç”±è§„åˆ™ï¼Œå°±æ˜¯ç”±<code>Calico</code>çš„<code>Felix</code>è¿›ç¨‹è´Ÿè´£ç»´æŠ¤çš„ã€‚è¿™äº›è·¯ç”±è§„åˆ™ä¿¡æ¯ï¼Œåˆ™æ˜¯é€šè¿‡<code>BGP Client</code>ä¹Ÿå°±æ˜¯<code>BIRD</code>ç»„ä»¶ï¼Œä½¿ç”¨<code>BGP</code>åè®®ä¼ è¾“è€Œæ¥çš„ã€‚</p>
<p>ä¸éš¾å‘ç°ï¼Œ<code>Calico</code>é¡¹ç›®å®é™…ä¸Šå°†é›†ç¾¤é‡Œçš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œéƒ½å½“ä½œæ˜¯è¾¹ç•Œè·¯ç”±å™¨æ¥å¤„ç†ï¼Œå®ƒä»¬ä¸€èµ·ç»„æˆäº†ä¸€ä¸ªå…¨è¿é€šçš„ç½‘ç»œï¼Œäº’ç›¸ä¹‹é—´é€šè¿‡<code>BGP</code>åè®®äº¤æ¢è·¯ç”±è§„åˆ™ã€‚è¿™äº›èŠ‚ç‚¹ï¼Œæˆ‘ä»¬ç§°ä¸º<code>BGP Peer</code>ã€‚</p>
<p>calicoç›¸å…³æ–‡ä»¶</p>
<pre><code># ls /opt/cni/bin/calico-ipam 
/opt/cni/bin/calico-ipam
# cat /etc/cni/net.d/
10-calico.conflist  calico-kubeconfig    calico-tls/          
# cat /etc/cni/net.d/10-calico.conflist 
{
  &quot;name&quot;: &quot;k8s-pod-network&quot;,
  &quot;cniVersion&quot;: &quot;0.3.1&quot;,
  &quot;plugins&quot;: [
    {
      &quot;type&quot;: &quot;calico&quot;,
      &quot;log_level&quot;: &quot;info&quot;,
      &quot;etcd_endpoints&quot;: &quot;https://192.168.2.61:2379,https://192.168.2.62:2379,https://192.168.2.63:2379&quot;,
      &quot;etcd_key_file&quot;: &quot;/etc/cni/net.d/calico-tls/etcd-key&quot;,
      &quot;etcd_cert_file&quot;: &quot;/etc/cni/net.d/calico-tls/etcd-cert&quot;,
      &quot;etcd_ca_cert_file&quot;: &quot;/etc/cni/net.d/calico-tls/etcd-ca&quot;,
      &quot;mtu&quot;: 1440,
      &quot;ipam&quot;: {
          &quot;type&quot;: &quot;calico-ipam&quot;
      },
      &quot;policy&quot;: {
          &quot;type&quot;: &quot;k8s&quot;
      },
      &quot;kubernetes&quot;: {
          &quot;kubeconfig&quot;: &quot;/etc/cni/net.d/calico-kubeconfig&quot;
      }
    },
    {
      &quot;type&quot;: &quot;portmap&quot;,
      &quot;snat&quot;: true,
      &quot;capabilities&quot;: {&quot;portMappings&quot;: true}
    }
  ]
}
</code></pre>
<h2 id="6-calico-route-reflector-æ¨¡å¼rr">6ã€Calico Route Reflector æ¨¡å¼ï¼ˆRRï¼‰</h2>
<p>https://docs.projectcalico.org/master/networking/bgp</p>
<p><code>Calico</code>ç»´æŠ¤çš„ç½‘ç»œåœ¨é»˜è®¤æ˜¯ï¼ˆNode-to-Node Meshï¼‰å…¨äº’è”æ¨¡å¼ï¼Œ<code>Calico</code>é›†ç¾¤ä¸­çš„èŠ‚ç‚¹ä¹‹é—´éƒ½ä¼šç›¸äº’å»ºç«‹è¿æ¥ï¼Œç”¨äºè·¯ç”±äº¤æ¢ã€‚ä½†æ˜¯éšç€é›†ç¾¤è§„æ¨¡çš„æ‰©å¤§ï¼Œ<code>mesh</code>æ¨¡å¼å°†å½¢æˆä¸€ä¸ªå·¨å¤§æœåŠ¡ç½‘æ ¼ï¼Œè¿æ¥æ•°æˆå€å¢åŠ ã€‚</p>
<p>è¿™æ—¶å°±éœ€è¦ä½¿ç”¨<code>Route Reflector</code>ï¼ˆè·¯ç”±å™¨åå°„ï¼‰æ¨¡å¼è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<p>ç¡®å®šä¸€ä¸ªæˆ–å¤šä¸ª<code>Calico</code>èŠ‚ç‚¹å……å½“è·¯ç”±åå°„å™¨ï¼ˆä¸€èˆ¬é…ç½®ä¸¤ä¸ªä»¥ä¸Šï¼‰ï¼Œè®©å…¶ä»–èŠ‚ç‚¹ä»è¿™ä¸ª<code>RR</code>èŠ‚ç‚¹è·å–è·¯ç”±ä¿¡æ¯ã€‚</p>
<p>å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<p><strong>1ã€å…³é—­ node-to-node BGPç½‘æ ¼</strong></p>
<p>é»˜è®¤<code>node to node</code>æ¨¡å¼æœ€å¥½åœ¨100ä¸ªèŠ‚ç‚¹ä»¥ä¸‹<br>
æ·»åŠ <code>default BGP</code>é…ç½®ï¼Œè°ƒæ•´<code>nodeToNodeMeshEnabled</code>å’Œ<code>asNumber</code>ï¼šbgp.yaml</p>
<pre><code># cat &lt;&lt; EOF | calicoctl create -f -
apiVersion: projectcalico.org/v3
kind: BGPConfiguration
metadata:
  name: default
spec:
  logSeverityScreen: Info
  nodeToNodeMeshEnabled: false  
  asNumber: 63400
EOF
# calicoctl apply -f bgp.yaml  # ä¸€æ—¦æ‰§è¡Œï¼Œé›†ç¾¤ä¼šç«‹å³æ–­ç½‘
Successfully applied 1 'BGPConfiguration' resource(s)
# calicoctl get bgpconfig
NAME      LOGSEVERITY   MESHENABLED   ASNUMBER   
default   Info          false         63400
# calicoctl node status
Calico process is running.

IPv4 BGP status
No IPv4 peers found.

IPv6 BGP status
No IPv6 peers found.
</code></pre>
<p>ASNå·å¯ä»¥é€šè¿‡è·å–</p>
<pre><code># calicoctl get nodes --output=wide  
NAME            ASN       IPV4              IPV6   
k8s-master-01   (63400)   192.168.2.61/24          
k8s-node-01     (63400)   192.168.2.62/24          
k8s-node-02     (63400)   192.168.2.63/24 
</code></pre>
<p><strong>2ã€é…ç½®æŒ‡å®šèŠ‚ç‚¹å……å½“è·¯ç”±åå°„å™¨</strong></p>
<p>ä¸ºæ–¹ä¾¿è®©<code>BGPPeer</code>è½»æ¾é€‰æ‹©èŠ‚ç‚¹ï¼Œé€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨åŒ¹é…ã€‚</p>
<p>ç»™è·¯ç”±å™¨åå°„å™¨èŠ‚ç‚¹æ‰“æ ‡ç­¾ï¼š<br>
å¢åŠ ç¬¬äºŒä¸ªè·¯ç”±åå°„å™¨æ—¶ï¼Œç»™æ–°çš„<code>node</code>æ‰“æ ‡ç­¾å¹¶é…ç½®æˆåå°„å™¨èŠ‚ç‚¹å³å¯</p>
<pre><code># kubectl label node k8s-node-02 route-reflector=true
node/k8s-node-02 labeled
</code></pre>
<p>ç„¶åé…ç½®è·¯ç”±å™¨åå°„å™¨èŠ‚ç‚¹<code>routeReflectorClusterID</code>ï¼š</p>
<pre><code># calicoctl get nodes k8s-node-02 -o yaml&gt; node.yaml
# vim node.yaml
apiVersion: projectcalico.org/v3
kind: Node
metadata:
  annotations:
    projectcalico.org/kube-labels: '{&quot;beta.kubernetes.io/arch&quot;:&quot;amd64&quot;,&quot;beta.kubernetes.io/os&quot;:&quot;linux&quot;,&quot;kubernetes.io/arch&quot;:&quot;amd64&quot;,&quot;kubernetes.io/hostname&quot;:&quot;k8s-node2&quot;,&quot;kubernetes.io/os&quot;:&quot;linux&quot;}'
  creationTimestamp: null
  labels:
    beta.kubernetes.io/arch: amd64
    beta.kubernetes.io/os: linux
    kubernetes.io/arch: amd64
    kubernetes.io/hostname: k8s-node2
    kubernetes.io/os: linux
  name: k8s-node2
spec:
  bgp:
    ipv4Address: 192.168.31.63/24
    routeReflectorClusterID: 244.0.0.1   # å¢åŠ é›†ç¾¤ID
  orchRefs:
  - nodeName: k8s-node2
    orchestrator: k8s
# ./calicoctl apply -f node.yaml 
Successfully applied 1 'Node' resource(s)
</code></pre>
<p>ç°åœ¨ï¼Œå¾ˆå®¹æ˜“ä½¿ç”¨æ ‡ç­¾é€‰æ‹©å™¨å°†è·¯ç”±åå°„å™¨èŠ‚ç‚¹ä¸å…¶ä»–éè·¯ç”±åå°„å™¨èŠ‚ç‚¹é…ç½®ä¸ºå¯¹ç­‰ï¼š</p>
<p>è¡¨ç¤ºæ‰€æœ‰èŠ‚ç‚¹éƒ½è¿æ¥è·¯ç”±åå°„å™¨èŠ‚ç‚¹</p>
<pre><code># vim peer-with-route-reflectors.yaml
apiVersion: projectcalico.org/v3
kind: BGPPeer
metadata:
  name: peer-with-route-reflectors
spec:
  nodeSelector: all()
  peerSelector: route-reflector == 'true'
# calicoctl apply -f peer-with-route-reflectors.yaml
Successfully applied 1 'BGPPeer' resource(s)
# calicoctl get bgppeer
NAME                         PEERIP   NODE    ASN   
peer-with-route-reflectors            all()   0 
</code></pre>
<p>æŸ¥çœ‹èŠ‚ç‚¹çš„<code>BGP</code>è¿æ¥çŠ¶æ€ï¼Œåªæœ‰æœ¬èŠ‚ç‚¹ä¸è·¯ç”±åå°„å™¨èŠ‚ç‚¹çš„è¿æ¥ï¼š</p>
<pre><code># calicoctl node status                             
Calico process is running.

IPv4 BGP status
+--------------+---------------+-------+----------+-------------+
| PEER ADDRESS |   PEER TYPE   | STATE |  SINCE   |    INFO     |
+--------------+---------------+-------+----------+-------------+
| 192.168.2.63 | node specific | up    | 04:17:14 | Established |
+--------------+---------------+-------+----------+-------------+

IPv6 BGP status
No IPv6 peers found.
</code></pre>
<h2 id="7-calico-ipipæ¨¡å¼">7ã€Calico IPIPæ¨¡å¼</h2>
<p><code>Flannel host-gw</code>æ¨¡å¼æœ€ä¸»è¦çš„é™åˆ¶ï¼Œå°±æ˜¯è¦æ±‚é›†ç¾¤å®¿ä¸»æœºä¹‹é—´æ˜¯äºŒå±‚è¿é€šçš„ã€‚è€Œè¿™ä¸ªé™åˆ¶å¯¹äº<code>Calico</code>æ¥è¯´ï¼Œä¹ŸåŒæ ·å­˜åœ¨ã€‚</p>
<p>ä¿®æ”¹ä¸º<code>IPIP</code>æ¨¡å¼ï¼š<br>
ä¹Ÿå¯ä»¥ç›´æ¥åœ¨éƒ¨ç½²<code>calico</code>çš„æ—¶å€™ç›´æ¥ä¿®æ”¹</p>
<pre><code># calicoctl get ipPool -o yaml &gt; ipip.yaml
# vi ipip.yaml
apiVersion: projectcalico.org/v3
kind: IPPool
metadata:
  name: default-ipv4-ippool
spec:
  blockSize: 26
  cidr: 10.244.0.0/16
  ipipMode: Always  # å¯åŠ¨ipipæ¨¡å¼
  natOutgoing: true

# calicoctl apply -f ipip.yaml
# calicoctl get ippool -o wide
NAME                  CIDR            NAT    IPIPMODE   VXLANMODE   DISABLED   SELECTOR   
default-ipv4-ippool   10.244.0.0/16   true   Always     Never       false      all()
# ip route # ä¼šå¢åŠ tunl0ç½‘å¡
default via 192.168.2.2 dev eth0 
10.244.44.192/26 via 192.168.2.63 dev tunl0 proto bird onlink 
blackhole 10.244.151.128/26 proto bird 
10.244.154.192/26 via 192.168.2.62 dev tunl0 proto bird onlink 
169.254.0.0/16 dev eth0 scope link metric 1002 
172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1 
192.168.2.0/24 dev eth0 proto kernel scope link src 192.168.2.61
</code></pre>
<p>IPIPç¤ºæ„å›¾ï¼š</p>
<figure data-type="image" tabindex="5"><img src="https://image.ssgeek.com/20200626-05.png" alt=""></figure>
<p><code>Pod 1</code>è®¿é—®<code>Pod 2</code>å¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>æ•°æ®åŒ…ä»å®¹å™¨1å‡ºåˆ°è¾¾<code>Veth Pair</code>å¦ä¸€ç«¯ï¼ˆå®¿ä¸»æœºä¸Šï¼Œä»¥<code>cali</code>å‰ç¼€å¼€å¤´ï¼‰ï¼›</li>
<li>è¿›å…¥IPéš§é“è®¾å¤‡ï¼ˆtunl0ï¼‰ï¼Œç”±<code>Linux</code>å†…æ ¸<code>IPIP</code>é©±åŠ¨å°è£…åœ¨å®¿ä¸»æœºç½‘ç»œçš„<code>IP</code>åŒ…ä¸­ï¼ˆæ–°çš„<code>IP</code>åŒ…ç›®çš„åœ°ä¹‹æ˜¯åŸ<code>IP</code>åŒ…çš„ä¸‹ä¸€è·³åœ°å€ï¼Œå³192.168.31.63ï¼‰ï¼Œè¿™æ ·ï¼Œå°±æˆäº†<code>Node1</code>åˆ°<code>Node2</code>çš„æ•°æ®åŒ…ï¼›</li>
<li>æ•°æ®åŒ…ç»è¿‡è·¯ç”±å™¨ä¸‰å±‚è½¬å‘åˆ°<code>Node2</code>ï¼›</li>
<li><code>Node2</code>æ”¶åˆ°æ•°æ®åŒ…åï¼Œç½‘ç»œåè®®æ ˆä¼šä½¿ç”¨<code>IPIP</code>é©±åŠ¨è¿›è¡Œè§£åŒ…ï¼Œä»ä¸­æ‹¿åˆ°åŸå§‹<code>IP</code>åŒ…ï¼›</li>
<li>ç„¶åæ ¹æ®è·¯ç”±è§„åˆ™ï¼Œæ ¹æ®è·¯ç”±è§„åˆ™å°†æ•°æ®åŒ…è½¬å‘ç»™<code>cali</code>è®¾å¤‡ï¼Œä»è€Œåˆ°è¾¾å®¹å™¨2ã€‚</li>
</ol>
<p>è·¯ç”±è¡¨ï¼š</p>
<pre><code># node1
10.244.36.65 dev cali4f18ce2c9a1 scope link 
10.244.169.128/26 via 192.168.31.63 dev tunl0 proto bird onlink 
# node2
10.244.169.129 dev calia4d5b2258bb scope link 
10.244.36.64/26 via 192.168.31.62 dev tunl0 proto bird onlink 
</code></pre>
<p>ä¸éš¾çœ‹åˆ°ï¼Œå½“<code>Calico</code>ä½¿ç”¨<code>IPIP</code>æ¨¡å¼çš„æ—¶å€™ï¼Œé›†ç¾¤çš„ç½‘ç»œæ€§èƒ½ä¼šå› ä¸ºé¢å¤–çš„å°åŒ…å’Œè§£åŒ…å·¥ä½œè€Œä¸‹é™ã€‚æ‰€ä»¥å»ºè®®ä½ å°†æ‰€æœ‰å®¿ä¸»æœºèŠ‚ç‚¹æ”¾åœ¨ä¸€ä¸ªå­ç½‘é‡Œï¼Œé¿å…ä½¿ç”¨<code>IPIP</code>ã€‚</p>
<h2 id="8-calicoç½‘ç»œç­–ç•¥">8ã€Calicoç½‘ç»œç­–ç•¥</h2>
<p>éƒ¨ç½²å®ŒæˆCalicoåï¼Œå°±å¯ä»¥å®ç°k8sä¸­çš„ç½‘ç»œç­–ç•¥<code>NetworkPolicy</code>ï¼Œå¯¹äºç½‘ç»œç­–ç•¥åœ¨å‰é¢çš„æ–‡ç« <a href="https://www.ssgeek.com/post/shi-yong-flannelcanal-shi-xian-k8s-de-networkpolicy/">ä½¿ç”¨flannel+canalå®ç°k8sçš„NetworkPolicy</a>æœ‰è¯¦ç»†æè¿°ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚ğŸ˜Š</p>
<p>æ–‡ç« å‚è€ƒæ¥æº: https://docs.projectcalico.org/</p>

            </div>
            
              <div class="tag-container">
                
                  <a href="https://www.ssgeek.com/tag/z9mk4508N" class="tag">
                    calico
                  </a>
                
                  <a href="https://www.ssgeek.com/tag/kubernetes" class="tag">
                    kubernetes
                  </a>
                
              </div>
            
            
              <div class="next-post">
                <div class="next">ä¸‹ä¸€ç¯‡</div>
                <a href="https://www.ssgeek.com/post/cka-ren-zheng-kao-shi">
                  <h3 class="post-title">
                    CKAè®¤è¯è€ƒè¯•
                  </h3>
                </a>
              </div>
            

            
              
                <div id="gitalk-container" data-aos="fade-in"></div>
              

              
            

          </div>

        </div>
      </div>
    </div>

    <script src="https://cdn.bootcdn.net/ajax/libs/aos/2.3.4/aos.js"></script>

<script type="application/javascript">

AOS.init();

hljs.initHighlightingOnLoad()

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>



  
    <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
    <script>

      var gitalk = new Gitalk({
        clientID: '22c870a7f8551b566598',
        clientSecret: '1acfdedd403cdf39c4a6ce932a4a991bb2b32e3a',
        repo: 'hargeek.github.io',
        owner: 'hargeek',
        admin: ['hargeek'],
        id: (location.pathname).substring(0, 49),      // Ensure uniqueness and length less than 50
        distractionFreeMode: false  // Facebook-like distraction free mode
      })

      gitalk.render('gitalk-container')

    </script>
  

  


  </body>
</html>
