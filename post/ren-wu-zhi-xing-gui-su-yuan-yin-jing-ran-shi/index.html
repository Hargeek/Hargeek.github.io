<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>任务执行龟速，原因竟然是...... | 山山仙人博客</title>
<meta name="description" content="">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/5.7.2/css/all.css">
<link rel="shortcut icon" href="https://www.ssgeek.com/favicon.ico?v=1705415649333">
<link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://www.ssgeek.com/styles/main.css">


  
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/gitalk/1.6.2/gitalk.css" />
  

  


<script src="https://cdn.bootcdn.net/ajax/libs/vue/2.6.11/vue.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
<script data-ad-client="ca-pub-6775328896166270" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?4b826a92a3dc151a74693fa1942d3167";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

<link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/aos/2.3.4/aos.css" />


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-147397031-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-147397031-1');
</script>


  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://www.ssgeek.com">
        <img src="https://www.ssgeek.com/images/avatar.png?v=1705415649333" class="site-logo">
        <h1 class="site-title">山山仙人博客</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="https://www.ssgeek.com" class="site-nav">
            首页
          </a>
        
      
        
          <a href="https://www.ssgeek.com/archives" class="site-nav">
            归档
          </a>
        
      
        
          <a href="https://www.ssgeek.com/tags" class="site-nav">
            标签
          </a>
        
      
        
          <a href="https://www.ssgeek.com/post/about/" class="site-nav">
            关于
          </a>
        
      
        
          <a href="https://www.ssgeek.com/post/gong-zhong-hao/" class="site-nav">
            公众号
          </a>
        
      
        
          <a href="https://www.ssgeek.com/post/you-qing-lian-jie/" class="site-nav">
            友情链接
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
          <a class="social-link" href="https://github.com/hargeek" target="_blank">
            <i class="fab fa-github"></i>
          </a>
        
      
        
          <a class="social-link" href="https://twitter.com/anronghong" target="_blank">
            <i class="fab fa-twitter"></i>
          </a>
        
      
        
          <a class="social-link" href="https://weibo.com/u/5717964658" target="_blank">
            <i class="fab fa-weibo"></i>
          </a>
        
      
        
          <a class="social-link" href="https://www.zhihu.com/people/hong-an-rong-46/activities" target="_blank">
            <i class="fab fa-zhihu"></i>
          </a>
        
      
        
          <a class="social-link" href="https://www.facebook.com/profile.php?id=100041470532098" target="_blank">
            <i class="fab fa-facebook"></i>
          </a>
        
      
    </div>
    <div class="site-description">
      
    </div>
    <div class="site-footer">
      <a href="https://beian.miit.gov.cn" style="text-decoration:none;">鄂ICP备18007156号-1</a></br></br>Copyright © All Rights Reserved | <a class="rss" href="https://www.ssgeek.com/atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>

      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">任务执行龟速，原因竟然是......</h2>
            <div class="post-date">2021-12-09</div>
            
            <div class="post-content">
              <p><ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#1-%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF">1、问题背景</a></li>
<li><a href="#2-%E5%88%86%E6%9E%90%E5%92%8C%E5%A4%8D%E7%9B%98">2、分析和复盘</a>
<ul>
<li><a href="#21-%E7%BD%91%E7%BB%9C%E5%B8%A6%E5%AE%BD%E6%B5%8B%E8%AF%95">2.1 网络带宽测试</a></li>
<li><a href="#22-dns%E8%A7%A3%E6%9E%90%E6%B5%8B%E8%AF%95">2.2 dns解析测试</a></li>
<li><a href="#23-%E4%B8%9A%E5%8A%A1%E4%BB%A3%E7%A0%81%E6%8E%92%E6%9F%A5">2.3 业务代码排查</a></li>
<li><a href="#24-%E5%A4%9A%E6%96%B9%E5%AF%B9%E6%AF%94%E6%B3%95">2.4 多方对比法</a>
<ul>
<li><a href="#241-%E5%9F%BA%E7%A1%80%E9%95%9C%E5%83%8F">2.4.1 基础镜像</a></li>
<li><a href="#242-%E4%B8%8B%E8%BD%BD%E5%A4%96%E7%BD%91%E6%96%87%E4%BB%B6">2.4.2 下载外网文件</a></li>
</ul>
</li>
<li><a href="#25-%E7%9B%B4%E6%8E%A5%E4%B8%8B%E8%BD%BD%E6%B5%8B%E8%AF%95">2.5 直接下载测试</a></li>
</ul>
</li>
<li><a href="#3-%E9%97%AE%E9%A2%98%E5%AE%9A%E4%BD%8D">3、问题定位</a></li>
<li><a href="#4-%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90">4、问题分析</a></li>
<li><a href="#5-%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3">5、问题解决</a></li>
<li><a href="#6-%E5%B0%8F%E7%BB%93">6、小结</a></li>
</ul>
</li>
</ul>
</p>
<figure data-type="image" tabindex="1"><img src="https://image.ssgeek.com/20211209-01.png" alt="20211209-01"></figure>
<h2 id="1-问题背景">1、问题背景</h2>
<p>某天，业务同学反馈生产环境<code>k8s</code>集群中由核心服务创建的<code>Job</code>任务执行速度奇慢......</p>
<p>通过分析服务日志发现，该服务运行前期主要是执行请求数据交换服务，获取到<code>oss</code>对象存储的文件<code>url</code>后进行下载，下载完成后再执行其他任务</p>
<h2 id="2-分析和复盘">2、分析和复盘</h2>
<p>“服务好好的，怎么用着用着就慢了呢？” 旁边的xx开始发起了灵魂拷问</p>
<p>由于此问题偏故障型，首先想到的当然是秉承着“有报错，看日志”的宗旨，去看各方服务的日志</p>
<p>通过排查日志，均无错误，但现象就是日志慢而且卡顿</p>
<p>于是先判断是不是服务之间的网络出问题了</p>
<p>简单思考了下，与网络因素相关，再加上排除法，最小化可能的相关原因有如下</p>
<ul>
<li><code>pod</code>网卡</li>
<li>节点和<code>pod</code>网络检查</li>
<li>调度到不同节点的网卡对比</li>
<li>不同场景下网卡出入站带宽</li>
<li><code>dns</code>解析</li>
<li>节点资源综合对比</li>
<li><code>oss</code>服务端限流等策略核查</li>
<li>服务本身代码是否变更等等</li>
</ul>
<p>对照可能原因开始一一排查，如下列举一些相关的具体排查方法，其余就不再赘述了</p>
<h3 id="21-网络带宽测试">2.1 网络带宽测试</h3>
<p>对于网络带宽的测试，可以选用<code>ethtool</code>、<code>iperf</code>等工具，可以很方便的帮我们查看网卡相关信息，测试网络出站入站的带宽，顺便加上抓包工具</p>
<pre><code class="language-shell"># ethtool
Settings for eth0:
	Supported ports: [ ]
	Supported link modes:   Not reported
	Supported pause frame use: No
	Supports auto-negotiation: No
	Advertised link modes:  Not reported
	Advertised pause frame use: No
	Advertised auto-negotiation: No
	Speed: 10000Mb/s
	Duplex: Full
	Port: Twisted Pair
	PHYAD: 0
	Transceiver: internal
	Auto-negotiation: off
	MDI-X: Unknown
Cannot get wake-on-lan settings: Operation not permitted
	Link detected: yes

# iperf
Server listening on TCP port 5001
TCP window size: 12.0 MByte (default)
------------------------------------------------------------
[  4] local 10.244.155.34 port 5001 connected with 10.244.0.196 port 42148
[ ID] Interval       Transfer     Bandwidth
[  4] 0.0000-2.0000 sec  1.62 GBytes  6.97 Gbits/sec
[  4] 2.0000-4.0000 sec  1.15 GBytes  4.93 Gbits/sec
[  4] 4.0000-6.0000 sec  1.15 GBytes  4.93 Gbits/sec
[  4] 6.0000-8.0000 sec  1.14 GBytes  4.91 Gbits/sec
[  4] 8.0000-10.0000 sec  1.14 GBytes  4.91 Gbits/sec
[  4] 10.0000-12.0000 sec  1.14 GBytes  4.92 Gbits/sec
[  4] 12.0000-14.0000 sec  1.14 GBytes  4.89 Gbits/sec
[  4] 14.0000-16.0000 sec  1.14 GBytes  4.90 Gbits/sec
[  4] 16.0000-18.0000 sec  1.14 GBytes  4.88 Gbits/sec
[  4] 18.0000-20.0000 sec  1.14 GBytes  4.88 Gbits/sec
[  4] 20.0000-22.0000 sec  1.14 GBytes  4.89 Gbits/sec
[  4] 22.0000-24.0000 sec  1.14 GBytes  4.89 Gbits/sec
[  4] 24.0000-26.0000 sec  1.13 GBytes  4.87 Gbits/sec
[  4] 26.0000-28.0000 sec  1.14 GBytes  4.88 Gbits/sec
[  4] 28.0000-30.0000 sec  1.14 GBytes  4.91 Gbits/sec
[  4] 30.0000-32.0000 sec  1.14 GBytes  4.88 Gbits/sec
[  4] 32.0000-34.0000 sec  1.14 GBytes  4.89 Gbits/sec
[  4] 34.0000-36.0000 sec  1.14 GBytes  4.91 Gbits/sec
[  4] 36.0000-38.0000 sec  1.14 GBytes  4.88 Gbits/sec
[  4] 38.0000-40.0000 sec  1.14 GBytes  4.91 Gbits/sec
[  4] 40.0000-42.0000 sec  1.14 GBytes  4.90 Gbits/sec
[  4] 42.0000-44.0000 sec  1.14 GBytes  4.90 Gbits/sec
[  4] 44.0000-46.0000 sec  1.14 GBytes  4.90 Gbits/sec
[  4] 46.0000-48.0000 sec  1.14 GBytes  4.90 Gbits/sec
[  4] 48.0000-50.0000 sec  1.15 GBytes  4.93 Gbits/sec
[  4] 50.0000-52.0000 sec  1.14 GBytes  4.91 Gbits/sec
[  4] 52.0000-54.0000 sec  1.14 GBytes  4.92 Gbits/sec
[  4] 54.0000-56.0000 sec  1.14 GBytes  4.90 Gbits/sec
[  4] 56.0000-58.0000 sec  1.14 GBytes  4.88 Gbits/sec
[  4] 58.0000-60.0000 sec  1.14 GBytes  4.89 Gbits/sec
[  4] 60.0000-60.0201 sec  13.6 MBytes  5.69 Gbits/sec
[  4] 0.0000-60.0201 sec  34.7 GBytes  4.97 Gbits/sec
</code></pre>
<p>结果：无果</p>
<h3 id="22-dns解析测试">2.2 dns解析测试</h3>
<p>对于<code>dns</code>解析的测试，利用<code>dig</code>、<code>nslookup</code>工具分别选取了公网域名，内网域名，集群内域名分别测试进行对比，例如</p>
<pre><code class="language-shell">www.baidu.com
data.ssgeek.com
data-download.default.svc.cluster.local
</code></pre>
<p>结果：无果</p>
<h3 id="23-业务代码排查">2.3 业务代码排查</h3>
<p>针对于此业务，排查了其发布的版本，在出故障时并未发布新版本</p>
<p>服务是<code>python</code>语言写的，于是结合<code>sdk</code>对代码进行分析，将<code>oss</code>下载相关逻辑拆分出来，写成<code>python</code>脚本，单独调用<code>sdk</code>获得下载地址，然后进行下载流程，分别计算每一步骤执行的时间</p>
<p>结果：无果</p>
<h3 id="24-多方对比法">2.4 多方对比法</h3>
<h4 id="241-基础镜像">2.4.1 基础镜像</h4>
<p>由于有同类以<code>deployment</code>形式部署的对应服务，但在<code>deployment</code>的<code>pod</code>中下载没有任何问题</p>
<p>代码一样，开始怀疑是否因<code>job</code>任务使用的镜像与正常的镜像底层有关系</p>
<p>分别检查了对应的<code>Dockerfile</code>，发现<code>base</code>镜像及版本都不一样</p>
<p>于是将其变为同样的<code>base</code>镜像再次对比，任务执行时间还是有很大区别</p>
<p>结果：无果</p>
<h4 id="242-下载外网文件">2.4.2 下载外网文件</h4>
<p>排除了镜像问题，继续排除<code>oss</code>服务端的问题，于是分别通过<code>shell</code>让两边的<code>pod</code>去公网下载同样的大文件以及同样的小文件分别进行对比</p>
<p>结果：无果</p>
<p>到这里已经近乎<code>mb</code>了</p>
<p>这里也省略其他对比的一些措施</p>
<h3 id="25-直接下载测试">2.5 直接下载测试</h3>
<p>通过上面的一些<code>sao</code>操作，发现都没有明显效果，这对问题的排查增加了一定难度</p>
<p>于是乎，能不能抛开代码业务逻辑不谈，先一次性拿到所有需要下载文件的地址，然后手动通过原始的<code>shell</code>脚本去批量执行下载任务进行对比呢？当然</p>
<p>这里举例，用<code>shell</code>下载文件的脚本如下</p>
<pre><code class="language-shell">#/bin/bash

j=1
for i in `cat 1.txt`
do
    echo $j
    curl -s -o $j.jpg $i
    let j=j+1
done
# 1.txt为文件的url列表
</code></pre>
<h2 id="3-问题定位">3、问题定位</h2>
<p>通过上面最后一次通过<code>shell</code>脚本下载文件测试时发现：</p>
<p>在测试脚本刚开始启动时，程序会停顿几分钟，然后再开始执行下载任务，这意味着<code>bash</code>程序启动慢</p>
<p>换做<code>job</code>，<code>job</code>运行的<code>pod</code>执行的是一次性任务，因此和脚本执行是一样的，只是<code>k8s</code>层提供了这个脚本执行的载体，即<code>pod</code></p>
<p>我们可以用一个简单的命令组合，检查当前<code>bash</code>的执行时间，发现相比正常情况下要慢很多</p>
<pre><code class="language-shell"># time bash -c exit

real        0m0.004s
user        0m0.000s
sys         0m0.000s
</code></pre>
<h2 id="4-问题分析">4、问题分析</h2>
<p>通过进一步检查程序启动慢的资料发现，程序在启动之前往往会加载系统的环境变量</p>
<p>由于<code>pod</code>执行的是一次性任务，因此这种<code>job</code>的执行时间就包含了</p>
<ul>
<li>加载环境变量的时间</li>
<li>程序执行时间（包含网络请求、<code>io</code>读写、计算等）</li>
</ul>
<p>而普通的<code>pod</code>，在正常运行第一次启动时就已经加载了环境变量，所以当<code>pod</code>再次去执行某些任务时，已经不需要这一步骤了 ~</p>
<p>这样一来，当环境变量过多时，程序启动就会变慢</p>
<p>通过<code>env</code>命令，可以打印出<code>pod</code>内所有的环境变量</p>
<p>默认情况下<code>k8s</code>会为每个<code>pod</code>都注入除了自定义的环境变量以外的，这个<code>pod</code>所在命名空间下所有的公共环境变量</p>
<p>到这里，事情开始出现了转机，于是默默兴奋了一把</p>
<p>于是计算了一下环境变量个数，竟然高达<code>35000+</code>个环境变量，进一步排查发现，几乎<code>99%</code>的环境变量都是一个大量任务的相关服务的环境变量，这个服务会以<code>deployment</code>、<code>service</code>的命名不同，来创建很多个定义一样，命名不同的副本服务，进一步在集群中检查，此类服务的数量达<code>4500</code>多个</p>
<p>在谷歌<code>Google Kubernetes Engine (GKE)</code>中建议</p>
<p>每个命名空间的<code>Service</code>数不应超过<code>5000</code>。如超过此值，<code>Service</code>环境变量的数量会超出<code>shell</code>限制，导致<code>Pod</code>在启动时变慢甚至崩溃。在<code>Kubernetes 1.13</code>版本后，可以通过将<code>PodSpec</code>中的<code>enableServiceLinks</code>设置为<code>false</code>来停止填充这些变量</p>
<p>这个值在阿里云<code>Alibaba Cloud Container Service for Kubernetes (ACK)</code>的默认建议是<code>1000</code>个</p>
<p>即想要禁止注入无关环境变量的注入，从<code>Kubernetes 1.13</code>版本开始，可以声明<code>enableServiceLinks: false</code></p>
<p>更巧的是，默认创建的<code>pod</code>，这个<code>enableServiceLinks</code>选项是不可见（隐式）的，即使<code>-o yaml</code>也不会输出，但是默认值又给了<code>true</code>，这就让人很难察觉了</p>
<p>源码部分参考</p>
<p><code>pkg/apis/core/v1/defaults.go</code></p>
<pre><code class="language-go">if obj.Spec.EnableServiceLinks == nil {
	enableServiceLinks := v1.DefaultEnableServiceLinks
	obj.Spec.EnableServiceLinks = &amp;enableServiceLinks
}
</code></pre>
<p><code>k8s.io/api/core/v1/types.go</code></p>
<pre><code class="language-go">const (
	// The default value for enableServiceLinks attribute.
	DefaultEnableServiceLinks = true
)
</code></pre>
<h2 id="5-问题解决">5、问题解决</h2>
<p>最终通过在<code>job</code>的定义中添加了这个参数的默认值，新创建的<code>pod</code>的就仅剩不到<code>30</code>个环境变量</p>
<p>修改创建<code>job</code>的相关代码<code>job_scheduler.go</code></p>
<pre><code class="language-go">var (
    ...
	jobTaskK8sEnableServiceLinks = false
)
...
targetJob.Spec.Template.Spec.EnableServiceLinks = &amp;jobTaskK8sEnableServiceLinks
...
</code></pre>
<p>再次部署新的服务并在相同场景下测试，下载速度恢复如常，问题得以解决~</p>
<h2 id="6-小结">6、小结</h2>
<p>小结一下，本文记录复盘的是一次<code>k8s</code>集群相关的生产故障</p>
<p>随着服务增多，集群的庞大，一些未知问题就必然会出现（而如果集群规模较小，也就基本不会遇到了）</p>
<p>对于一开始未知原因、诡异、没有思路的问题或者<code>bug</code>，往往利用穷举法列出所有可能的原因，然后采取最小化复现、差异化对比等等，基本能解决大部分这类问题</p>
<blockquote>
<p>今日发文试着标题党了一波，吸引一波阅读率，哈哈希望不要被喷，下次不会了0.0</p>
<p>参考<br>
https://github.com/kubernetes/kubernetes/issues/92226<br>
https://cloud.google.com/kubernetes-engine/docs/best-practices/scalability<br>
https://mozillazg.com/2020/06/kubernetes-k8s-too-many-service-environment-variables-cause-pod-container-start-bash-too-slow.html</p>
</blockquote>
<p>See you ~</p>

            </div>
            
              <div class="tag-container">
                
                  <a href="https://www.ssgeek.com/tag/rAjiCH60jX" class="tag">
                    k8s
                  </a>
                
                  <a href="https://www.ssgeek.com/tag/kubernetes" class="tag">
                    kubernetes
                  </a>
                
              </div>
            
            
              <div class="next-post">
                <div class="next">下一篇</div>
                <a href="https://www.ssgeek.com/post/ji-yu-ack-k8s-ji-qun-diao-du-de-she-ji-fang-an">
                  <h3 class="post-title">
                    基于ack k8s集群调度的方案设计
                  </h3>
                </a>
              </div>
            

            
              
                <div id="gitalk-container" data-aos="fade-in"></div>
              

              
            

          </div>

        </div>
      </div>
    </div>

    <script src="https://cdn.bootcdn.net/ajax/libs/aos/2.3.4/aos.js"></script>

<script type="application/javascript">

AOS.init();

hljs.initHighlightingOnLoad()

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>



  
    <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
    <script>

      var gitalk = new Gitalk({
        clientID: '22c870a7f8551b566598',
        clientSecret: '1acfdedd403cdf39c4a6ce932a4a991bb2b32e3a',
        repo: 'hargeek.github.io',
        owner: 'hargeek',
        admin: ['hargeek'],
        id: (location.pathname).substring(0, 49),      // Ensure uniqueness and length less than 50
        distractionFreeMode: false  // Facebook-like distraction free mode
      })

      gitalk.render('gitalk-container')

    </script>
  

  


  </body>
</html>
