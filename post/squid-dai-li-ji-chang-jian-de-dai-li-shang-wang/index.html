<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>squidä»£ç†åŠå¸¸è§çš„ä»£ç†ä¸Šç½‘ | å±±å±±ä»™äººåšå®¢</title>
<meta name="description" content="">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/5.7.2/css/all.css">
<link rel="shortcut icon" href="https://www.ssgeek.com/favicon.ico?v=1731253169775">
<link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://www.ssgeek.com/styles/main.css">


  
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/gitalk/1.6.2/gitalk.css" />
  

  


<script src="https://cdn.bootcdn.net/ajax/libs/vue/2.6.11/vue.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
<script data-ad-client="ca-pub-6775328896166270" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?4b826a92a3dc151a74693fa1942d3167";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

<link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/aos/2.3.4/aos.css" />


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-147397031-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-147397031-1');
</script>


  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://www.ssgeek.com">
        <img src="https://www.ssgeek.com/images/avatar.png?v=1731253169775" class="site-logo">
        <h1 class="site-title">å±±å±±ä»™äººåšå®¢</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="https://www.ssgeek.com" class="site-nav">
            é¦–é¡µ
          </a>
        
      
        
          <a href="https://www.ssgeek.com/archives" class="site-nav">
            å½’æ¡£
          </a>
        
      
        
          <a href="https://www.ssgeek.com/tags" class="site-nav">
            æ ‡ç­¾
          </a>
        
      
        
          <a href="https://www.ssgeek.com/post/about/" class="site-nav">
            å…³äº
          </a>
        
      
        
          <a href="https://www.ssgeek.com/post/gong-zhong-hao/" class="site-nav">
            å…¬ä¼—å·
          </a>
        
      
        
          <a href="https://www.ssgeek.com/post/you-qing-lian-jie/" class="site-nav">
            å‹æƒ…é“¾æ¥
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
          <a class="social-link" href="https://github.com/hargeek" target="_blank">
            <i class="fab fa-github"></i>
          </a>
        
      
        
          <a class="social-link" href="https://twitter.com/anronghong" target="_blank">
            <i class="fab fa-twitter"></i>
          </a>
        
      
        
          <a class="social-link" href="https://weibo.com/u/5717964658" target="_blank">
            <i class="fab fa-weibo"></i>
          </a>
        
      
        
          <a class="social-link" href="https://www.zhihu.com/people/hong-an-rong-46/activities" target="_blank">
            <i class="fab fa-zhihu"></i>
          </a>
        
      
        
          <a class="social-link" href="https://www.facebook.com/profile.php?id=100041470532098" target="_blank">
            <i class="fab fa-facebook"></i>
          </a>
        
      
    </div>
    <div class="site-description">
      
    </div>
    <div class="site-footer">
      <a href="https://beian.miit.gov.cn" style="text-decoration:none;">é„‚ICPå¤‡18007156å·-1</a></br></br>Copyright Â© All Rights Reserved | <a class="rss" href="https://www.ssgeek.com/atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>

      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">squidä»£ç†åŠå¸¸è§çš„ä»£ç†ä¸Šç½‘</h2>
            <div class="post-date">2020-02-13</div>
            
            <div class="post-content">
              <p><ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#1-%E7%8E%AF%E5%A2%83%E8%AF%B4%E6%98%8E">1ã€ç¯å¢ƒè¯´æ˜</a></li>
<li><a href="#2-%E6%90%AD%E5%BB%BAsquid%E6%9C%8D%E5%8A%A1">2ã€æ­å»ºsquidæœåŠ¡</a>
<ul>
<li><a href="#21-%E5%AE%89%E8%A3%85%E6%9C%8D%E5%8A%A1">2.1ã€å®‰è£…æœåŠ¡</a></li>
<li><a href="#22-%E9%85%8D%E7%BD%AE%E5%8F%97%E4%BF%A1">2.2ã€é…ç½®å—ä¿¡</a></li>
</ul>
</li>
<li><a href="#3-%E9%85%8D%E7%BD%AE%E4%BB%A3%E7%90%86">3ã€é…ç½®ä»£ç†</a>
<ul>
<li><a href="#31-%E9%85%8D%E7%BD%AE%E5%85%A8%E5%B1%80%E4%BB%A3%E7%90%86">3.1ã€é…ç½®å…¨å±€ä»£ç†</a></li>
<li><a href="#32-%E9%85%8D%E7%BD%AEwget%E4%BB%A3%E7%90%86">3.2ã€é…ç½®wgetä»£ç†</a></li>
<li><a href="#33-%E9%85%8D%E7%BD%AEyum%E4%BB%A3%E7%90%86">3.3ã€é…ç½®yumä»£ç†</a></li>
<li><a href="#34-%E9%85%8D%E7%BD%AEdocker%E4%BB%A3%E7%90%86">3.4ã€é…ç½®dockerä»£ç†</a></li>
<li><a href="#35-%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5">3.5ã€é—®é¢˜æ’æŸ¥</a></li>
</ul>
</li>
<li><a href="#4-%E6%90%AD%E5%BB%BAk8s%E6%97%B6%E9%85%8D%E7%BD%AE%E4%BB%A3%E7%90%86">4ã€æ­å»ºk8sæ—¶é…ç½®ä»£ç†</a></li>
<li><a href="#5-%E6%80%BB%E7%BB%93">5ã€æ€»ç»“</a></li>
</ul>
</li>
</ul>
</p>
<blockquote>
<p>Squid Cacheï¼ˆç®€ç§°ä¸ºSquidï¼‰æ˜¯HTTPä»£ç†æœåŠ¡å™¨è½¯ä»¶ã€‚Squidç”¨é€”å¹¿æ³›ï¼Œå¯ä»¥ä½œä¸ºç¼“å­˜æœåŠ¡å™¨ï¼Œå¯ä»¥è¿‡æ»¤æµé‡å¸®åŠ©ç½‘ç»œå®‰å…¨ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºä»£ç†æœåŠ¡å™¨é“¾ä¸­çš„ä¸€ç¯ï¼Œå‘ä¸Šçº§ä»£ç†è½¬å‘æ•°æ®æˆ–ç›´æ¥è¿æ¥äº’è”ç½‘ã€‚Squidç¨‹åºåœ¨Unixä¸€ç±»ç³»ç»Ÿè¿è¡Œã€‚ç”±äºå®ƒæ˜¯å¼€æºè½¯ä»¶ï¼Œæœ‰ç½‘ç«™ä¿®æ”¹Squidçš„æºä»£ç ï¼Œç¼–è¯‘ä¸ºåŸç”ŸWindowsç‰ˆ[2]ï¼›ç”¨æˆ·ä¹Ÿå¯åœ¨Windowsé‡Œå®‰è£…Cygwinï¼Œç„¶ååœ¨Cygwiné‡Œç¼–è¯‘Squidã€‚<br>
Squidå†å²æ‚ ä¹…ï¼ŒåŠŸèƒ½å®Œå–„ã€‚é™¤äº†HTTPå¤–ï¼Œå¯¹FTPä¸HTTPSçš„æ”¯æŒä¹Ÿç›¸å½“å¥½ï¼Œåœ¨3.0æµ‹è¯•ç‰ˆä¸­ä¹Ÿæ”¯æŒäº†IPv6ã€‚ä½†æ˜¯Squidçš„ä¸Šçº§ä»£ç†ä¸èƒ½ä½¿ç”¨SOCKSåè®®ã€‚</p>
</blockquote>
<h2 id="1-ç¯å¢ƒè¯´æ˜">1ã€ç¯å¢ƒè¯´æ˜</h2>
<p>æœ¬æ–‡ä¸­æ¶‰åŠä¸¤å°æœåŠ¡å™¨ï¼Œè¿™ä¸¤å°æœåŠ¡å™¨å‡æœ‰å†…ç½‘<code>ip</code>åœ°å€ï¼Œåˆ†åˆ«ä¸º</p>
<pre><code>A: 192.168.0.200
B: 192.168.0.100
C: 192.168.0.101
</code></pre>
<p>å…¶ä¸­<code>A</code>å…·æœ‰å…¬ç½‘è®¿é—®èƒ½åŠ›ï¼Œ<code>B</code>å’Œ<code>C</code>ä¸å…·å¤‡å…¬ç½‘è®¿é—®èƒ½åŠ›ã€‚</p>
<p>å› æ­¤ï¼Œå¯ä»¥è®©<code>B</code>å…·æœ‰å…¬ç½‘è®¿é—®èƒ½åŠ›æˆ–è®©<code>B</code>å’Œ<code>C</code>å®ç°æŸäº›åŠŸèƒ½ä¾‹å¦‚<code>yum</code>å®‰è£…è½¯ä»¶èƒ½æ­£å¸¸ä½¿ç”¨ï¼Œå¯è¡Œçš„æ–¹æ¡ˆæœ‰ä¸¤ç§ï¼š</p>
<ul>
<li>æ–¹æ¡ˆ1</li>
</ul>
<p>åœ¨<code>A</code>æœåŠ¡å™¨å¼€å¯æ•°æ®åŒ…å†…æ ¸è½¬å‘åŠŸèƒ½ï¼Œæ¥æ”¶<code>B</code>å’Œ<code>C</code>çš„æ•°æ®åŒ…ï¼Œ<code>B</code>å’Œ<code>C</code>å°†è‡ªå·±çš„ç½‘å…³é…ç½®æˆ<code>A</code>çš„åœ°å€ï¼Œè¿™æ ·<code>B</code>å’Œ<code>C</code>çš„ä¸Šç½‘èƒ½åŠ›å…¨éƒ¨é€šè¿‡<code>A</code>æ¥ä»£ç†è½¬å‘å®ç°ï¼Œè¿™ç§åšæ³•ç®€å•å¥½ç”¨ï¼Œä½†æ˜¯ä¸é€‚ç”¨äºäº‘å‚å•†æä¾›çš„è™šæ‹Ÿä¸»æœºä¾‹å¦‚é˜¿é‡Œäº‘<code>ECS</code>ï¼Œå› ä¸ºäº‘ä¸»æœºçš„<code>ip</code>å’Œç½‘å¡é…ç½®ä¸€èˆ¬æ˜¯ä¸æ”¯æŒè‡ªå·±å®šä¹‰çš„</p>
<ul>
<li>æ–¹æ¡ˆ2</li>
</ul>
<p>åœ¨<code>A</code>æœåŠ¡å™¨è¿è¡Œä¸€ä¸ª<code>squid</code>æœåŠ¡ï¼Œ<code>B</code>å’Œ<code>C</code>çš„æŸäº›æ“ä½œé€šè¿‡<code>squid</code>æ¥ä»£ç†è½¬å‘å®ç°</p>
<p>æœ¬æ–‡é€šè¿‡åœ¨<code>A</code>æœåŠ¡å™¨ä¸Šæ­å»º<code>squid</code>ä»£ç†ï¼Œå¹¶åœ¨<code>B</code>å’Œ<code>C</code>æœåŠ¡å™¨ä¸Šå®ç°äº†<code>wget</code>ã€<code>yum</code>ã€<code>docker</code>ä½¿ç”¨<code>A</code>çš„ä»£ç†ï¼Œä»¥åŠæŠŠ<code>A</code>ã€<code>B</code>ã€<code>C</code>è¿™ä¸‰å°æœåŠ¡å™¨ä½œä¸º<code>k8s</code>é›†ç¾¤çš„èŠ‚ç‚¹åˆ©ç”¨<code>kubeadm</code>æ­å»ºä¸€ä¸ª<code>k8s</code>é›†ç¾¤éœ€è¦é…ç½®çš„åœ°æ–¹</p>
<h2 id="2-æ­å»ºsquidæœåŠ¡">2ã€æ­å»ºsquidæœåŠ¡</h2>
<h3 id="21-å®‰è£…æœåŠ¡">2.1ã€å®‰è£…æœåŠ¡</h3>
<p><code>A</code>æœåŠ¡å™¨èƒ½ä¸Šç½‘ï¼Œå…ˆæŠŠ<code>A</code>æœåŠ¡å™¨çš„<code>yum</code>æºé…ç½®å¥½ï¼Œè¿™é‡Œä¸åšèµ˜è¿°ï¼Œç„¶åå®‰è£…<code>squid</code>æœåŠ¡</p>
<pre><code># rpm -qa | grep squid
# yum install -y squid
</code></pre>
<p>é»˜è®¤å®‰è£…çš„<code>squid</code>æœåŠ¡åªéœ€è¦é…ç½®ä¸€ç‚¹ï¼Œé»˜è®¤æ˜¯æ‹’ç»æ‰€æœ‰æœåŠ¡å™¨è¿æ¥ï¼Œåªéœ€è¦ä¿®æ”¹æˆå…è®¸æ‰€æœ‰æœåŠ¡å™¨è¿æ¥å³å¯</p>
<pre><code># vim /etc/squid/squid.conf
http_access allow all
</code></pre>
<p>å¯åŠ¨æœåŠ¡å¹¶è®¾ç½®æˆå¼€æœºå¯åŠ¨</p>
<pre><code># systemctl start squid.service
# systemctl enable squid.service
</code></pre>
<h3 id="22-é…ç½®å—ä¿¡">2.2ã€é…ç½®å—ä¿¡</h3>
<p>è¿™æ ·é…ç½®ä¹‹åï¼Œ<code>squid</code>ä»£ç†æœåŠ¡å™¨å°±å¯ä»¥ä½¿ç”¨äº†ï¼Œé»˜è®¤çš„ç«¯å£æ˜¯<code>3128</code>ï¼Œä½†æ˜¯ä¸ºäº†å®‰å…¨ï¼Œåªè®©å—ä¿¡çš„æœåŠ¡å™¨è¿æ¥ï¼Œé€šå¸¸è¿˜éœ€è¦å¯¹<code>squid</code>é…ç½®è´¦å·éªŒè¯æˆæƒä½¿ç”¨ï¼Œé€šè¿‡<code>httpd-tools</code>ç”Ÿæˆå¯†ç æ–‡ä»¶ï¼Œå®‰è£…</p>
<pre><code># yum install httpd-tools -y
</code></pre>
<p>ç”Ÿæˆå¯†ç æ–‡ä»¶</p>
<pre><code># mkdir /etc/squid3/
# ç”Ÿæˆå¯†ç æ–‡ä»¶ï¼ŒæŒ‡å®šæ–‡ä»¶è·¯å¾„ï¼Œå…¶ä¸­squidæ˜¯ç”¨æˆ·å
# htpasswd -cd /etc/squid3/passwords squid
#æç¤ºè¾“å…¥å¯†ç ï¼Œä¸èƒ½è¶…è¿‡8ä¸ªå­—ç¬¦ï¼Œè¾“å…¥å¯†ç 123456
</code></pre>
<p>æµ‹è¯•å¯†ç æ–‡ä»¶</p>
<pre><code># /usr/lib64/squid/basic_ncsa_auth /etc/squid3/passwords                
squid 123456
OK 
# æµ‹è¯•å®Œæˆï¼Œcrtl + c æ‰“æ–­
</code></pre>
<p>é…ç½®<code>squid</code>ä½¿ç”¨éªŒè¯ï¼Œä¿®æ”¹é…ç½®æ–‡ä»¶</p>
<pre><code># vim /etc/squid/squid.conf
# And finally deny all other access to this proxy
auth_param basic program /usr/lib64/squid/basic_ncsa_auth /etc/squid3/passwords #è´¦æˆ·å¯†ç æ–‡ä»¶
auth_param basic realm proxy
auth_param basic children 50 #æœ€å¤š 50 ä¸ªè´¦æˆ·åŒæ—¶è¿è¡Œ
auth_param basic realm CoolTube Proxy Server #å¯†ç æ¡†æè¿°
auth_param basic credentialsttl 2 hours #è®¤è¯æŒç»­æ—¶é—´
acl authenticated proxy_auth REQUIRED #å¯¹ authenticated è¿›è¡Œå¤–éƒ¨è®¤è¯
http_access allow authenticated #å…è®¸ authenticated ä¸­çš„æˆå‘˜è®¿é—®
http_access deny all #æ‹’ç»æ‰€æœ‰å…¶ä»–è®¿é—®
visible_hostname squid.CoolTube #ä»£ç†æœºåå­—

# è¿™é‡Œæ˜¯ç«¯å£å·ï¼Œå¯ä»¥æŒ‰éœ€ä¿®æ”¹
# http_port 3128 è¿™æ ·å†™ä¼šåŒæ—¶ç›‘å¬ ipv6 å’Œ ipv4 çš„ç«¯å£ï¼Œæ¨èé€‚åº”ä¸‹é¢çš„é…ç½®æ–¹æ³•ã€‚
http_port 0.0.0.0:3128
</code></pre>
<p>åˆå§‹åŒ–æœåŠ¡å¹¶é‡æ–°å¯åŠ¨</p>
<pre><code># squid -z
# systemctl restart squid.service
</code></pre>
<p>å¦‚æœå¼€å¯äº†é˜²ç«å¢™ï¼Œè¿˜è¦åœ¨é˜²ç«å¢™ä¸­å…è®¸ç«¯å£<code>3128</code>çš„ç­–ç•¥ï¼Œä»¥<code>CentOS7</code>ä¸ºä¾‹</p>
<pre><code># æŠŠ 3128 ç«¯å£åŠ å…¥é˜²ç«å¢™è¿‡æ»¤æ‰
# firewall-cmd --permanent --zone=public --add-port=3128/tcp
# é‡å¯é˜²ç«å¢™
# firewall-cmd --reload
</code></pre>
<p>å¦‚æœæƒ³æ–°å¢ç”¨æˆ·ï¼Œåªéœ€è¦æŒ‰ç…§ä¸Šé¢çš„æ­¥éª¤å†æ¬¡ç”Ÿæˆä¸€æ¬¡å¯†ç æ–‡ä»¶å°±å¯ä»¥</p>
<h2 id="3-é…ç½®ä»£ç†">3ã€é…ç½®ä»£ç†</h2>
<h3 id="31-é…ç½®å…¨å±€ä»£ç†">3.1ã€é…ç½®å…¨å±€ä»£ç†</h3>
<p>ä¿®æ”¹ç¯å¢ƒå˜é‡æ–‡ä»¶å¹¶ä½¿å…¶ç”Ÿæ•ˆ</p>
<pre><code>vim /etc/profile
#åœ¨æœ€ååŠ å…¥ï¼ˆæœ‰è®¤è¯çš„æƒ…å†µï¼‰
export http_proxy=&quot;http://squid:123456@192.168.0.200:3128&quot;
export https_proxy=&quot;http://squid:123456@192.168.0.200:3128&quot;
å¦‚æœæ²¡æœ‰å¼€å¯è®¤è¯
http_proxy=http://192.168.0.200:3128
https_proxy=http://192.168.0.200:3128
# source /etc/profile
</code></pre>
<h3 id="32-é…ç½®wgetä»£ç†">3.2ã€é…ç½®wgetä»£ç†</h3>
<p>æ–°å¢<code>wget</code>çš„ç¯å¢ƒå˜é‡æ–‡ä»¶</p>
<pre><code># vim ~/.wgetrc
http_proxy=http://192.168.0.200:3128
https_proxy=http://192.168.0.200:3128
use_proxy = on
wait = 30
# éªŒè¯ï¼Œå¦‚æœè¿”å›å€¼ä¸º0è¡¨ç¤ºwgetå¯ç”¨
# wget --spider -T 5 -q -t 2 www.baidu.com | echo $?
0
</code></pre>
<h3 id="33-é…ç½®yumä»£ç†">3.3ã€é…ç½®yumä»£ç†</h3>
<p>ç¼–è¾‘<code>yum</code>çš„é…ç½®æ–‡ä»¶ï¼Œæ–°å¢ä¸‹é¢çš„å†…å®¹</p>
<pre><code># vim /etc/yum.conf
# æœ‰è®¤è¯çš„æƒ…å†µ
# Proxy
proxy=http://squid:123456@192.168.0.200:3128
# æ²¡æœ‰è®¤è¯
# Proxy
proxy=http://192.168.0.200:3128
</code></pre>
<h3 id="34-é…ç½®dockerä»£ç†">3.4ã€é…ç½®dockerä»£ç†</h3>
<p><code>docker</code>é…ç½®ä»£ç†æ˜¯ä¸ºäº†ä¿è¯<code>docker</code>èƒ½ä»å¤–ç½‘<code>pull</code>é•œåƒï¼Œåœ¨å®‰è£…äº†<code>docker</code>ä¹‹åï¼Œåœ¨<code>docker</code>é…ç½®æ–‡ä»¶ä¸‹æ–°å¢é…ç½®å¹¶é‡å¯<code>docker</code></p>
<pre><code># mkdir -p /etc/systemd/system/docker.service.d
# vim /etc/systemd/system/docker.service.d/http-proxy.conf
[Service]
Environment=&quot;HTTP_PROXY=http://squid:123456@192.168.0.200:3128&quot; 
# systemctl daemon-reload
# systemctl restart docker
</code></pre>
<p>éªŒè¯ï¼Œé€šè¿‡<code>docker pull</code>å‘½ä»¤<code>pull</code>ä¸€ä¸ªå…¬ç½‘çš„é•œåƒ</p>
<pre><code>docker pull busybox:latest
</code></pre>
<h3 id="35-é—®é¢˜æ’æŸ¥">3.5ã€é—®é¢˜æ’æŸ¥</h3>
<p>å¦‚æœåœ¨é…ç½®ä¸Šè¿°ä»£ç†åè¿›è¡ŒéªŒè¯çš„æ—¶å€™ï¼Œå‡ºç°æ²¡æœ‰è¿”å›ï¼Œå¡é¡¿æˆ–è¶…æ—¶çš„æƒ…å†µï¼Œå¯ä»¥é€šè¿‡æŸ¥çœ‹<code>A</code>æœåŠ¡å™¨å³<code>squid</code>ä»£ç†æœåŠ¡å™¨çš„æ—¥å¿—è¿›è¡Œæ£€æŸ¥ï¼Œåœ¨æ—¥å¿—ä¸­ä¸€èˆ¬éƒ½å¯ä»¥æŸ¥çœ‹åˆ°è¾ƒä¸ºæ˜æ˜¾çš„é”™è¯¯<br>
cache.log</p>
<pre><code>tail -f /var/log/squid/cache.log 
2020/02/12 22:56:12 kid1| Store logging disabled
2020/02/12 22:56:12 kid1| DNS Socket created at [::], FD 9
2020/02/12 22:56:12 kid1| DNS Socket created at 0.0.0.0, FD 10
2020/02/12 22:56:12 kid1| Adding nameserver 114.114.114.114 from /etc/resolv.conf
2020/02/12 22:56:12 kid1| Adding nameserver 114.114.115.115 from /etc/resolv.conf
2020/02/12 22:56:12 kid1| helperOpenServers: Starting 0/50 'basic_ncsa_auth' processes
2020/02/12 22:56:12 kid1| helperOpenServers: No 'basic_ncsa_auth' processes needed.
2020/02/12 22:56:12 kid1| HTCP Disabled.
2020/02/12 22:56:12 kid1| Finished loading MIME types and icons.
2020/02/12 22:56:12 kid1| Accepting HTTP Socket connections at local=0.0.0.0:3128 remote=[::] FD 11 flags=9
</code></pre>
<p>access.log</p>
<pre><code># tail -f /var/log/squid/access.log 
1581519614.049     47 192.168.0.100 TCP_TUNNEL/200 5383 CONNECT registry.cn-beijing.aliyuncs.com:443 - HIER_DIRECT/47.95.181.38 -
1581542724.596     39 192.168.0.100 TCP_MISS/503 397 HEAD http://url/ - HIER_NONE/- text/html
1581542754.860    256 192.168.0.100 TCP_TUNNEL/200 4460 CONNECT www.baidu.com:443 - HIER_DIRECT/180.101.49.41 -
1581542818.197    107 192.168.0.100 TCP_MISS/200 262 HEAD http://www.baidu.com/ - HIER_DIRECT/180.101.49.41 text/html
1581542820.465     53 192.168.0.100 TCP_MISS/200 262 HEAD http://www.baidu.com/ - HIER_DIRECT/180.101.49.41 text/html
1581542821.292     53 192.168.0.100 TCP_MISS/200 262 HEAD http://www.baidu.com/ - HIER_DIRECT/180.101.49.41 text/html
1581542821.864     54 192.168.0.100 TCP_MISS/200 262 HEAD http://www.baidu.com/ - HIER_DIRECT/180.101.49.41 text/html
1581542822.323     53 192.168.0.100 TCP_MISS/200 262 HEAD http://www.baidu.com/ - HIER_DIRECT/180.101.49.41 text/html
1581542822.764     53 192.168.0.100 TCP_MISS/200 262 HEAD http://www.baidu.com/ - HIER_DIRECT/180.101.49.41 text/html
1581542823.243     53 192.168.0.100 TCP_MISS/200 262 HEAD http://www.baidu.com/ - HIER_DIRECT/180.101.49.41 text/html
</code></pre>
<h2 id="4-æ­å»ºk8sæ—¶é…ç½®ä»£ç†">4ã€æ­å»ºk8sæ—¶é…ç½®ä»£ç†</h2>
<p>åœ¨ä½¿ç”¨<code>kubeadm</code>æˆ–äºŒè¿›åˆ¶æ–¹å¼æ­å»º<code>k8s</code>é›†ç¾¤æ—¶ï¼Œé›†ç¾¤å†…éƒ¨<code>pod</code>å’Œ<code>service</code>ä¼šå•ç‹¬å ç”¨ä¸åŒçš„ç½‘ç»œï¼Œ<code>service</code>ç½‘ç»œæ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„ç½‘æ®µï¼Œè¿™ä¸ªæ—¶å€™è¿˜éœ€è¦å£°æ˜æµé‡ä¸è®©å…¶èµ°<code>http/https</code>ä»£ç†ï¼Œè¿™ç§å£°æ˜æ–¹å¼ä¹Ÿé€‚ç”¨äºå¯¹é‚£äº›æ²¡æœ‰åŸŸåè§£æé€šè¿‡ç»‘å®š<code>hosts</code>æ–‡ä»¶æ¥è®¿é—®çš„åŸŸåã€‚</p>
<p>å¦‚æœä¸å£°æ˜ï¼Œåœ¨ä½¿ç”¨<code>kubeadm</code>éƒ¨ç½²<code>k8s</code>é›†ç¾¤ï¼Œæ‰§è¡Œ<code>kubeadm init</code>åˆå§‹åŒ–é›†ç¾¤çš„æ—¶å€™ä¼šçœ‹åˆ°å¦‚ä¸‹çš„æç¤ºå¹¶æ‰§è¡Œè¶…æ—¶å¤±è´¥</p>
<pre><code>[WARNING HTTPProxyCIDR]: connection to &quot;10.1.0.0/12&quot; uses proxy &quot;http://192.168.0.200:3128&quot;. This may lead to malfunctional cluster setup. Make sure that Pod and Services IP ranges specified correctly as exceptions in proxy configuration
[WARNING HTTPProxyCIDR]: connection to &quot;10.244.0.0/16&quot; uses proxy &quot;http://192.168.0.200:3128&quot;. This may lead to malfunctional cluster setup. Make sure that Pod and Services IP ranges specified correctly as exceptions in proxy configuration
</code></pre>
<p>åœ¨ä¸æ–­é‡è¯•çš„æ—¶å€™å¯ä»¥æŸ¥çœ‹ä»£ç†æœåŠ¡å™¨çš„<code>squid</code>æ—¥å¿—ï¼Œå‘ç°æ—¥å¿—ä¸­ä¸€ç›´ä¸æ–­æœ‰æ¥è‡ª<code>kubeadm</code>æ‰€åœ¨çš„æœºå™¨å‘æœ¬æœºçš„<code>6443</code>ç«¯å£å‘é€çš„è¯·æ±‚ï¼Œå´è¢«æ‹’ç»äº†</p>
<pre><code>1581507643.783      0 192.168.0.100 TCP_DENIED/403 3927 CONNECT 192.168.0.8:6443 - HIER_NONE/- text/html
1581507644.283      0 192.168.0.100 TCP_DENIED/403 3927 CONNECT 192.168.0.8:6443 - HIER_NONE/- text/html
1581507644.783      0 192.168.0.100 TCP_DENIED/403 3927 CONNECT 192.168.0.8:6443 - HIER_NONE/- text/html
1581507645.283      0 192.168.0.100 TCP_DENIED/403 3927 CONNECT 192.168.0.8:6443 - HIER_NONE/- text/html
1581507645.783      0 192.168.0.100 TCP_DENIED/403 3927 CONNECT 192.168.0.8:6443 - HIER_NONE/- text/html
1581507646.283      0 192.168.0.100 TCP_DENIED/403 3927 CONNECT 192.168.0.8:6443 - HIER_NONE/- text/html
1581507646.783      0 192.168.0.100 TCP_DENIED/403 3927 CONNECT 192.168.0.8:6443 - HIER_NONE/- text/html
1581507647.283      0 192.168.0.100 TCP_DENIED/403 3927 CONNECT 192.168.0.8:6443 - HIER_NONE/- text/html
</code></pre>
<p>é€šè¿‡è¸©å‘ï¼Œæ­£ç¡®å¯è¡Œçš„é…ç½®æµç¨‹æ˜¯ï¼š</p>
<ul>
<li>ä¿®æ”¹<code>docker</code>ä»£ç†é…ç½®</li>
</ul>
<pre><code># vim /etc/systemd/system/docker.service.d/http-proxy.conf
[Service]
Environment=&quot;HTTP_PROXY=http://squid:123456@192.168.0.200:3128&quot; &quot;NO_PROXY=localhost,127.0.0.1,192.168.0.200,192.168.0.100,192.168.0.101,10.244.0.0/16&quot;
# systemctl daemon-reload
# systemctl restart docker
</code></pre>
<ul>
<li>ä¿®æ”¹å…¨å±€ä»£ç†é…ç½®</li>
</ul>
<pre><code># vim /etc/profile
export http_proxy=&quot;http://squid:123456@192.168.0.200:3128&quot;
export https_proxy=&quot;http://squid:123456@192.168.0.200:3128&quot;
export no_proxy=localhost,127.0.0.1,192.168.0.200,192.168.0.100,192.168.0.101,10.244.0.0/16
# source /etc/profile
</code></pre>
<ul>
<li>å‘½ä»¤è¡Œå£°æ˜</li>
</ul>
<pre><code>export http_proxy=&quot;http://squid:123456@192.168.0.200:3128&quot;
export https_proxy=&quot;http://squid:123456@192.168.0.200:3128&quot;
export no_proxy=localhost,127.0.0.1,192.168.0.200,192.168.0.100,192.168.0.101,10.244.0.0/16
</code></pre>
<p>ç„¶åå†æ¬¡æ‰§è¡Œ<code>kubeadm init</code>åˆå§‹åŒ–é›†ç¾¤å°±æˆåŠŸäº†</p>
<h2 id="5-æ€»ç»“">5ã€æ€»ç»“</h2>
<p>æœ¬æ–‡è®°å½•äº†åœ¨ç‰¹å®šçš„ç½‘ç»œç¯å¢ƒä¸‹å¦‚ä½•é€šè¿‡<code>squid</code>é…ç½®ä»£ç†ï¼Œå®ç°å†…ç½‘æœºå™¨å¸¸ç”¨åŠŸèƒ½ä¸Šç½‘çš„æ–¹æ³•ï¼Œå½“ç„¶ï¼Œè¿™é‡Œæåˆ°çš„<code>yum</code>ï¼Œ<code>wget</code>ï¼Œ<code>docker</code>åŠ<code>k8s</code>é›†ç¾¤å®‰è£…å¸¸ç”¨çš„æ“ä½œä¹‹å¤–è¿˜æœ‰ä¸€äº›ä¹Ÿéœ€è¦é€šè¿‡ä¸Šç½‘ä»£ç†ï¼Œè¿™é‡Œä¸ä¸€ä¸€æåŠã€‚</p>
<p>å¥½å•¦ï¼Œç–«æƒ…æ²¡ç»“æŸï¼Œåªèƒ½åœ¨å®¶ä¸Šç­ç†¬å¤œå¤±çœ ï¼Œæ„¿å¹³å®‰ï¼ğŸ™ğŸ™ğŸ™</p>

            </div>
            
              <div class="tag-container">
                
                  <a href="https://www.ssgeek.com/tag/app" class="tag">
                    å®ç”¨ç¨‹åº
                  </a>
                
                  <a href="https://www.ssgeek.com/tag/linux" class="tag">
                    linux
                  </a>
                
                  <a href="https://www.ssgeek.com/tag/kubernetes" class="tag">
                    kubernetes
                  </a>
                
              </div>
            
            
              <div class="next-post">
                <div class="next">ä¸‹ä¸€ç¯‡</div>
                <a href="https://www.ssgeek.com/post/prometheus-jian-kong-jenkins">
                  <h3 class="post-title">
                    Prometheusç›‘æ§Jenkins
                  </h3>
                </a>
              </div>
            

            
              
                <div id="gitalk-container" data-aos="fade-in"></div>
              

              
            

          </div>

        </div>
      </div>
    </div>

    <script src="https://cdn.bootcdn.net/ajax/libs/aos/2.3.4/aos.js"></script>

<script type="application/javascript">

AOS.init();

hljs.initHighlightingOnLoad()

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>



  
    <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
    <script>

      var gitalk = new Gitalk({
        clientID: '22c870a7f8551b566598',
        clientSecret: '1acfdedd403cdf39c4a6ce932a4a991bb2b32e3a',
        repo: 'hargeek.github.io',
        owner: 'hargeek',
        admin: ['hargeek'],
        id: (location.pathname).substring(0, 49),      // Ensure uniqueness and length less than 50
        distractionFreeMode: false  // Facebook-like distraction free mode
      })

      gitalk.render('gitalk-container')

    </script>
  

  


  </body>
</html>
